# バッチ定義書：Teams連携同期バッチ (BATCH-408)

## 1. 基本情報

| 項目 | 内容 |
|------|------|
| **バッチID** | BATCH-408 |
| **バッチ名** | Teams連携同期バッチ |
| **実行スケジュール** | 日次（06:30） |
| **優先度** | 中 |
| **ステータス** | 未着手 |
| **作成日** | 2025/05/31 |
| **最終更新日** | 2025/05/31 |

## 2. バッチ概要

### 2.1 概要・目的
各テナントのMicrosoft Teamsとの連携情報を同期し、ユーザー・チーム・チャンネル情報を最新状態に保つ。

### 2.2 関連テーブル
- TBL-036_Teams連携設定
- TBL-037_Teamsユーザー情報
- TBL-038_Teamsチーム情報
- TBL-039_Teamsチャンネル情報
- TBL-024_通知チャンネル

### 2.3 関連API
- API-209_Teams連携設定API
- API-210_Teams通知送信API

## 3. 実行仕様

### 3.1 実行スケジュール
| 項目 | 設定値 | 備考 |
|------|--------|------|
| 実行頻度 | 30 6 * * * | cron形式（毎日 06:30） |
| 実行時間 | 06:30 | 朝の業務開始前 |
| タイムアウト | 60分 | 最大実行時間 |
| リトライ回数 | 3回 | 失敗時の再実行 |

### 3.2 実行条件
| 条件 | 内容 | 備考 |
|------|------|------|
| 前提条件 | Microsoft Graph API稼働中 | 外部サービス依存 |
| 実行可能時間 | 06:00-08:00 | 業務開始前の時間帯 |
| 排他制御 | 同一バッチの重複実行禁止 | ロックファイル使用 |

### 3.3 実行パラメータ
| パラメータ名 | データ型 | 必須 | デフォルト値 | 説明 |
|--------------|----------|------|--------------|------|
| tenant_id | string | × | all | 同期対象テナントID |
| sync_users | boolean | × | true | ユーザー情報同期フラグ |
| sync_teams | boolean | × | true | チーム情報同期フラグ |
| sync_channels | boolean | × | true | チャンネル情報同期フラグ |

## 4. 処理仕様

### 4.1 処理フロー
```mermaid
flowchart TD
    A[バッチ開始] --> B[パラメータ検証]
    B --> C[対象テナント取得]
    C --> D[Teams連携設定確認]
    D --> E{連携設定有効?}
    E -->|No| F[次のテナントへ]
    E -->|Yes| G[Microsoft Graph API接続確認]
    G --> H{ユーザー同期?}
    H -->|Yes| I[Teamsユーザー情報取得]
    I --> J[ユーザー情報更新]
    H -->|No| K{チーム同期?}
    J --> K
    K -->|Yes| L[Teamsチーム情報取得]
    L --> M[チーム情報更新]
    K -->|No| N{チャンネル同期?}
    M --> N
    N -->|Yes| O[Teamsチャンネル情報取得]
    O --> P[チャンネル情報更新]
    N -->|No| Q[通知設定更新]
    P --> Q
    Q --> R[同期結果記録]
    R --> S{残りテナントあり?}
    S -->|Yes| F
    S -->|No| T[統計情報更新]
    T --> U[バッチ終了]
    
    G --> V[エラー処理]
    I --> V
    J --> V
    L --> V
    M --> V
    O --> V
    P --> V
    V --> W[エラーログ出力]
    W --> X[アラート送信]
    X --> Y[次のテナントへ]
    Y --> S
```

### 4.2 詳細処理
1. **初期化処理**
   - パラメータ検証
   - 対象テナント一覧取得
   - ログファイル初期化
   - 排他制御ロック取得

2. **Teams連携設定確認**
   - テナント別Teams設定の取得
   - アクセストークンの有効性確認
   - Microsoft Graph API接続テストの実行
   - スコープ権限の確認

3. **ユーザー情報同期**
   - Microsoft Graph Users API呼び出し
   - ユーザー一覧の取得・解析
   - 既存ユーザー情報との差分確認
   - 新規・更新・削除ユーザーの処理

4. **チーム情報同期**
   - Microsoft Graph Teams API呼び出し
   - チーム一覧の取得・解析
   - 既存チーム情報との差分確認
   - 新規・更新・削除チームの処理

5. **チャンネル情報同期**
   - 各チームのチャンネル情報取得
   - チャンネル一覧の取得・解析
   - 既存チャンネル情報との差分確認
   - 新規・更新・削除チャンネルの処理

6. **通知設定更新**
   - 無効になったチャンネルの通知設定無効化
   - 新規チャンネルのデフォルト通知設定作成
   - 権限変更に伴う設定調整

## 5. データ仕様

### 5.1 入力データ
| データ名 | 形式 | 取得元 | 説明 |
|----------|------|--------|------|
| Teams連携設定 | DB | TBL-036_Teams連携設定 | アクセストークン等 |
| 既存ユーザー情報 | DB | TBL-037_Teamsユーザー情報 | 現在のユーザー情報 |
| 既存チーム情報 | DB | TBL-038_Teamsチーム情報 | 現在のチーム情報 |
| 既存チャンネル情報 | DB | TBL-039_Teamsチャンネル情報 | 現在のチャンネル情報 |

### 5.2 出力データ
| データ名 | 形式 | 出力先 | 説明 |
|----------|------|--------|------|
| 更新ユーザー情報 | DB | TBL-037_Teamsユーザー情報 | 同期後のユーザー情報 |
| 更新チーム情報 | DB | TBL-038_Teamsチーム情報 | 同期後のチーム情報 |
| 更新チャンネル情報 | DB | TBL-039_Teamsチャンネル情報 | 同期後のチャンネル情報 |
| 同期履歴 | DB | TBL-040_Teams同期履歴 | 同期実行履歴 |
| 実行ログ | LOG | /logs/batch/ | 実行履歴ログ |

### 5.3 データ量見積もり
| 項目 | 件数 | 備考 |
|------|------|------|
| 対象テナント | 30件 | Teams連携有効テナント |
| ユーザー数/テナント | 200件 | 平均値 |
| チーム数/テナント | 20件 | 平均値 |
| チャンネル数/チーム | 10件 | 平均値 |
| 処理時間 | 45分 | 平均実行時間 |

## 6. エラーハンドリング

### 6.1 エラー分類
| エラー種別 | 対応方法 | 通知要否 | 備考 |
|------------|----------|----------|------|
| Microsoft Graph API エラー | リトライ・継続 | ○ | レート制限・認証エラー |
| 認証エラー | エラー記録・スキップ | ○ | 無効なアクセストークン |
| 権限エラー | エラー記録・スキップ | ○ | 不十分なスコープ権限 |
| データ整合性エラー | エラー記録・継続 | △ | 不正なデータ形式 |

### 6.2 リトライ仕様
| 条件 | リトライ回数 | 間隔 | 備考 |
|------|--------------|------|------|
| Microsoft Graph API レート制限 | 3回 | 120秒 | レート制限解除待ち |
| ネットワークエラー | 5回 | 15秒 | 短間隔リトライ |
| 一時的なAPI障害 | 3回 | 60秒 | 指数バックオフ |

### 6.3 異常終了時の処理
1. 処理中断
2. 部分更新のロールバック
3. エラーログ出力
4. アラート送信
5. 排他制御ロック解除

## 7. 監視・運用

### 7.1 監視項目
| 監視項目 | 閾値 | アラート条件 | 対応方法 |
|----------|------|--------------|----------|
| 実行時間 | 60分 | 超過時 | 処理見直し・並列化 |
| API エラー率 | 15% | 超過時 | Teams設定確認 |
| 同期失敗テナント数 | 3件 | 超過時 | 個別調査・修正 |

### 7.2 ログ出力
| ログ種別 | 出力レベル | 出力内容 | 保存期間 |
|----------|------------|----------|----------|
| 実行ログ | INFO | 処理開始・終了・同期件数 | 3ヶ月 |
| エラーログ | ERROR | エラー詳細・スタックトレース | 1年 |
| 同期ログ | DEBUG | 個別同期処理詳細 | 1週間 |

### 7.3 アラート通知
| 通知条件 | 通知先 | 通知方法 | 備考 |
|----------|--------|----------|------|
| Microsoft Graph API障害 | 運用チーム | メール・Teams | 即座に通知 |
| 大量同期失敗 | 開発チーム | Teams | 業務時間内のみ |
| 認証エラー | システム管理者 | メール | トークン更新要 |

## 8. 非機能要件

### 8.1 パフォーマンス
- 処理時間：60分以内
- メモリ使用量：1GB以内
- CPU使用率：40%以内

### 8.2 可用性
- 成功率：90%以上
- Microsoft Graph API障害時の継続処理
- 部分的な同期失敗の許容

### 8.3 セキュリティ
- アクセストークンの暗号化保存
- API呼び出しの安全な実行
- 同期データの適切な管理

## 9. テスト仕様

### 9.1 単体テスト
| テストケース | 入力条件 | 期待結果 |
|--------------|----------|----------|
| 正常同期 | 有効なTeams設定 | 正常同期・データ更新 |
| 連携設定なし | Teams未連携テナント | 正常終了（処理スキップ） |
| 新規チーム追加 | Teamsに新規チーム | チーム情報追加 |

### 9.2 異常系テスト
| テストケース | 入力条件 | 期待結果 |
|--------------|----------|----------|
| API障害 | Microsoft Graph API停止 | エラー記録・継続処理 |
| 認証失敗 | 無効なアクセストークン | エラー記録・スキップ |
| 権限不足 | 不十分なスコープ権限 | エラー記録・スキップ |

## 10. 実装メモ

### 10.1 技術仕様
- 言語：Node.js
- フレームワーク：なし（Pure Node.js）
- DB接続：Prisma
- Microsoft Graph API：@azure/msal-node
- ログ出力：Winston

### 10.2 注意事項
- Microsoft Graph API のレート制限対応
- 大量データ取得時のページネーション処理
- アクセストークンの安全な管理
- Azure AD認証の適切な実装

### 10.3 デプロイ・実行環境
- 実行サーバー：バッチサーバー
- 実行ユーザー：batch_user
- 実行ディレクトリ：/opt/batch/teams-sync/
- 設定ファイル：/etc/batch/teams-sync.json

---

**改訂履歴**

| バージョン | 日付 | 変更者 | 変更内容 |
|------------|------|--------|----------|
| 1.0 | 2025/05/31 | システムアーキテクト | 初版作成 |
