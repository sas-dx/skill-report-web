# バッチ定義書：データベース監視バッチ (BATCH-502)

## 1. 基本情報

| 項目 | 内容 |
|------|------|
| **バッチID** | BATCH-502 |
| **バッチ名** | データベース監視バッチ |
| **実行スケジュール** | 10分毎 |
| **優先度** | 高 |
| **ステータス** | 未着手 |
| **作成日** | 2025/05/31 |
| **最終更新日** | 2025/05/31 |

## 2. バッチ概要

### 2.1 概要・目的
データベースのパフォーマンス・接続状況・容量使用率を監視し、異常検知時にアラートを送信する。

### 2.2 関連テーブル
- TBL-045_データベース監視履歴
- TBL-046_データベース統計情報
- TBL-047_データベースアラート設定

### 2.3 関連API
- API-301_システム状態取得API
- API-302_監視データ取得API

## 3. 実行仕様

### 3.1 実行スケジュール
| 項目 | 設定値 | 備考 |
|------|--------|------|
| 実行頻度 | */10 * * * * | cron形式（10分毎） |
| 実行時間 | 10分毎 | 高頻度監視 |
| タイムアウト | 5分 | 最大実行時間 |
| リトライ回数 | 2回 | 失敗時の再実行 |

### 3.2 実行条件
| 条件 | 内容 | 備考 |
|------|------|------|
| 前提条件 | データベース稼働中 | 基本的な稼働状態 |
| 実行可能時間 | 24時間 | 常時監視 |
| 排他制御 | 同一バッチの重複実行禁止 | ロックファイル使用 |

### 3.3 実行パラメータ
| パラメータ名 | データ型 | 必須 | デフォルト値 | 説明 |
|--------------|----------|------|--------------|------|
| check_performance | boolean | × | true | パフォーマンス監視フラグ |
| check_connections | boolean | × | true | 接続数監視フラグ |
| check_storage | boolean | × | true | ストレージ監視フラグ |

## 4. 処理仕様

### 4.1 処理フロー
```mermaid
flowchart TD
    A[バッチ開始] --> B[パラメータ検証]
    B --> C[データベース接続確認]
    C --> D{パフォーマンス監視?}
    D -->|Yes| E[クエリ実行時間測定]
    E --> F[スロークエリ検出]
    D -->|No| G{接続数監視?}
    F --> G
    G -->|Yes| H[アクティブ接続数取得]
    H --> I[接続数閾値チェック]
    G -->|No| J{ストレージ監視?}
    I --> J
    J -->|Yes| K[データベース容量取得]
    K --> L[容量使用率計算]
    J -->|No| M[統計情報更新]
    L --> M
    M --> N[異常検知判定]
    N --> O{異常検知?}
    O -->|Yes| P[アラート送信]
    O -->|No| Q[監視履歴記録]
    P --> Q
    Q --> R[バッチ終了]
    
    C --> S[エラー処理]
    E --> S
    H --> S
    K --> S
    S --> T[エラーログ出力]
    T --> U[緊急アラート送信]
    U --> V[異常終了]
```

### 4.2 詳細処理
1. **初期化処理**
   - パラメータ検証
   - データベース接続確認
   - ログファイル初期化
   - 排他制御ロック取得

2. **パフォーマンス監視**
   - テストクエリの実行時間測定
   - スロークエリログの解析
   - インデックス使用状況の確認
   - デッドロック発生状況の確認

3. **接続数監視**
   - アクティブ接続数の取得
   - 最大接続数に対する使用率計算
   - 長時間接続の検出
   - 接続プールの状況確認

4. **ストレージ監視**
   - データベースファイルサイズの取得
   - テーブル別容量使用状況の確認
   - インデックスサイズの確認
   - ログファイル容量の確認

5. **異常検知・アラート**
   - 各監視項目の閾値チェック
   - 異常パターンの検出
   - アラートレベルの判定
   - 通知先の決定・送信

## 5. データ仕様

### 5.1 入力データ
| データ名 | 形式 | 取得元 | 説明 |
|----------|------|--------|------|
| データベース統計 | DB | INFORMATION_SCHEMA | システム統計情報 |
| アラート設定 | DB | TBL-047_データベースアラート設定 | 監視閾値設定 |
| 過去の監視履歴 | DB | TBL-045_データベース監視履歴 | 傾向分析用データ |

### 5.2 出力データ
| データ名 | 形式 | 出力先 | 説明 |
|----------|------|--------|------|
| 監視履歴 | DB | TBL-045_データベース監視履歴 | 監視結果の記録 |
| 統計情報 | DB | TBL-046_データベース統計情報 | 集計済み統計データ |
| アラートログ | LOG | /logs/alerts/ | アラート送信履歴 |
| 実行ログ | LOG | /logs/batch/ | 実行履歴ログ |

### 5.3 データ量見積もり
| 項目 | 件数 | 備考 |
|------|------|------|
| 監視項目数 | 20項目 | パフォーマンス・接続・容量 |
| 履歴保存期間 | 30日 | 詳細履歴 |
| 処理時間 | 2分 | 平均実行時間 |

## 6. エラーハンドリング

### 6.1 エラー分類
| エラー種別 | 対応方法 | 通知要否 | 備考 |
|------------|----------|----------|------|
| DB接続エラー | 緊急アラート・リトライ | ○ | 最高優先度 |
| クエリタイムアウト | エラー記録・継続 | ○ | パフォーマンス劣化 |
| 権限エラー | エラー記録・継続 | △ | 設定確認要 |

### 6.2 リトライ仕様
| 条件 | リトライ回数 | 間隔 | 備考 |
|------|--------------|------|------|
| DB接続エラー | 3回 | 30秒 | 短間隔リトライ |
| クエリタイムアウト | 2回 | 60秒 | 負荷軽減待ち |
| 一時的なロックエラー | 5回 | 10秒 | 短間隔リトライ |

### 6.3 異常終了時の処理
1. 処理中断
2. エラーログ出力
3. 緊急アラート送信
4. 排他制御ロック解除

## 7. 監視・運用

### 7.1 監視項目
| 監視項目 | 閾値 | アラート条件 | 対応方法 |
|----------|------|--------------|----------|
| クエリ実行時間 | 5秒 | 超過時 | クエリ最適化 |
| 接続数使用率 | 80% | 超過時 | 接続プール調整 |
| ストレージ使用率 | 85% | 超過時 | 容量拡張・データ削除 |
| デッドロック発生数 | 5回/10分 | 超過時 | アプリケーション調査 |

### 7.2 ログ出力
| ログ種別 | 出力レベル | 出力内容 | 保存期間 |
|----------|------------|----------|----------|
| 実行ログ | INFO | 処理開始・終了・監視結果 | 1ヶ月 |
| エラーログ | ERROR | エラー詳細・スタックトレース | 3ヶ月 |
| アラートログ | WARN | アラート詳細・閾値情報 | 3ヶ月 |

### 7.3 アラート通知
| 通知条件 | 通知先 | 通知方法 | 備考 |
|----------|--------|----------|------|
| DB接続不可 | 運用チーム | メール・Slack・電話 | 緊急対応 |
| パフォーマンス劣化 | 開発チーム | Slack | 業務時間内のみ |
| 容量不足警告 | インフラチーム | メール | 計画的対応 |

## 8. 非機能要件

### 8.1 パフォーマンス
- 処理時間：5分以内
- メモリ使用量：256MB以内
- CPU使用率：10%以内

### 8.2 可用性
- 成功率：99.9%以上
- DB障害時の適切なエラー処理
- 監視継続性の確保

### 8.3 セキュリティ
- 監視用権限の最小化
- 機密情報の適切な取り扱い
- アクセスログの記録

## 9. テスト仕様

### 9.1 単体テスト
| テストケース | 入力条件 | 期待結果 |
|--------------|----------|----------|
| 正常監視 | DB正常稼働 | 正常終了・履歴記録 |
| 高負荷検知 | 高CPU使用率 | アラート送信 |
| 容量不足検知 | 高ストレージ使用率 | 警告アラート送信 |

### 9.2 異常系テスト
| テストケース | 入力条件 | 期待結果 |
|--------------|----------|----------|
| DB接続不可 | DB停止状態 | 緊急アラート送信 |
| クエリタイムアウト | 重いクエリ実行 | エラー記録・継続処理 |
| 権限不足 | 不十分な権限 | エラー記録・スキップ |

## 10. 実装メモ

### 10.1 技術仕様
- 言語：Node.js
- フレームワーク：なし（Pure Node.js）
- DB接続：Prisma
- 監視ライブラリ：node-postgres（統計取得用）
- ログ出力：Winston

### 10.2 注意事項
- 監視クエリの軽量化
- 高頻度実行による負荷軽減
- アラート送信の重複防止

### 10.3 デプロイ・実行環境
- 実行サーバー：監視サーバー
- 実行ユーザー：monitor_user
- 実行ディレクトリ：/opt/batch/db-monitor/
- 設定ファイル：/etc/batch/db-monitor.json

---

**改訂履歴**

| バージョン | 日付 | 変更者 | 変更内容 |
|------------|------|--------|----------|
| 1.0 | 2025/05/31 | システムアーキテクト | 初版作成 |
