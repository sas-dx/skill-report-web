datetime updated_at "更新日時"
        varchar(50) updated_by "更新者"
    }
    
    TRN_SkillEvidence {
        varchar(50) id PK "証跡ID"
        varchar(50) tenant_id FK "テナントID"
        varchar(50) employee_id FK "社員ID"
        varchar(50) skill_id FK "スキルID"
        varchar(100) evidence_type "証跡種別"
        varchar(200) evidence_title "証跡タイトル"
        text description "説明"
        varchar(500) file_path "ファイルパス"
        date evidence_date "証跡日"
        datetime created_at "作成日時"
        datetime updated_at "更新日時"
    }
    
    %% 関連
    MST_Employee ||--o{ MST_CareerPlan : "sets"
    MST_CareerPlan ||--o{ TRN_GoalProgress : "progresses"
    MST_Employee ||--o{ TRN_GoalProgress : "tracks"
    MST_Employee ||--o{ TRN_ProjectRecord : "works_on"
    MST_Employee ||--o{ TRN_SkillEvidence : "provides"
    MST_Skill ||--o{ TRN_SkillEvidence : "evidenced_by"
```

### 3.6 通知・連携管理 + システム系

```mermaid
erDiagram
    MST_Tenant {
        varchar(50) id PK "テナントID"
        varchar(100) tenant_name "テナント名"
    }
    
    MST_NotificationSettings {
        varchar(50) id PK "通知設定ID"
        varchar(50) tenant_id FK "テナントID"
        varchar(100) setting_name "設定名"
        varchar(100) notification_type "通知種別"
        varchar(200) trigger_event "トリガーイベント"
        boolean is_enabled "有効フラグ"
        text recipient_rules "受信者ルール"
        text content_template "コンテンツテンプレート"
        datetime created_at "作成日時"
        datetime updated_at "更新日時"
    }
    
    MST_NotificationTemplate {
        varchar(50) id PK "テンプレートID"
        varchar(50) tenant_id FK "テナントID"
        varchar(100) template_name "テンプレート名"
        varchar(100) notification_type "通知種別"
        varchar(500) subject_template "件名テンプレート"
        text body_template "本文テンプレート"
        text variables "変数"
        boolean is_active "有効フラグ"
        datetime created_at "作成日時"
        datetime updated_at "更新日時"
    }
    
    TRN_Notification {
        varchar(50) id PK "通知ID"
        varchar(50) tenant_id FK "テナントID"
        varchar(50) user_id FK "ユーザーID"
        varchar(50) notification_type "通知種別"
        varchar(500) title "タイトル"
        text content "内容"
        varchar(50) status "ステータス"
        datetime sent_at "送信日時"
        datetime read_at "既読日時"
        datetime created_at "作成日時"
    }
    
    SYS_SkillIndex {
        varchar(50) id PK "インデックスID"
        varchar(50) tenant_id FK "テナントID"
        varchar(50) skill_id FK "スキルID"
        varchar(50) employee_id FK "社員ID"
        text search_keywords "検索キーワード"
        decimal skill_score "スキルスコア"
        datetime last_updated "最終更新日時"
    }
    
    SYS_SkillMatrix {
        varchar(50) id PK "マトリックスID"
        varchar(50) tenant_id FK "テナントID"
        varchar(50) employee_id FK "社員ID"
        varchar(50) skill_id FK "スキルID"
        varchar(50) department_id FK "部署ID"
        int required_level "必要レベル"
        int current_avg_level "現在平均レベル"
        int employee_count "社員数"
        decimal coverage_rate "カバー率"
        datetime calculated_at "計算日時"
    }
    
    SYS_TokenStore {
        varchar(50) id PK "トークンID"
        varchar(50) tenant_id FK "テナントID"
        varchar(50) user_id FK "ユーザーID"
        varchar(50) token_type "トークン種別"
        text token_value "トークン値"
        datetime expires_at "有効期限"
        boolean is_revoked "無効化フラグ"
        datetime created_at "作成日時"
    }
    
    %% 関連
    MST_Tenant ||--o{ MST_NotificationSettings : "configures"
    MST_Tenant ||--o{ MST_NotificationTemplate : "defines"
    MST_Tenant ||--o{ TRN_Notification : "sends"
    MST_NotificationTemplate ||--o{ TRN_Notification : "uses"
    MST_UserAuth ||--o{ TRN_Notification : "receives"
    MST_UserAuth ||--o{ SYS_TokenStore : "owns"
    MST_Skill ||--o{ SYS_SkillIndex : "indexed_by"
    MST_Employee ||--o{ SYS_SkillIndex : "indexed_for"
    MST_Employee ||--o{ SYS_SkillMatrix : "analyzed_for"
    MST_Skill ||--o{ SYS_SkillMatrix : "measured_in"
    MST_Department ||--o{ SYS_SkillMatrix : "analyzed_by"
```

### 3.7 システム管理 + 履歴系 + ワーク系

```mermaid
erDiagram
    MST_Tenant {
        varchar(50) id PK "テナントID"
        varchar(100) tenant_name "テナント名"
    }
    
    MST_SystemConfig {
        varchar(50) id PK "設定ID"
        varchar(50) tenant_id FK "テナントID"
        varchar(100) config_key "設定キー"
        text config_value "設定値"
        varchar(50) data_type "データ型"
        boolean is_encrypted "暗号化フラグ"
        text description "説明"
        datetime created_at "作成日時"
        datetime updated_at "更新日時"
    }
    
    MST_ReportTemplate {
        varchar(50) id PK "テンプレートID"
        varchar(50) tenant_id FK "テナントID"
        varchar(100) template_name "テンプレート名"
        varchar(100) report_type "帳票種別"
        text template_content "テンプレート内容"
        text parameters "パラメータ"
        boolean is_active "有効フラグ"
        datetime created_at "作成日時"
        datetime updated_at "更新日時"
    }
    
    SYS_SystemLog {
        varchar(50) id PK "ログID"
        varchar(50) tenant_id FK "テナントID"
        varchar(20) log_level "ログレベル"
        varchar(100) component "コンポーネント"
        text message "メッセージ"
        text stack_trace "スタックトレース"
        varchar(50) user_id FK "ユーザーID"
        varchar(100) session_id "セッションID"
        datetime created_at "作成日時"
    }
    
    SYS_BackupHistory {
        varchar(50) id PK "バックアップID"
        varchar(50) tenant_id FK "テナントID"
        date backup_date "バックアップ日時"
        varchar(100) backup_type "バックアップ種別"
        varchar(500) file_path "ファイルパス"
        decimal file_size_mb "ファイルサイズ（MB）"
        varchar(50) status "ステータス"
        datetime start_time "開始時刻"
        datetime end_time "終了時刻"
        text error_message "エラーメッセージ"
        datetime created_at "作成日時"
    }
    
    SYS_MasterData {
        varchar(50) id PK "データID"
        varchar(50) tenant_id FK "テナントID"
        varchar(50) data_type "データ種別"
        varchar(100) data_key "データキー"
        text data_value "データ値"
        text description "説明"
        int sort_order "表示順"
        boolean is_active "有効フラグ"
        datetime created_at "作成日時"
        datetime updated_at "更新日時"
    }
    
    SYS_TenantUsage {
        varchar(50) id PK "使用量ID"
        varchar(50) tenant_id FK "テナントID"
        date usage_date "使用日"
        int active_users "アクティブユーザー数"
        decimal storage_used_gb "使用ストレージ（GB）"
        int api_calls "API呼び出し数"
        int reports_generated "生成レポート数"
        datetime calculated_at "計算日時"
    }
    
    SYS_IntegrationConfig {
        varchar(50) id PK "連携設定ID"
        varchar(50) tenant_id FK "テナントID"
        varchar(50) integration_type "連携種別"
        varchar(100) provider "プロバイダー"
        text configuration "設定"
        text encrypted_credentials "暗号化認証情報"
        boolean is_enabled "有効フラグ"
        datetime last_tested_at "最終テスト日時"
        datetime created_at "作成日時"
        datetime updated_at "更新日時"
    }
    
    HIS_AuditLog {
        varchar(50) id PK "ログID"
        varchar(50) tenant_id FK "テナントID"
        varchar(50) user_id FK "ユーザーID"
        varchar(50) action_type "アクション種別"
        varchar(100) resource_type "リソース種別"
        varchar(50) resource_id "リソースID"
        text old_values "変更前値"
        text new_values "変更後値"
        varchar(45) ip_address "IPアドレス"
        text user_agent "ユーザーエージェント"
        datetime created_at "作成日時"
    }
    
    HIS_NotificationLog {
        varchar(50) id PK "通知ログID"
        varchar(50) tenant_id FK "テナントID"
        varchar(50) notification_id FK "通知ID"
        varchar(100) notification_type "通知種別"
        varchar(500) recipient "受信者"
        varchar(500) subject "件名"
        text content "内容"
        varchar(50) status "ステータス"
        text error_message "エラーメッセージ"
        int retry_count "リトライ回数"
        datetime sent_at "送信日時"
        datetime created_at "作成日時"
    }
    
    HIS_TenantBilling {
        varchar(50) id PK "課金履歴ID"
        varchar(50) tenant_id FK "テナントID"
        date billing_date "課金日"
        varchar(50) billing_period "課金期間"
        decimal base_amount "基本料金"
        decimal usage_amount "使用料金"
        decimal total_amount "合計金額"
        varchar(10) currency "通貨"
        varchar(50) status "ステータス"
        datetime generated_at "生成日時"
        datetime paid_at "支払日時"
    }
    
    WRK_BatchJobLog {
        varchar(50) id PK "ジョブログID"
        varchar(50) tenant_id FK "テナントID"
        varchar(100) job_name "ジョブ名"
        varchar(100) job_type "ジョブ種別"
        varchar(50) status "ステータス"
        datetime start_time "開始時刻"
        datetime end_time "終了時刻"
        int processed_count "処理件数"
        int success_count "成功件数"
        int error_count "エラー件数"
        text error_details "エラー詳細"
        datetime created_at "作成日時"
    }
    
    %% 関連
    MST_Tenant ||--o{ MST_SystemConfig : "configures"
    MST_Tenant ||--o{ MST_ReportTemplate : "defines"
    MST_Tenant ||--o{ SYS_SystemLog : "logs"
    MST_Tenant ||--o{ SYS_BackupHistory : "backs_up"
    MST_Tenant ||--o{ SYS_MasterData : "manages"
    MST_Tenant ||--o{ SYS_TenantUsage : "tracks"
    MST_Tenant ||--o{ SYS_IntegrationConfig : "integrates"
    MST_Tenant ||--o{ HIS_AuditLog : "audits"
    MST_Tenant ||--o{ HIS_NotificationLog : "logs"
    MST_Tenant ||--o{ HIS_TenantBilling : "bills"
    MST_Tenant ||--o{ WRK_BatchJobLog : "processes"
    MST_UserAuth ||--o{ SYS_SystemLog : "generates"
    MST_UserAuth ||--o{ HIS_AuditLog : "performs"
    TRN_Notification ||--o{ HIS_NotificationLog : "logged_by"
```

---

## 4. 主要エンティティ中心の関連図

### 4.1 MST_Employee中心の関連図

```mermaid
erDiagram
    MST_Employee {
        varchar(50) id PK
        varchar(50) tenant_id FK
        varchar(30) employee_code
        varchar(100) full_name
        varchar(255) email
        varchar(50) department_id FK
        varchar(50) position_id FK
        varchar(50) job_type_id FK
        varchar(50) manager_id FK
    }
    
    MST_UserAuth {
        varchar(50) id PK
        varchar(50) tenant_id FK
        varchar(100) username
        varchar(255) email
    }
    
    MST_Department {
        varchar(50) id PK
        varchar(50) tenant_id FK
        varchar(100) department_name
    }
    
    MST_Position {
        varchar(50) id PK
        varchar(50) tenant_id FK
        varchar(100) position_name
    }
    
    MST_JobType {
        varchar(50) id PK
        varchar(50) tenant_id FK
        varchar(100) job_type_name
    }
    
    TRN_SkillRecord {
        varchar(50) id PK
        varchar(50) tenant_id FK
        varchar(50) employee_id FK
        varchar(50) skill_item_id FK
        int skill_level
    }
    
    TRN_EmployeeSkillGrade {
        varchar(50) id PK
        varchar(50) tenant_id FK
        varchar(50) employee_id FK
        varchar(50) skill_id FK
        varchar(50) grade_id FK
    }
    
    TRN_TrainingHistory {
        varchar(50) id PK
        varchar(50) tenant_id FK
        varchar(50) employee_id FK
        varchar(50) training_program_id FK
    }
    
    TRN_PDU {
        varchar(50) pdu_id PK
        varchar(50) tenant_id FK
        varchar(50) employee_id FK
        varchar(50) certification_id FK
        decimal(5,1) pdu_points
    }
    
    TRN_ProjectRecord {
        varchar(50) id PK
        varchar(50) tenant_id FK
        varchar(50) employee_id FK
        varchar(200) project_name
    }
    
    MST_CareerPlan {
        varchar(50) id PK
        varchar(50) tenant_id FK
        varchar(50) employee_id FK
        varchar(100) plan_name
    }
    
    %% 関連
    MST_UserAuth ||--|| MST_Employee : "authenticates"
    MST_Employee ||--o{ MST_Department : "belongs_to"
    MST_Employee ||--o{ MST_Position : "holds"
    MST_Employee ||--o{ MST_JobType : "works_as"
    MST_Employee ||--o{ MST_Employee : "manages"
    MST_Employee ||--o{ TRN_SkillRecord : "has"
    MST_Employee ||--o{ TRN_EmployeeSkillGrade : "assessed"
    MST_Employee ||--o{ TRN_TrainingHistory : "attends"
    MST_Employee ||--o{ TRN_PDU : "earns"
    MST_Employee ||--o{ TRN_ProjectRecord : "works_on"
    MST_Employee ||--o{ MST_CareerPlan : "sets"
```

### 4.2 TRN_SkillRecord中心の関連図

```mermaid
erDiagram
    TRN_SkillRecord {
        varchar(50) id PK
        varchar(50) tenant_id FK
        varchar(50) employee_id FK
        varchar(50) skill_item_id FK
        bigint skill_category_id FK
        int skill_level
    }
    
    MST_Employee {
        varchar(50) id PK
        varchar(50) tenant_id FK
        varchar(100) full_name
    }
    
    MST_SkillItem {
        varchar(50) id PK
        varchar(50) tenant_id FK
        varchar(50) skill_id FK
        varchar(100) item_name
    }
    
    MST_SkillCategory {
        bigint id PK
        varchar(50) tenant_id FK
        varchar(100) category_name
    }
    
    MST_Skill {
        varchar(50) id PK
        varchar(50) tenant_id FK
        varchar(100) skill_name
        bigint category_id FK
    }
    
    TRN_EmployeeSkillGrade {
        varchar(50) id PK
        varchar(50) tenant_id FK
        varchar(50) employee_id FK
        varchar(50) skill_id FK
        varchar(50) grade_id FK
    }
    
    TRN_SkillEvidence {
        varchar(50) id PK
        varchar(50) tenant_id FK
        varchar(50) employee_id FK
        varchar(50) skill_id FK
    }
    
    SYS_SkillIndex {
        varchar(50) id PK
        varchar(50) tenant_id FK
        varchar(50) skill_id FK
        varchar(50) employee_id FK
    }
    
    %% 関連
    MST_Employee ||--o{ TRN_SkillRecord : "has"
    MST_SkillItem ||--o{ TRN_SkillRecord : "recorded_in"
    MST_SkillCategory ||--o{ TRN_SkillRecord : "categorizes"
    MST_Skill ||--o{ MST_SkillItem : "contains"
    MST_SkillCategory ||--o{ MST_Skill : "categorizes"
    MST_Employee ||--o{ TRN_EmployeeSkillGrade : "assessed"
    MST_Skill ||--o{ TRN_EmployeeSkillGrade : "measures"
    MST_Employee ||--o{ TRN_SkillEvidence : "provides"
    MST_Skill ||--o{ TRN_SkillEvidence : "evidenced_by"
    MST_Skill ||--o{ SYS_SkillIndex : "indexed_by"
    MST_Employee ||--o{ SYS_SkillIndex : "indexed_for"
```

---

## 5. マルチテナント制約・設計指針

### 5.1 テナント分離制約

```sql
-- 全テーブルにテナント分離制約を追加
-- 例: MST_UserAuth
ALTER TABLE MST_UserAuth 
ADD CONSTRAINT chk_tenant_isolation 
CHECK (tenant_id IS NOT NULL);

-- 複合インデックス（tenant_id + 主要検索キー）
CREATE INDEX idx_userauth_tenant_email 
ON MST_UserAuth (tenant_id, email);

CREATE INDEX idx_skillrecord_tenant_employee 
ON TRN_SkillRecord (tenant_id, employee_id);

CREATE INDEX idx_auditlog_tenant_user_date 
ON HIS_AuditLog (tenant_id, user_id, created_at);
```

### 5.2 参照整合性制約（テナント内）

```sql
-- テナント内参照整合性制約の例
-- MST_UserRole: 同一テナント内でのみ参照可能
ALTER TABLE MST_UserRole 
ADD CONSTRAINT fk_userrole_tenant_user 
FOREIGN KEY (tenant_id, user_id) 
REFERENCES MST_UserAuth (tenant_id, id);

ALTER TABLE MST_UserRole 
ADD CONSTRAINT fk_userrole_tenant_role 
FOREIGN KEY (tenant_id, role_id) 
REFERENCES MST_Role (tenant_id, id);

-- TRN_SkillRecord: 同一テナント内でのみ参照可能
ALTER TABLE TRN_SkillRecord 
ADD CONSTRAINT fk_skillrecord_tenant_employee 
FOREIGN KEY (tenant_id, employee_id) 
REFERENCES MST_Employee (tenant_id, id);

ALTER TABLE TRN_SkillRecord 
ADD CONSTRAINT fk_skillrecord_tenant_skillitem 
FOREIGN KEY (tenant_id, skill_item_id) 
REFERENCES MST_SkillItem (tenant_id, id);
```

### 5.3 パフォーマンス最適化インデックス

```sql
-- スキル関連の複合インデックス
CREATE INDEX idx_empskillgrade_tenant_emp_skill 
ON TRN_EmployeeSkillGrade (tenant_id, employee_id, skill_id);

CREATE INDEX idx_skillmatrix_tenant_dept_skill 
ON SYS_SkillMatrix (tenant_id, department_id, skill_id);

-- 検索・分析用インデックス
CREATE INDEX idx_skillrecord_tenant_category_level 
ON TRN_SkillRecord (tenant_id, skill_category_id, skill_level);

CREATE INDEX idx_traininghistory_tenant_emp_date 
ON TRN_TrainingHistory (tenant_id, employee_id, start_date);

-- 監査・ログ用インデックス
CREATE INDEX idx_auditlog_tenant_resource_date 
ON HIS_AuditLog (tenant_id, resource_type, created_at);

CREATE INDEX idx_systemlog_tenant_level_date 
ON SYS_SystemLog (tenant_id, log_level, created_at);
```

---

## 6. 関連エンティティ抽出ルール

### 6.1 デフォルト設定
- **関連深度**: 2階層
- **最大エンティティ数**: 8テーブル
- **優先順位**: 外部キー関係 > 業務関連性 > 使用頻度

### 6.2 テーブル別カスタム設定

#### MST_Employee中心
- **深度**: 2階層
- **最大エンティティ数**: 10テーブル
- **優先関連**:
  1. MST_UserAuth（認証情報）
  2. MST_Department（部署情報）
  3. MST_Position（役職情報）
  4. MST_JobType（職種情報）
  5. TRN_SkillRecord（スキル記録）
  6. TRN_EmployeeSkillGrade（スキルグレード）

#### TRN_SkillRecord中心
- **深度**: 2階層
- **最大エンティティ数**: 8テーブル
- **優先関連**:
  1. MST_Employee（社員情報）
  2. MST_SkillItem（スキル項目）
  3. MST_SkillCategory（スキルカテゴリ）
  4. TRN_EmployeeSkillGrade（スキルグレード）

#### MST_Skill中心
- **深度**: 2階層
- **最大エンティティ数**: 8テーブル
- **優先関連**:
  1. MST_SkillCategory（スキルカテゴリ）
  2. MST_SkillItem（スキル項目）
  3. TRN_SkillRecord（スキル記録）
  4. TRN_EmployeeSkillGrade（スキルグレード）
  5. SYS_SkillIndex（検索インデックス）
  6. SYS_SkillMatrix（スキルマップ）

#### TRN_PDU中心
- **深度**: 2階層
- **最大エンティティ数**: 8テーブル
- **優先関連**:
  1. MST_Employee（社員情報）
  2. MST_Certification（資格情報）
  3. TRN_TrainingHistory（研修履歴）
  4. TRN_ProjectRecord（案件実績）

---

## 7. 設計原則・ガイドライン

### 7.1 マルチテナント設計原則
1. **完全分離**: 全テーブルにtenant_idを必須とする
2. **参照整合性**: テナント内でのみ外部キー制約を適用
3. **パフォーマンス**: tenant_idを含む複合インデックスを必須とする
4. **セキュリティ**: テナント間のデータ漏洩を防ぐ制約を実装

### 7.2 拡張性設計
1. **階層構造**: カテゴリ・スキル・項目の3階層構造で柔軟性を確保
2. **グレード管理**: スキルレベルとグレードの分離で詳細評価を実現
3. **証跡管理**: スキル証跡テーブルで根拠の明確化
4. **監査機能**: 全操作の追跡・監査機能を標準装備

### 7.3 パフォーマンス設計
1. **インデックス戦略**: tenant_id + 検索キーの複合インデックス
2. **分析テーブル**: SYS_SkillMatrix等で集計済みデータを管理
3. **検索最適化**: SYS_SkillIndexで全文検索を高速化
4. **履歴分離**: 履歴系テーブルで運用データと分析データを分離

---

## 8. 運用・保守指針

### 8.1 データ整合性チェック
- テナント分離制約の定期チェック
- 参照整合性の定期検証
- スキルグレード要件の整合性確認

### 8.2 パフォーマンス監視
- インデックス使用状況の監視
- クエリパフォーマンスの定期測定
- テナント別使用量の監視

### 8.3 セキュリティ管理
- テナント間データ分離の検証
- アクセス権限の定期監査
- 監査ログの定期分析

---

## 9. まとめ

本エンティティ関連図は、entity_relationships.yaml v2.0.0を基に作成された、マルチテナント対応スキル管理システムの完全なデータベース設計図です。

### 主要特徴
- **48テーブル**の包括的な設計
- **マルチテナント完全分離**アーキテクチャ
- **スキル管理の3階層構造**（カテゴリ・スキル・項目）
- **詳細なグレード管理**システム
- **包括的な監査・履歴機能**

### 設計の利点
1. **拡張性**: 新しいテナントや機能の容易な追加
2. **セキュリティ**: 完全なテナント分離によるデータ保護
3. **パフォーマンス**: 最適化されたインデックス戦略
4. **保守性**: 明確な関連定義と制約設計

この設計により、企業グループ全体のスキル管理を効率的かつ安全に実現できます。
