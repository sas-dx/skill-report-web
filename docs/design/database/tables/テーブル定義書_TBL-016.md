# テーブル定義書：一括登録ジョブログ (TBL-016)

| 項目                | 内容                                                                                |
|---------------------|------------------------------------------------------------------------------------|
| **テーブルID**      | TBL-016                                                                             |
| **テーブル名**      | WRK_BatchJobLog                                                                     |
| **論理名**          | 一括登録ジョブログ                                                                  |
| **カテゴリ**        | ワーク系                                                                            |
| **主な利用機能カテゴリ** | 作業実績管理                                                                    |
| **主な利用API ID**  | API-015                                                                             |
| **主な利用バッチID**| BATCH-010                                                                           |
| **優先度**          | 低                                                                                  |
| **備考**            | SCR-WORK-BULK画面で利用                                                             |

## 1. テーブル概要

一括登録ジョブログテーブル（WRK_BatchJobLog）は、案件実績やスキル情報などの一括登録処理の実行状況と結果を管理するワークテーブルです。ファイルアップロード情報、処理ステータス、エラー内容、処理件数などを記録し、一括登録処理の追跡と監査を可能にします。このテーブルにより、大量データの一括登録処理の透明性と信頼性を確保します。

## 2. カラム定義

| No | 論理名           | 物理名         | データ型    | 桁数 | 必須 | 主キー | 外部キー | デフォルト値 | 説明                                           |
|----|------------------|----------------|-------------|------|------|--------|----------|--------------|------------------------------------------------|
| 1  | ジョブID         | job_id         | VARCHAR     | 50   | ○    | ○      |          |              | ジョブを一意に識別するID                       |
| 2  | ジョブ種別       | job_type       | VARCHAR     | 50   | ○    |        |          |              | ジョブの種別（案件一括登録/スキル一括登録等）  |
| 3  | 実行者ID         | executor_id    | VARCHAR     | 50   | ○    |        | MST_UserAuth.user_id |  | ジョブ実行者のユーザーID                       |
| 4  | 開始日時         | start_time     | TIMESTAMP   |      | ○    |        |          |              | ジョブ開始日時                                 |
| 5  | 終了日時         | end_time       | TIMESTAMP   |      |      |        |          | NULL         | ジョブ終了日時                                 |
| 6  | ステータス       | status         | VARCHAR     | 20   | ○    |        |          | '待機中'     | 処理ステータス（待機中/実行中/完了/エラー）    |
| 7  | 処理件数         | processed_count | INTEGER    | 10   |      |        |          | 0            | 処理された総レコード数                         |
| 8  | 成功件数         | success_count  | INTEGER     | 10   |      |        |          | 0            | 正常に処理されたレコード数                     |
| 9  | エラー件数       | error_count    | INTEGER     | 10   |      |        |          | 0            | エラーが発生したレコード数                     |
| 10 | 入力ファイル名   | input_filename | VARCHAR     | 255  | ○    |        |          |              | アップロードされたファイル名                   |
| 11 | 入力ファイルパス | input_filepath | VARCHAR     | 500  | ○    |        |          |              | アップロードされたファイルの保存パス           |
| 12 | 出力ファイル名   | output_filename | VARCHAR    | 255  |      |        |          | NULL         | 結果出力ファイル名                             |
| 13 | 出力ファイルパス | output_filepath | VARCHAR    | 500  |      |        |          | NULL         | 結果出力ファイルの保存パス                     |
| 14 | エラーファイル名 | error_filename | VARCHAR     | 255  |      |        |          | NULL         | エラー出力ファイル名                           |
| 15 | エラーファイルパス | error_filepath | VARCHAR   | 500  |      |        |          | NULL         | エラー出力ファイルの保存パス                   |
| 16 | エラーメッセージ | error_message  | TEXT        |      |      |        |          | NULL         | エラー発生時のメッセージ                       |
| 17 | 処理オプション   | process_options | TEXT       |      |      |        |          | NULL         | 処理実行時のオプション（JSON形式）             |
| 18 | 対象テーブル     | target_table   | VARCHAR     | 100  |      |        |          | NULL         | 処理対象のテーブル名                           |
| 19 | 備考             | remarks        | TEXT        |      |      |        |          | NULL         | 備考欄                                         |
| 20 | 作成日時         | created_at     | TIMESTAMP   |      | ○    |        |          | CURRENT_TIMESTAMP | レコード作成日時                           |
| 21 | 更新日時         | updated_at     | TIMESTAMP   |      | ○    |        |          | CURRENT_TIMESTAMP | レコード更新日時                           |

## 3. インデックス定義

| インデックス名            | カラム                | 種類      | 説明                                           |
|---------------------------|------------------------|-----------|------------------------------------------------|
| PK_WRK_BatchJobLog       | job_id                 | PRIMARY   | 主キーインデックス                             |
| IDX_WRK_BatchJobLog_type | job_type               | NORMAL    | ジョブ種別による検索を高速化                   |
| IDX_WRK_BatchJobLog_executor | executor_id        | NORMAL    | 実行者による検索を高速化                       |
| IDX_WRK_BatchJobLog_time | start_time             | NORMAL    | 開始日時による検索を高速化                     |
| IDX_WRK_BatchJobLog_status | status               | NORMAL    | ステータスによる検索を高速化                   |
| IDX_WRK_BatchJobLog_table | target_table          | NORMAL    | 対象テーブルによる検索を高速化                 |

## 4. 制約条件

| 制約名                    | 種類      | カラム                | 内容                                           |
|---------------------------|-----------|------------------------|------------------------------------------------|
| PK_WRK_BatchJobLog       | PRIMARY KEY | job_id               | 主キー制約                                     |
| FK_WRK_BatchJobLog_executor | FOREIGN KEY | executor_id       | 実行者への参照整合性を保証する制約             |
| CK_WRK_BatchJobLog_status | CHECK    | status                 | '待機中'、'実行中'、'完了'、'エラー'のいずれかのみ許可 |
| CK_WRK_BatchJobLog_counts | CHECK    | processed_count, success_count, error_count | 0以上の値のみ許可        |

## 5. 外部キー制約

| 制約名                    | 参照先テーブル | 参照先カラム | 参照元カラム | ON UPDATE | ON DELETE | 説明                                           |
|---------------------------|----------------|--------------|--------------|-----------|-----------|------------------------------------------------|
| FK_WRK_BatchJobLog_executor | MST_UserAuth | user_id      | executor_id  | CASCADE   | RESTRICT  | 実行者への参照                                 |

## 6. 関連テーブル

| テーブル名      | 関連カラム | 関連の種類 | 関連の説明                                     |
|-----------------|------------|------------|------------------------------------------------|
| MST_UserAuth    | user_id    | N:1        | ジョブ実行者のユーザー                         |
| TRN_ProjectRecord | project_id | 1:N      | 一括登録された案件情報                         |
| TRN_SkillRecord | skill_record_id | 1:N   | 一括登録されたスキル情報                       |

## 7. データ操作イベント

| イベント         | 処理内容                                                                           |
|------------------|------------------------------------------------------------------------------------|
| INSERT           | created_at, updated_atに現在時刻を設定                                             |
| UPDATE           | updated_atを現在時刻で更新                                                         |
| DELETE           | 物理削除可（ログデータのため）                                                     |
| ジョブ開始時     | status='実行中'に更新                                                              |
| ジョブ完了時     | status='完了'、end_timeに現在時刻を設定、各種カウント値を更新                     |
| エラー発生時     | status='エラー'、end_timeに現在時刻を設定、error_messageにエラー内容を記録        |
| ログ自動削除     | BATCH-010により一定期間経過したログを自動削除                                      |

## 8. 特記事項

1. このテーブルは一括登録処理の監査証跡として機能
2. 処理結果ファイル（正常処理結果、エラー結果）へのパスを保持し、後から参照可能
3. 処理オプションはJSON形式で保存し、柔軟な設定を可能に
4. ジョブの進捗状況をリアルタイムで追跡可能
5. エラー発生時は詳細なエラーメッセージを記録し、トラブルシューティングを支援
6. 一定期間（デフォルト3ヶ月）経過したログデータは自動削除
7. ファイルパスは相対パスで保存し、環境間の移行を容易に
8. 処理件数、成功件数、エラー件数のカウンタにより、処理の成功率を把握可能

## 9. 改訂履歴

| 改訂日     | 改訂者 | 改訂内容                                         |
|------------|--------|--------------------------------------------------|
| 2025/05/29 | 初版   | 初版作成                                         |
