# テーブル定義書：ユーザー認証情報 (TBL-001)

| 項目                | 内容                                                                                |
|---------------------|------------------------------------------------------------------------------------|
| **テーブルID**      | TBL-001                                                                             |
| **テーブル名**      | MST_UserAuth                                                                        |
| **論理名**          | ユーザー認証情報                                                                    |
| **カテゴリ**        | マスタ系                                                                            |
| **主な利用機能カテゴリ** | 認証・認可                                                                      |
| **主な利用API ID**  | API-001, API-002                                                                    |
| **主な利用バッチID**| BATCH-001, BATCH-002, BATCH-003, BATCH-017                                          |
| **優先度**          | 最高                                                                                |
| **備考**            | SCR-LOGIN, SCR-ACCESS画面で利用                                                     |

## 1. テーブル概要

ユーザー認証情報テーブル（MST_UserAuth）は、システムへのアクセスを制御するためのユーザー認証情報を管理します。ユーザーIDとパスワードによる標準認証と、SSOによるシングルサインオン認証の両方をサポートし、アカウントのステータス管理や連続ログイン失敗によるロック機能も提供します。

## 2. カラム定義

| No | 論理名           | 物理名         | データ型    | 桁数 | 必須 | 主キー | 外部キー | デフォルト値 | 説明                                           |
|----|------------------|----------------|-------------|------|------|--------|----------|--------------|------------------------------------------------|
| 1  | ユーザーID       | user_id        | VARCHAR     | 50   | ○    | ○      |          |              | ユーザーを一意に識別するID                     |
| 2  | パスワードハッシュ | password_hash  | VARCHAR     | 256  | ○    |        |          |              | パスワードのハッシュ値（bcrypt等で暗号化）     |
| 3  | メールアドレス   | email          | VARCHAR     | 256  | ○    |        |          |              | ユーザーのメールアドレス                       |
| 4  | アカウント状態   | status         | VARCHAR     | 20   | ○    |        |          | 'ACTIVE'     | アカウントの状態（ACTIVE/LOCKED/INACTIVE）     |
| 5  | 連続失敗回数     | failed_attempts | INTEGER     | 2    | ○    |        |          | 0            | 連続ログイン失敗回数                           |
| 6  | ロック解除予定日時 | locked_until   | TIMESTAMP   |      |      |        |          | NULL         | アカウントロック解除予定日時                   |
| 7  | 最終ログイン日時 | last_login     | TIMESTAMP   |      |      |        |          | NULL         | 最後にログインした日時                         |
| 8  | SSO有効フラグ    | sso_enabled    | BOOLEAN     |      | ○    |        |          | FALSE        | SSOによる認証を有効にするかどうか              |
| 9  | SSOプロバイダ名  | sso_provider   | VARCHAR     | 50   |      |        |          | NULL         | 使用するSSOプロバイダの名称                    |
| 10 | SSO識別子        | sso_subject    | VARCHAR     | 256  |      |        |          | NULL         | SSOプロバイダから提供される一意の識別子        |
| 11 | 作成日時         | created_at     | TIMESTAMP   |      | ○    |        |          | CURRENT_TIMESTAMP | レコード作成日時                           |
| 12 | 更新日時         | updated_at     | TIMESTAMP   |      | ○    |        |          | CURRENT_TIMESTAMP | レコード更新日時                           |

## 3. インデックス定義

| インデックス名            | カラム                | 種類      | 説明                                           |
|---------------------------|------------------------|-----------|------------------------------------------------|
| PK_MST_UserAuth          | user_id                | PRIMARY   | 主キーインデックス                             |
| IDX_MST_UserAuth_email   | email                  | UNIQUE    | メールアドレスの一意性を保証するインデックス   |
| IDX_MST_UserAuth_status  | status                 | NORMAL    | アカウント状態による検索を高速化               |
| IDX_MST_UserAuth_sso     | sso_provider, sso_subject | NORMAL | SSO認証情報による検索を高速化                  |

## 4. 制約条件

| 制約名                    | 種類      | カラム                | 内容                                           |
|---------------------------|-----------|------------------------|------------------------------------------------|
| PK_MST_UserAuth          | PRIMARY KEY | user_id              | 主キー制約                                     |
| UQ_MST_UserAuth_email    | UNIQUE    | email                  | メールアドレスの一意性を保証する制約           |
| CK_MST_UserAuth_status   | CHECK     | status                 | status列の値をACTIVE/LOCKED/INACTIVEに制限     |
| CK_MST_UserAuth_failed   | CHECK     | failed_attempts        | 0以上の値のみ許可                              |

## 5. 外部キー制約

このテーブルには外部キー制約はありません。

## 6. 関連テーブル

| テーブル名      | 関連カラム | 関連の種類 | 関連の説明                                     |
|-----------------|------------|------------|------------------------------------------------|
| MST_UserRole    | user_id    | 1:N        | ユーザーに割り当てられたロール                 |
| HIS_AuditLog    | user_id    | 1:N        | ユーザーの操作履歴                             |
| SYS_TokenStore  | user_id    | 1:N        | ユーザーのアクセストークン                     |

## 7. データ操作イベント

| イベント         | 処理内容                                                                           |
|------------------|------------------------------------------------------------------------------------|
| INSERT           | created_at, updated_atに現在時刻を設定                                             |
| UPDATE           | updated_atを現在時刻で更新                                                         |
| ログイン失敗時   | failed_attemptsをインクリメント、閾値超過時はstatusを'LOCKED'に変更                |
| ログイン成功時   | failed_attemptsを0にリセット、last_loginを現在時刻で更新                          |
| パスワード変更時 | password_hashを更新、updated_atを現在時刻で更新                                   |

## 8. 特記事項

1. パスワードは必ずハッシュ化して保存し、平文では保存しないこと
2. アカウントロックは連続5回のログイン失敗で発生し、30分後に自動解除
3. SSO連携時はsso_enabled=TRUE、sso_provider、sso_subjectに適切な値を設定
4. 個人情報保護の観点から、このテーブルへのアクセスは厳格に制限すること

## 9. 改訂履歴

| 改訂日     | 改訂者 | 改訂内容                                         |
|------------|--------|--------------------------------------------------|
| 2025/05/29 | 初版   | 初版作成                                         |
