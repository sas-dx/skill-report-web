# ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©æ›¸: SYS_TokenStore (ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†)

## ğŸ“‹ åŸºæœ¬æƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ†ãƒ¼ãƒ–ãƒ«å | SYS_TokenStore |
| è«–ç†å | ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç† |
| ã‚«ãƒ†ã‚´ãƒª | ã‚·ã‚¹ãƒ†ãƒ ç³» |
| ä½œæˆæ—¥ | 2025-06-01 |

> **æ³¨æ„**: æœ¬ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©æ›¸ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚æ‰‹å‹•ç·¨é›†ã¯è¡Œã‚ãªã„ã§ãã ã•ã„ã€‚
> è©³ç´°å®šç¾©ã®å¤‰æ›´ã¯ `table-details/SYS_TokenStore_details.yaml` ã§è¡Œã£ã¦ãã ã•ã„ã€‚


## ğŸ“ æ”¹ç‰ˆå±¥æ­´

> **æ³¨æ„**: æ”¹ç‰ˆå±¥æ­´ã®è©³ç´°ã¯ä»¥ä¸‹ã®YAMLãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ï¼š
> `table-details/TABLE_NAME_details.yaml`

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ›´æ–°æ—¥ | æ›´æ–°è€… | ä¸»ãªå¤‰æ›´å†…å®¹ |
|------------|--------|--------|-------------|
| 1.0.0 | 2025-06-01 | é–‹ç™ºãƒãƒ¼ãƒ  | åˆç‰ˆä½œæˆ - ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ã®è©³ç´°å®šç¾© |


## ğŸ“ ãƒ†ãƒ¼ãƒ–ãƒ«æ¦‚è¦

SYS_TokenStoreï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ï¼‰ã¯ã€èªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ ã§ä½¿ç”¨ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ã‚’ç®¡ç†ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã™ã€‚

ä¸»ãªç›®çš„ï¼š
- JWTã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®ç®¡ç†
- ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®ç®¡ç†
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ç®¡ç†
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã®ãŸã‚ã®ãƒˆãƒ¼ã‚¯ãƒ³å±¥æ­´ç®¡ç†

ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã€èªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ ã®åŸºç›¤ã¨ãªã‚‹é‡è¦ãªã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚


## ğŸ—‚ï¸ ã‚«ãƒ©ãƒ å®šç¾©

| ã‚«ãƒ©ãƒ å | è«–ç†å | ãƒ‡ãƒ¼ã‚¿å‹ | æ¡æ•° | NULL | PK | FK | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|----------|--------|----------|------|------|----|----|------------|------|
| id | ID | VARCHAR | 50 | Ã— | â— |  |  | ãƒ—ãƒ©ã‚¤ãƒãƒªã‚­ãƒ¼ï¼ˆUUIDï¼‰ |
| is_deleted | å‰Šé™¤ãƒ•ãƒ©ã‚° | BOOLEAN |  | Ã— |  |  |  | è«–ç†å‰Šé™¤ãƒ•ãƒ©ã‚° |
| id | ID | VARCHAR | 50 | â—‹ |  |  |  | ãƒ—ãƒ©ã‚¤ãƒãƒªã‚­ãƒ¼ï¼ˆUUIDï¼‰ |
| tenant_id | ãƒ†ãƒŠãƒ³ãƒˆID | VARCHAR | 50 | â—‹ |  |  |  | ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆè­˜åˆ¥å­ |
| user_id | ãƒ¦ãƒ¼ã‚¶ãƒ¼ID | VARCHAR | 50 | â—‹ |  | â— |  | ãƒˆãƒ¼ã‚¯ãƒ³ã®æ‰€æœ‰è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆMST_UserAuthã¸ã®å‚ç…§ï¼‰ |
| token_type | ãƒˆãƒ¼ã‚¯ãƒ³ã‚¿ã‚¤ãƒ— | ENUM |  | â—‹ |  |  |  | ãƒˆãƒ¼ã‚¯ãƒ³ã®ç¨®é¡ï¼ˆACCESS:ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã€REFRESH:ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã€SESSION:ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰ |
| token_value | ãƒˆãƒ¼ã‚¯ãƒ³å€¤ | TEXT |  | â—‹ |  |  |  | ãƒˆãƒ¼ã‚¯ãƒ³ã®å€¤ï¼ˆæš—å·åŒ–å¿…é ˆï¼‰ |
| token_hash | ãƒˆãƒ¼ã‚¯ãƒ³ãƒãƒƒã‚·ãƒ¥ | VARCHAR | 255 | â—‹ |  |  |  | ãƒˆãƒ¼ã‚¯ãƒ³å€¤ã®ãƒãƒƒã‚·ãƒ¥å€¤ï¼ˆæ¤œç´¢ç”¨ï¼‰ |
| expires_at | æœ‰åŠ¹æœŸé™ | TIMESTAMP |  | â—‹ |  |  |  | ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ |
| issued_at | ç™ºè¡Œæ—¥æ™‚ | TIMESTAMP |  | â—‹ |  |  |  | ãƒˆãƒ¼ã‚¯ãƒ³ã®ç™ºè¡Œæ—¥æ™‚ |
| last_used_at | æœ€çµ‚ä½¿ç”¨æ—¥æ™‚ | TIMESTAMP |  | â—‹ |  |  |  | ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ€çµ‚ä½¿ç”¨æ—¥æ™‚ |
| client_ip | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIP | VARCHAR | 45 | â—‹ |  |  |  | ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œæ™‚ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆIPv6å¯¾å¿œï¼‰ |
| user_agent | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ | TEXT |  | â—‹ |  |  |  | ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œæ™‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæƒ…å ± |
| device_fingerprint | ãƒ‡ãƒã‚¤ã‚¹ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆ | VARCHAR | 255 | â—‹ |  |  |  | ãƒ‡ãƒã‚¤ã‚¹è­˜åˆ¥ç”¨ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆ |
| scope | ã‚¹ã‚³ãƒ¼ãƒ— | TEXT |  | â—‹ |  |  |  | ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆJSONå½¢å¼ï¼‰ |
| is_revoked | ç„¡åŠ¹åŒ–ãƒ•ãƒ©ã‚° | BOOLEAN |  | â—‹ |  |  |  | ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ |
| revoked_at | ç„¡åŠ¹åŒ–æ—¥æ™‚ | TIMESTAMP |  | â—‹ |  |  |  | ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚ŒãŸæ—¥æ™‚ |
| revoked_reason | ç„¡åŠ¹åŒ–ç†ç”± | ENUM |  | â—‹ |  |  |  | ç„¡åŠ¹åŒ–ã®ç†ç”±ï¼ˆLOGOUT:ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã€EXPIRED:æœŸé™åˆ‡ã‚Œã€SECURITY:ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ADMIN:ç®¡ç†è€…æ“ä½œï¼‰ |
| created_at | ä½œæˆæ—¥æ™‚ | TIMESTAMP |  | Ã— |  |  | CURRENT_TIMESTAMP | ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆæ—¥æ™‚ |
| updated_at | æ›´æ–°æ—¥æ™‚ | TIMESTAMP |  | Ã— |  |  | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | ãƒ¬ã‚³ãƒ¼ãƒ‰æ›´æ–°æ—¥æ™‚ |
| created_by | ä½œæˆè€… | VARCHAR | 50 | Ã— |  |  |  | ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆè€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID |
| updated_by | æ›´æ–°è€… | VARCHAR | 50 | Ã— |  |  |  | ãƒ¬ã‚³ãƒ¼ãƒ‰æ›´æ–°è€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID |

## ğŸ” ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å®šç¾©

| ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å | ã‚«ãƒ©ãƒ  | ãƒ¦ãƒ‹ãƒ¼ã‚¯ | èª¬æ˜ |
|----------------|--------|----------|------|
| idx_token_store_hash | token_hash | â—‹ | ãƒˆãƒ¼ã‚¯ãƒ³ãƒãƒƒã‚·ãƒ¥æ¤œç´¢ç”¨ï¼ˆä¸€æ„ï¼‰ |
| idx_token_store_user_type | user_id, token_type | Ã— | ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚¿ã‚¤ãƒ—æ¤œç´¢ç”¨ |
| idx_token_store_expires | expires_at, is_revoked | Ã— | æœ‰åŠ¹æœŸé™ãƒ»ç„¡åŠ¹åŒ–çŠ¶æ…‹æ¤œç´¢ç”¨ |
| idx_token_store_tenant_user | tenant_id, user_id | Ã— | ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ç”¨ |
| idx_token_store_issued | issued_at | Ã— | ç™ºè¡Œæ—¥æ™‚æ¤œç´¢ç”¨ |
| idx_token_store_last_used | last_used_at | Ã— | æœ€çµ‚ä½¿ç”¨æ—¥æ™‚æ¤œç´¢ç”¨ |

## ğŸ”’ åˆ¶ç´„å®šç¾©

| åˆ¶ç´„å | åˆ¶ç´„ã‚¿ã‚¤ãƒ— | å¯¾è±¡ã‚«ãƒ©ãƒ  | æ¡ä»¶ | èª¬æ˜ |
|--------|------------|------------|------|------|
| uk_token_store_hash | UNIQUE | token_hash |  | ãƒˆãƒ¼ã‚¯ãƒ³ãƒãƒƒã‚·ãƒ¥ä¸€æ„åˆ¶ç´„ |
| chk_token_store_type | CHECK |  | token_type IN ('ACCESS', 'REFRESH', 'SESSION') | ãƒˆãƒ¼ã‚¯ãƒ³ã‚¿ã‚¤ãƒ—å€¤ãƒã‚§ãƒƒã‚¯åˆ¶ç´„ |
| chk_token_store_revoked_reason | CHECK |  | revoked_reason IS NULL OR revoked_reason IN ('LOGOUT', 'EXPIRED', 'SECURITY', 'ADMIN') | ç„¡åŠ¹åŒ–ç†ç”±å€¤ãƒã‚§ãƒƒã‚¯åˆ¶ç´„ |
| chk_token_store_expires_after_issued | CHECK |  | expires_at > issued_at | æœ‰åŠ¹æœŸé™ãŒç™ºè¡Œæ—¥æ™‚ã‚ˆã‚Šå¾Œã§ã‚ã‚‹ã“ã¨ã‚’ãƒã‚§ãƒƒã‚¯ |
| chk_token_store_revoked_consistency | CHECK |  | (is_revoked = false AND revoked_at IS NULL AND revoked_reason IS NULL) OR (is_revoked = true AND revoked_at IS NOT NULL) | ç„¡åŠ¹åŒ–ãƒ•ãƒ©ã‚°ã¨ç„¡åŠ¹åŒ–æ—¥æ™‚ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ |

## ğŸ”— å¤–éƒ¨ã‚­ãƒ¼é–¢ä¿‚

| å¤–éƒ¨ã‚­ãƒ¼å | ã‚«ãƒ©ãƒ  | å‚ç…§ãƒ†ãƒ¼ãƒ–ãƒ« | å‚ç…§ã‚«ãƒ©ãƒ  | æ›´æ–°æ™‚ | å‰Šé™¤æ™‚ | èª¬æ˜ |
|------------|--------|--------------|------------|--------|--------|------|
| fk_token_store_user | user_id | MST_UserAuth | id | CASCADE | CASCADE | ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æƒ…å ±ã¸ã®å¤–éƒ¨ã‚­ãƒ¼ |

## ğŸ“Š ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿

```json
[
  {
    "id": "TS001",
    "tenant_id": "TENANT001",
    "user_id": "USER001",
    "token_type": "ACCESS",
    "token_value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_hash": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0",
    "expires_at": "2025-06-01 20:00:00",
    "issued_at": "2025-06-01 19:00:00",
    "last_used_at": "2025-06-01 19:30:00",
    "client_ip": "192.168.1.100",
    "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
    "device_fingerprint": "fp_abc123def456",
    "scope": "[\"read:profile\", \"write:skills\", \"read:goals\"]",
    "is_revoked": false,
    "revoked_at": null,
    "revoked_reason": null
  },
  {
    "id": "TS002",
    "tenant_id": "TENANT001",
    "user_id": "USER001",
    "token_type": "REFRESH",
    "token_value": "rt_xyz789abc123def456ghi789jkl012mno345",
    "token_hash": "b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1",
    "expires_at": "2025-06-08 19:00:00",
    "issued_at": "2025-06-01 19:00:00",
    "last_used_at": null,
    "client_ip": "192.168.1.100",
    "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
    "device_fingerprint": "fp_abc123def456",
    "scope": "[\"refresh\"]",
    "is_revoked": false,
    "revoked_at": null,
    "revoked_reason": null
  }
]
```

## ğŸ“Œ ç‰¹è¨˜äº‹é …

- ãƒˆãƒ¼ã‚¯ãƒ³å€¤ã¯æš—å·åŒ–å¿…é ˆã€æ¤œç´¢ã«ã¯ãƒãƒƒã‚·ãƒ¥å€¤ã‚’ä½¿ç”¨
- æœ‰åŠ¹æœŸé™ã¯ä½œæˆã‹ã‚‰1æ—¥çµŒéã§è‡ªå‹•å‰Šé™¤ã•ã‚Œã‚‹
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã®ãŸã‚ç™ºè¡Œãƒ»ä½¿ç”¨å±¥æ­´ã‚’è¨˜éŒ²
- ãƒ‡ãƒã‚¤ã‚¹ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆã«ã‚ˆã‚‹ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹æ¤œçŸ¥ã«å¯¾å¿œ
- ã‚¹ã‚³ãƒ¼ãƒ—æƒ…å ±ã¯JSONå½¢å¼ã§æŸ”è»Ÿãªæ¨©é™ç®¡ç†ã«å¯¾å¿œ
- ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚‚ç›£æŸ»ã®ãŸã‚ä¸€å®šæœŸé–“ä¿æŒ
- IPv6ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¯¾å¿œã—ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIPç®¡ç†

## ğŸ“‹ æ¥­å‹™ãƒ«ãƒ¼ãƒ«

- ãƒˆãƒ¼ã‚¯ãƒ³ãƒãƒƒã‚·ãƒ¥ã¯å…¨ã‚·ã‚¹ãƒ†ãƒ ã§ä¸€æ„ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹
- æœ‰åŠ¹æœŸé™åˆ‡ã‚Œã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯è‡ªå‹•çš„ã«ç„¡åŠ¹åŒ–ã•ã‚Œã‚‹
- ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã¯å†åˆ©ç”¨ä¸å¯
- åŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åŒä¸€ã‚¿ã‚¤ãƒ—ãƒˆãƒ¼ã‚¯ãƒ³ã¯è¤‡æ•°ç™ºè¡Œå¯èƒ½
- ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ã¯ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚ˆã‚Šé•·æœŸ
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ç”¨
- ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨æ™‚ã¯æœ€çµ‚ä½¿ç”¨æ—¥æ™‚ã‚’æ›´æ–°
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç†ç”±ã§ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã¯å³åº§ã«å‰Šé™¤å¯¾è±¡
