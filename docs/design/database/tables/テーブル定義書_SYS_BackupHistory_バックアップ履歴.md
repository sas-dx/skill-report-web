# テーブル定義書_SYS_BackupHistory_バックアップ履歴

## 基本情報

| 項目 | 内容 |
|------|------|
| テーブル名 | SYS_BackupHistory |
| 論理名 | バックアップ履歴 |
| 用途 | システムデータのバックアップ実行履歴を管理 |
| カテゴリ | システム系 |
| 作成日 | 2024-12-19 |
| 最終更新日 | 2024-12-19 |

## テーブル概要

バックアップ履歴テーブル（SYS_BackupHistory）は、システムデータのバックアップ実行履歴を管理するシステムテーブルです。
バックアップの実行日時、対象データ、ファイルサイズ、実行結果、エラー情報などを記録し、
データ保護とシステム復旧の基盤となります。
障害時の迅速な復旧作業や、バックアップ運用の監視・改善に活用され、
システムの可用性とデータの完全性を保証するための重要な管理情報を提供します。

## テーブル構造

| # | カラム名 | 論理名 | データ型 | 長さ | NULL | デフォルト | PK | FK | インデックス | 説明 |
|---|----------|--------|----------|------|------|------------|----|----|--------------|------|
| 1 | backup_id | バックアップID | VARCHAR | 50 | NOT NULL | - | ○ | - | PK | バックアップを一意に識別するID |
| 2 | tenant_id | テナントID | VARCHAR | 50 | NOT NULL | - | - | ○ | IDX | テナント識別子 |
| 3 | backup_type | バックアップ種別 | VARCHAR | 50 | NOT NULL | - | - | - | IDX | バックアップの種別（FULL/INCREMENTAL/DIFFERENTIAL） |
| 4 | target_database | 対象データベース | VARCHAR | 100 | NOT NULL | - | - | - | IDX | バックアップ対象のデータベース名 |
| 5 | target_tables | 対象テーブル | TEXT | - | NULL | - | - | - | - | バックアップ対象テーブル（カンマ区切り） |
| 6 | backup_file_name | バックアップファイル名 | VARCHAR | 255 | NOT NULL | - | - | - | - | バックアップファイル名 |
| 7 | file_path | ファイルパス | VARCHAR | 500 | NOT NULL | - | - | - | - | バックアップファイルの保存パス |
| 8 | file_size | ファイルサイズ | BIGINT | - | NOT NULL | 0 | - | - | - | バックアップファイルのサイズ（バイト） |
| 9 | is_compressed | 圧縮フラグ | BOOLEAN | - | NOT NULL | false | - | - | - | ファイルが圧縮されているかどうか |
| 10 | is_encrypted | 暗号化フラグ | BOOLEAN | - | NOT NULL | false | - | - | - | ファイルが暗号化されているかどうか |
| 11 | execution_status | 実行ステータス | VARCHAR | 20 | NOT NULL | - | - | - | IDX | 実行ステータス（SUCCESS/FAILED/RUNNING） |
| 12 | start_time | 開始日時 | TIMESTAMP | - | NOT NULL | - | - | - | IDX | バックアップ開始日時 |
| 13 | end_time | 終了日時 | TIMESTAMP | - | NULL | - | - | - | - | バックアップ終了日時 |
| 14 | execution_time | 実行時間 | INTEGER | - | NULL | - | - | - | - | 実行時間（秒） |
| 15 | record_count | レコード件数 | BIGINT | - | NULL | - | - | - | - | バックアップしたレコード件数 |
| 16 | error_message | エラーメッセージ | TEXT | - | NULL | - | - | - | - | エラーが発生した場合のメッセージ |
| 17 | error_code | エラーコード | VARCHAR | 20 | NULL | - | - | - | - | エラーコード |
| 18 | executed_by | 実行者 | VARCHAR | 50 | NOT NULL | - | - | ○ | - | バックアップ実行者（SYSTEM/ユーザーID） |
| 19 | execution_method | 実行方法 | VARCHAR | 20 | NOT NULL | - | - | - | - | 実行方法（AUTO/MANUAL） |
| 20 | retention_date | 保持期限 | DATE | - | NOT NULL | - | - | - | IDX | バックアップファイルの保持期限 |
| 21 | is_deleted | 削除フラグ | BOOLEAN | - | NOT NULL | false | - | - | IDX | バックアップファイルが削除されているかどうか |
| 22 | remarks | 備考 | TEXT | - | NULL | - | - | - | - | 備考・コメント |
| 23 | created_at | 作成日時 | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | - | - | - | レコード作成日時 |
| 24 | updated_at | 更新日時 | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | - | - | - | レコード更新日時 |

## リレーション

### 参照先テーブル
- MST_Tenant (tenant_id)
- MST_UserAuth (executed_by)

### 参照元テーブル
- なし（システム独立性を保つため）

## データ仕様

### backup_type（バックアップ種別）
- FULL: 全データのバックアップ
- INCREMENTAL: 前回バックアップ以降の差分
- DIFFERENTIAL: 前回フルバックアップ以降の差分

### execution_status（実行ステータス）
- SUCCESS: 正常終了
- FAILED: 異常終了
- RUNNING: 実行中

### execution_method（実行方法）
- AUTO: 自動実行（スケジュール）
- MANUAL: 手動実行

### 保持期限ルール
- フルバックアップ: 90日間保持
- 増分バックアップ: 30日間保持
- 手動バックアップ: 設定に応じて保持

## 運用仕様

### データ保持期間
- 1年間（監査・分析のため）

### バックアップ
- 日次バックアップ対象
- システムログとの連携

### メンテナンス
- 古いレコードの自動削除
- ファイルサイズ統計の定期更新

## パフォーマンス

### 想定レコード数
- 初期: 100件
- 1年後: 2,000件
- 3年後: 6,000件

### アクセスパターン
- 最新バックアップ状況確認: 高頻度
- 履歴検索: 中頻度
- 統計分析: 低頻度

### インデックス設計
- PRIMARY KEY: backup_id
- INDEX: tenant_id, backup_type, target_database
- INDEX: execution_status, start_time
- INDEX: retention_date, is_deleted
- COMPOSITE INDEX: target_database, start_time, execution_status

## セキュリティ

### アクセス制御
- 参照: システム管理者、運用担当者
- 更新: システムバッチのみ
- 削除: システム管理者のみ

### 機密情報
- バックアップファイルパスの機密性確保
- システム構成情報の適切な管理

## 移行仕様

### 初期データ
- 既存バックアップ履歴の移行
- ファイル情報の整合性確認

### データ移行
- バッチ処理による自動記録
- 外部バックアップツールとの連携

## 特記事項

### 制約事項
- ファイルサイズは0以上
- 実行時間は0以上
- レコード件数は0以上
- 終了日時は開始日時以降
- 削除されたファイルは物理削除不可

### 拡張予定
- クラウドバックアップ対応
- 自動復旧機能
- バックアップ品質評価機能

### 関連システム
- バックアップシステム
- 監視システム
- ストレージ管理システム
- 通知システム
- 復旧システム

### 業務ルール
1. バックアップ失敗時は管理者に通知
2. 3回連続失敗時はアラートを発報
3. 保持期限を過ぎたファイルは自動削除
4. 削除前に削除フラグをTRUEに設定
5. 重要データは複数世代保持

### 運用考慮事項
1. **ストレージ管理**
   - バックアップファイルのサイズ監視
   - ディスク容量不足の事前検知
   - 古いバックアップファイルの自動削除

2. **パフォーマンス**
   - バックアップ実行時間の監視
   - システム負荷への影響を最小化
   - 業務時間外での実行スケジュール

3. **セキュリティ**
   - バックアップファイルの暗号化
   - アクセス権限の適切な設定
   - 機密データの保護

4. **復旧テスト**
   - 定期的な復旧テストの実施
   - バックアップファイルの整合性チェック
   - 復旧手順の文書化
