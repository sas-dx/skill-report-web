# エンティティ関連図: マルチテナント対応スキル管理システム

## 1. 文書基本情報

- **文書名**: エンティティ関連図
- **プロジェクト名**: 年間スキル報告書WEB化PJT - マルチテナント対応
- **対象システム**: ホールディングス・グループ会社向けマルチテナントSaaS基盤
- **作成日**: 2025/06/01
- **作成者**: システムアーキテクト
- **改訂履歴**: 
  - 2025/05/30 初版作成（マルチテナント対応）
  - 2025/06/01 テーブル一覧に基づく全面更新（48テーブル対応）

---

## 2. エンティティ関連図概要

### 2.1 マルチテナント対応設計方針

**テナント分離**と**データ整合性**を重視したエンティティ設計：

1. **テナント分離**: 全エンティティにtenant_idを追加してデータ分離
2. **参照整合性**: テナント内でのみ外部キー制約を適用
3. **拡張性**: 新しいテナント固有機能の容易な追加
4. **監査性**: 全操作の追跡・監査機能

### 2.2 エンティティカテゴリ構成（48テーブル）

```mermaid
graph TB
    subgraph "マルチテナント基盤（4テーブル）"
        TENANT[MST_Tenant<br/>テナント管理]
        TENANT_SETTINGS[MST_TenantSettings<br/>テナント設定]
        TENANT_USAGE[SYS_TenantUsage<br/>テナント使用量]
        TENANT_BILLING[HIS_TenantBilling<br/>課金履歴]
    end
    
    subgraph "認証・認可（5テーブル）"
        USER_AUTH[MST_UserAuth<br/>ユーザー認証]
        ROLE[MST_Role<br/>ロール]
        PERMISSION[MST_Permission<br/>権限]
        USER_ROLE[MST_UserRole<br/>ユーザーロール]
        AUDIT_LOG[HIS_AuditLog<br/>監査ログ]
    end
    
    subgraph "組織・プロフィール（8テーブル）"
        EMPLOYEE[MST_Employee<br/>社員情報]
        DEPARTMENT[MST_Department<br/>部署]
        POSITION[MST_Position<br/>役職]
        JOB_TYPE[MST_JobType<br/>職種]
        EMP_DEPT[MST_EmployeeDepartment<br/>社員部署関連]
        EMP_POS[MST_EmployeePosition<br/>社員役職関連]
        EMP_JOB[MST_EmployeeJobType<br/>社員職種関連]
        TRAINING_PROG[MST_TrainingProgram<br/>研修プログラム]
    end
    
    subgraph "スキル管理（14テーブル）"
        SKILL_CATEGORY[MST_SkillCategory<br/>スキルカテゴリ]
        SKILL_HIERARCHY[MST_SkillHierarchy<br/>スキル階層]
        SKILL_ITEM[MST_SkillItem<br/>スキル項目]
        SKILL_GRADE[MST_SkillGrade<br/>スキルグレード]
        SKILL_RECORD[TRN_SkillRecord<br/>スキル情報]
        EMP_SKILL_GRADE[TRN_EmployeeSkillGrade<br/>社員スキルグレード]
        CERTIFICATION[MST_Certification<br/>資格情報]
        CERT_REQ[MST_CertificationRequirement<br/>資格要件]
        JOB_SKILL[MST_JobTypeSkill<br/>職種スキル関連]
        JOB_SKILL_GRADE[MST_JobTypeSkillGrade<br/>職種スキルグレード]
        SKILL_GRADE_REQ[MST_SkillGradeRequirement<br/>スキルグレード要件]
        SKILL_EVIDENCE[TRN_SkillEvidence<br/>スキル証跡]
        SKILL_INDEX[SYS_SkillIndex<br/>検索インデックス]
        SKILL_MATRIX[SYS_SkillMatrix<br/>スキルマップ]
    end
    
    subgraph "目標・キャリア管理（2テーブル）"
        CAREER_PLAN[MST_CareerPlan<br/>目標・キャリアプラン]
        GOAL_PROGRESS[TRN_GoalProgress<br/>目標進捗]
    end
    
    subgraph "作業実績・研修管理（4テーブル）"
        PROJECT_RECORD[TRN_ProjectRecord<br/>案件実績]
        TRAINING_HISTORY[TRN_TrainingHistory<br/>研修参加履歴]
        PDU[TRN_PDU<br/>継続教育ポイント]
        BATCH_JOB_LOG[WRK_BatchJobLog<br/>一括登録ジョブログ]
    end
    
    subgraph "通知・連携管理（5テーブル）"
        NOTIFY_SETTINGS[MST_NotificationSettings<br/>通知設定]
        NOTIFY_TEMPLATE[MST_NotificationTemplate<br/>通知テンプレート]
        NOTIFICATION[TRN_Notification<br/>通知履歴]
        NOTIFY_LOG[HIS_NotificationLog<br/>通知送信履歴]
        INTEGRATION_CONFIG[SYS_IntegrationConfig<br/>外部連携設定]
    end
    
    subgraph "システム管理（6テーブル）"
        SYSTEM_CONFIG[MST_SystemConfig<br/>システム設定]
        SYSTEM_LOG[SYS_SystemLog<br/>システムログ]
        TOKEN_STORE[SYS_TokenStore<br/>トークン管理]
        BACKUP_HISTORY[SYS_BackupHistory<br/>バックアップ履歴]
        MASTER_DATA[SYS_MasterData<br/>マスタデータ全般]
        REPORT_TEMPLATE[MST_ReportTemplate<br/>帳票テンプレート]
    end
    
    TENANT --> USER_AUTH
    TENANT --> EMPLOYEE
    TENANT --> SKILL_RECORD
    TENANT --> NOTIFY_SETTINGS
    TENANT_SETTINGS --> TENANT
    TENANT_USAGE --> TENANT
    TENANT_BILLING --> TENANT
```

---

## 3. 詳細エンティティ関連図

### 3.1 マルチテナント基盤エンティティ

```mermaid
erDiagram
    MST_Tenant {
        string tenant_id PK
        string tenant_name
        string domain_name
        string plan_type
        string status
        datetime created_at
        datetime updated_at
        string created_by
        string updated_by
    }
    
    MST_TenantSettings {
        string setting_id PK
        string tenant_id FK
        string category
        string setting_key
        string setting_value
        string data_type
        boolean is_encrypted
        datetime created_at
        datetime updated_at
    }
    
    SYS_TenantUsage {
        string usage_id PK
        string tenant_id FK
        date usage_date
        int active_users
        decimal storage_used_gb
        int api_calls
        int reports_generated
        datetime calculated_at
    }
    
    HIS_TenantBilling {
        string billing_id PK
        string tenant_id FK
        string billing_period
        decimal base_amount
        decimal usage_amount
        decimal total_amount
        string currency
        string status
        datetime generated_at
        datetime paid_at
    }
    
    MST_Tenant ||--o{ MST_TenantSettings : "has"
    MST_Tenant ||--o{ SYS_TenantUsage : "tracks"
    MST_Tenant ||--o{ HIS_TenantBilling : "bills"
```

### 3.2 認証・認可エンティティ（マルチテナント対応）

```mermaid
erDiagram
    MST_Tenant {
        string tenant_id PK
        string tenant_name
        string status
    }
    
    MST_UserAuth {
        string user_id PK
        string tenant_id FK
        string username
        string email
        string password_hash
        string status
        datetime last_login_at
        datetime created_at
        datetime updated_at
    }
    
    MST_Role {
        string role_id PK
        string tenant_id FK
        string role_name
        string description
        boolean is_system_role
        datetime created_at
        datetime updated_at
    }
    
    MST_Permission {
        string permission_id PK
        string tenant_id FK
        string permission_name
        string resource
        string action
        string description
        datetime created_at
        datetime updated_at
    }
    
    MST_UserRole {
        string user_role_id PK
        string tenant_id FK
        string user_id FK
        string role_id FK
        datetime assigned_at
        datetime expires_at
        string assigned_by
    }
    
    HIS_AuditLog {
        string log_id PK
        string tenant_id FK
        string user_id FK
        string action_type
        string resource_type
        string resource_id
        text old_values
        text new_values
        string ip_address
        string user_agent
        datetime created_at
    }
    
    SYS_TokenStore {
        string token_id PK
        string tenant_id FK
        string user_id FK
        string token_type
        string token_value
        datetime expires_at
        boolean is_revoked
        datetime created_at
    }
    
    MST_Tenant ||--o{ MST_UserAuth : "contains"
    MST_Tenant ||--o{ MST_Role : "defines"
    MST_Tenant ||--o{ MST_Permission : "defines"
    MST_UserAuth ||--o{ MST_UserRole : "has"
    MST_Role ||--o{ MST_UserRole : "assigned_to"
    MST_UserAuth ||--o{ HIS_AuditLog : "performs"
    MST_UserAuth ||--o{ SYS_TokenStore : "owns"
```

### 3.3 組織・プロフィールエンティティ（マルチテナント対応）

```mermaid
erDiagram
    MST_Tenant {
        string tenant_id PK
        string tenant_name
    }
    
    MST_Employee {
        string employee_id PK
        string tenant_id FK
        string user_id FK
        string employee_number
        string first_name
        string last_name
        string email
        string phone
        date hire_date
        string status
        datetime created_at
        datetime updated_at
    }
    
    MST_Department {
        string department_id PK
        string tenant_id FK
        string department_code
        string department_name
        string parent_department_id FK
        int sort_order
        boolean is_active
        datetime created_at
        datetime updated_at
    }
    
    MST_Position {
        string position_id PK
        string tenant_id FK
        string position_code
        string position_name
        int level
        int sort_order
        boolean is_active
        datetime created_at
        datetime updated_at
    }
    
    MST_JobType {
        string job_type_id PK
        string tenant_id FK
        string job_type_code
        string job_type_name
        string description
        boolean is_active
        datetime created_at
        datetime updated_at
    }
    
    MST_EmployeeDepartment {
        string assignment_id PK
        string tenant_id FK
        string employee_id FK
        string department_id FK
        date start_date
        date end_date
        boolean is_primary
        datetime created_at
    }
    
    MST_EmployeePosition {
        string assignment_id PK
        string tenant_id FK
        string employee_id FK
        string position_id FK
        date start_date
        date end_date
        boolean is_primary
        datetime created_at
    }
    
    MST_EmployeeJobType {
        string assignment_id PK
        string tenant_id FK
        string employee_id FK
        string job_type_id FK
        date start_date
        date end_date
        boolean is_primary
        datetime created_at
    }
    
    MST_TrainingProgram {
        string program_id PK
        string tenant_id FK
        string program_code
        string program_name
        string description
        int duration_hours
        string level
        boolean is_active
        datetime created_at
        datetime updated_at
    }
    
    MST_Tenant ||--o{ MST_Employee : "employs"
    MST_Tenant ||--o{ MST_Department : "organizes"
    MST_Tenant ||--o{ MST_Position : "defines"
    MST_Tenant ||--o{ MST_JobType : "categorizes"
    MST_Tenant ||--o{ MST_TrainingProgram : "offers"
    MST_UserAuth ||--|| MST_Employee : "authenticates"
    MST_Employee ||--o{ MST_EmployeeDepartment : "assigned_to"
    MST_Employee ||--o{ MST_EmployeePosition : "holds"
    MST_Employee ||--o{ MST_EmployeeJobType : "works_as"
    MST_Department ||--o{ MST_EmployeeDepartment : "contains"
    MST_Position ||--o{ MST_EmployeePosition : "grants"
    MST_JobType ||--o{ MST_EmployeeJobType : "categorizes"
    MST_Department ||--o{ MST_Department : "parent_of"
```

### 3.4 スキル管理エンティティ（マルチテナント対応）

```mermaid
erDiagram
    MST_Tenant {
        string tenant_id PK
        string tenant_name
    }
    
    MST_SkillCategory {
        bigint id PK
        string tenant_id FK
        string category_code
        string category_name
        bigint parent_category_id FK
        tinyint level
        int sort_order
        text description
        boolean is_active
        datetime created_at
        datetime updated_at
        bigint created_by FK
        bigint updated_by FK
    }
    
    MST_SkillHierarchy {
        string skill_id PK
        string tenant_id FK
        string skill_code
        string skill_name
        string parent_skill_id FK
        bigint category_id FK
        int level
        int sort_order
        boolean is_active
        datetime created_at
        datetime updated_at
    }
    
    MST_SkillItem {
        string skill_item_id PK
        string tenant_id FK
        string skill_id FK
        string item_code
        string item_name
        string description
        int sort_order
        boolean is_active
        datetime created_at
        datetime updated_at
    }
    
    MST_SkillGrade {
        string grade_id PK
        string tenant_id FK
        string grade_code
        string grade_name
        int level
        string description
        boolean is_active
        datetime created_at
        datetime updated_at
    }
    
    TRN_SkillRecord {
        string record_id PK
        string tenant_id FK
        string employee_id FK
        string skill_id FK
        int skill_level
        int experience_years
        date last_used_date
        string certification_status
        text notes
        datetime created_at
        datetime updated_at
        string updated_by
    }
    
    TRN_EmployeeSkillGrade {
        string emp_skill_grade_id PK
        string tenant_id FK
        string employee_id FK
        string skill_id FK
        string grade_id FK
        date assessed_date
        string assessment_method
        text notes
        datetime created_at
        datetime updated_at
    }
    
    MST_Certification {
        string certification_id PK
        string tenant_id FK
        string certification_code
        string certification_name
        string issuing_organization
        int validity_period_months
        boolean is_active
        datetime created_at
        datetime updated_at
    }
    
    MST_CertificationRequirement {
        string requirement_id PK
        string tenant_id FK
        string certification_id FK
        string skill_id FK
        int required_level
        boolean is_mandatory
        datetime created_at
        datetime updated_at
    }
    
    MST_JobTypeSkill {
        string job_skill_id PK
        string tenant_id FK
        string job_type_id FK
        string skill_id FK
        int required_level
        boolean is_mandatory
        datetime created_at
        datetime updated_at
    }
    
    MST_JobTypeSkillGrade {
        string job_skill_grade_id PK
        string tenant_id FK
        string job_type_id FK
        string skill_id FK
        string grade_id FK
        int required_level
        datetime created_at
        datetime updated_at
    }
    
    MST_SkillGradeRequirement {
        string grade_req_id PK
        string tenant_id FK
        string grade_id FK
        string skill_id FK
        int min_experience_years
        string required_certifications
        text assessment_criteria
        datetime created_at
        datetime updated_at
    }
    
    TRN_SkillEvidence {
        string evidence_id PK
        string tenant_id FK
        string employee_id FK
        string skill_id FK
        string evidence_type
        string evidence_title
        text description
        string file_path
        date evidence_date
        datetime created_at
        datetime updated_at
    }
    
    SYS_SkillIndex {
        string index_id PK
        string tenant_id FK
        string employee_id FK
        string skill_id FK
        text search_keywords
        decimal skill_score
        datetime last_updated
    }
    
    SYS_SkillMatrix {
        string matrix_id PK
        string tenant_id FK
        string department_id FK
        string skill_id FK
        int required_level
        int current_avg_level
        int employee_count
        decimal coverage_rate
        datetime calculated_at
    }
    
    MST_Tenant ||--o{ MST_SkillCategory : "defines"
    MST_Tenant ||--o{ MST_SkillHierarchy : "defines"
    MST_Tenant ||--o{ MST_SkillItem : "defines"
    MST_Tenant ||--o{ MST_SkillGrade : "defines"
    MST_Tenant ||--o{ MST_Certification : "manages"
    MST_SkillCategory ||--o{ MST_SkillCategory : "parent_of"
    MST_SkillCategory ||--o{ MST_SkillHierarchy : "categorizes"
    MST_SkillHierarchy ||--o{ MST_SkillItem : "contains"
    MST_SkillHierarchy ||--o{ MST_SkillHierarchy : "parent_of"
    MST_Employee ||--o{ TRN_SkillRecord : "has"
    MST_Employee ||--o{ TRN_EmployeeSkillGrade : "assessed"
    MST_Employee ||--o{ TRN_SkillEvidence : "provides"
    MST_SkillHierarchy ||--o{ TRN_SkillRecord : "categorizes"
    MST_SkillHierarchy ||--o{ TRN_EmployeeSkillGrade : "measures"
    MST_SkillGrade ||--o{ TRN_EmployeeSkillGrade : "grades"
    MST_Certification ||--o{ MST_CertificationRequirement : "requires"
    MST_SkillHierarchy ||--o{ MST_CertificationRequirement : "needed_for"
    MST_JobType ||--o{ MST_JobTypeSkill : "requires"
    MST_JobType ||--o{ MST_JobTypeSkillGrade : "grades"
    MST_SkillHierarchy ||--o{ MST_JobTypeSkill : "used_in"
    MST_SkillGrade ||--o{ MST_SkillGradeRequirement : "defines"
    TRN_SkillRecord ||--|| SYS_SkillIndex : "indexes"
    MST_Department ||--o{ SYS_SkillMatrix : "analyzed_by"
    MST_SkillHierarchy ||--o{ SYS_SkillMatrix : "measured_in"
```

### 3.5 目標・キャリア管理エンティティ

```mermaid
erDiagram
    MST_Tenant {
        string tenant_id PK
        string tenant_name
    }
    
    MST_CareerPlan {
        string plan_id PK
        string tenant_id FK
        string employee_id FK
        string goal_title
        text goal_description
        date target_date
        string status
        int progress_rate
        datetime created_at
        datetime updated_at
    }
    
    TRN_GoalProgress {
        string progress_id PK
        string tenant_id FK
        string plan_id FK
        date progress_date
        int progress_rate
        text progress_notes
        string status
        datetime created_at
        string created_by
    }
    
    MST_Tenant ||--o{ MST_CareerPlan : "plans"
    MST_Employee ||--o{ MST_CareerPlan : "sets"
    MST_CareerPlan ||--o{ TRN_GoalProgress : "progresses"
```

### 3.6 作業実績・研修管理エンティティ

```mermaid
erDiagram
    MST_Tenant {
        string tenant_id PK
        string tenant_name
    }
    
    TRN_ProjectRecord {
        string record_id PK
        string tenant_id FK
        string employee_id FK
        string project_name
        date work_date
        decimal work_hours
        string work_description
        string status
        datetime created_at
        datetime updated_at
        string updated_by
    }
    
    TRN_TrainingHistory {
        string training_id PK
        string tenant_id FK
        string employee_id FK
        string program_id FK
        string training_name
        string training_type
        date start_date
        date end_date
        decimal training_hours
        string completion_status
        text notes
        datetime created_at
        datetime updated_at
    }
    
    TRN_PDU {
        string pdu_id PK
        string tenant_id FK
        string employee_id FK
        string activity_type
        string activity_name
        date activity_date
        decimal pdu_points
        string certification_type
        text description
        datetime created_at
        datetime updated_at
    }
    
    WRK_BatchJobLog {
        string job_log_id PK
        string tenant_id FK
        string job_type
        string job_name
        string status
        datetime start_time
        datetime end_time
        int processed_count
        int success_count
        int error_count
        text error_details
        datetime created_at
    }
    
    MST_Tenant ||--o{ TRN_ProjectRecord : "tracks"
    MST_Tenant ||--o{ TRN_TrainingHistory : "records"
    MST_Tenant ||--o{ TRN_PDU : "accumulates"
    MST_Tenant ||--o{ WRK_BatchJobLog : "logs"
    MST_Employee ||--o{ TRN_ProjectRecord : "works_on"
    MST_Employee ||--o{ TRN_TrainingHistory : "attends"
    MST_Employee ||--o{ TRN_PDU : "earns"
    MST_TrainingProgram ||--o{ TRN_TrainingHistory : "provides"
```

### 3.7 通知・連携管理エンティティ

```mermaid
erDiagram
    MST_Tenant {
        string tenant_id PK
        string tenant_name
    }
    
    MST_NotificationSettings {
        string setting_id PK
        string tenant_id FK
        string notification_type
        string trigger_event
        boolean is_enabled
        text recipient_rules
        text content_template
        datetime created_at
        datetime updated_at
    }
    
    MST_NotificationTemplate {
        string template_id PK
        string tenant_id FK
        string template_name
        string notification_type
        string subject_template
        text body_template
        text variables
        boolean is_active
        datetime created_at
        datetime updated_at
    }
    
    TRN_Notification {
        string notification_id PK
        string tenant_id FK
        string recipient_id FK
        string notification_type
        string title
        text content
        string status
        datetime sent_at
        datetime read_at
        datetime created_at
    }
    
    HIS_NotificationLog {
        string log_id PK
        string tenant_id FK
        string notification_type
        string recipient
        string subject
        text content
        string status
        text error_message
        int retry_count
        datetime sent_at
        datetime created_at
    }
    
    SYS_IntegrationConfig {
        string config_id PK
        string tenant_id FK
        string integration_type
        string provider
        text configuration
        text encrypted_credentials
        boolean is_enabled
        datetime last_tested_at
        datetime created_at
        datetime updated_at
    }
    
    MST_Tenant ||--o{ MST_NotificationSettings : "configures"
    MST_Tenant ||--o{ MST_NotificationTemplate : "defines"
    MST_Tenant ||--o{ TRN_Notification : "sends"
    MST_Tenant ||--o{ HIS_NotificationLog : "logs"
    MST_Tenant ||--o{ SYS_IntegrationConfig : "integrates"
    MST_NotificationTemplate ||--o{ TRN_Notification : "uses"
    MST_NotificationSettings ||--o{ HIS_NotificationLog : "generates"
    MST_Employee ||--o{ TRN_Notification : "receives"
```

### 3.8 システム管理エンティティ

```mermaid
erDiagram
    MST_Tenant {
        string tenant_id PK
        string tenant_name
    }
    
    MST_SystemConfig {
        string config_id PK
        string tenant_id FK
        string config_category
        string config_key
        string config_value
        string data_type
        boolean is_encrypted
        text description
        datetime created_at
        datetime updated_at
    }
    
    MST_ReportTemplate {
        string template_id PK
        string tenant_id FK
        string template_name
        string report_type
        text template_content
        text parameters
        boolean is_active
        datetime created_at
        datetime updated_at
    }
    
    SYS_SystemLog {
        string log_id PK
        string tenant_id FK
        string log_level
        string component
        string message
        text stack_trace
        string user_id FK
        string session_id
        datetime created_at
    }
    
    SYS_BackupHistory {
        string backup_id PK
        string tenant_id FK
        string backup_type
        string backup_name
        string file_path
        decimal file_size_mb
        string status
        datetime start_time
        datetime end_time
        text error_message
        datetime created_at
    }
    
    SYS_MasterData {
        string data_id PK
        string tenant_id FK
        string data_type
        string data_key
        string data_value
        text description
        int sort_order
        boolean is_active
        datetime created_at
        datetime updated_at
    }
    
    MST_Tenant ||--o{ MST_SystemConfig : "configures"
    MST_Tenant ||--o{ MST_ReportTemplate : "defines"
    MST_Tenant ||--o{ SYS_SystemLog : "logs"
    MST_Tenant ||--o{ SYS_BackupHistory : "backs_up"
    MST_Tenant ||--o{ SYS_MasterData : "manages"
    MST_UserAuth ||--o{ SYS_SystemLog : "generates"
```

---

## 4. マルチテナント制約・インデックス設計

### 4.1 テナント分離制約

```sql
-- 全テーブルにテナント分離制約を追加
-- 例: MST_UserAuth
ALTER TABLE MST_UserAuth 
ADD CONSTRAINT chk_tenant_isolation 
CHECK (tenant_id IS NOT NULL);

-- 複合インデックス（tenant_id + 主要検索キー）
CREATE INDEX idx_userauth_tenant_email 
ON MST_UserAuth (tenant_id, email);

CREATE INDEX idx_skillrecord_tenant_employee 
ON TRN_SkillRecord (tenant_id, employee_id);

CREATE INDEX idx_auditlog_tenant_user_date 
ON HIS_AuditLog (tenant_id, user_id, created_at);

-- スキル関連の複合インデックス
CREATE INDEX idx_empskillgrade_tenant_emp_skill 
ON TRN_EmployeeSkillGrade (tenant_id, employee_id, skill_id);

CREATE INDEX idx_skillmatrix_tenant_dept_skill 
ON SYS_SkillMatrix (tenant_id, department_id, skill_id);
```

### 4.2 参照整合性制約（テナント内）

```sql
-- テナント内参照整合性制約の例
-- MST_UserRole: 同一テナント内でのみ参照可能
ALTER TABLE MST_UserRole 
ADD CONSTRAINT fk_userrole_tenant_user 
FOREIGN KEY (tenant_id, user_id) 
REFERENCES MST_UserAuth (tenant_id, user_id);

ALTER TABLE MST_UserRole 
ADD CONSTRAINT fk_userrole_tenant_role 
FOREIGN KEY (tenant_id, role_id) 
REFERENCES MST_Role (tenant_id, role_id);

-- TRN_SkillRecord: 同
