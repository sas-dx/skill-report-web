# 環境構築ガイド

## 概要
年間スキル報告書WEB化PJTの開発環境構築手順書です。
プロジェクトに参加する全ての開発者が対象で、Windows・Linux環境に対応しています。

## 技術スタック要件
- **Node.js**: v18.17.0以上 (Next.js 14要件)
- **パッケージマネージャー**: pnpm (推奨) / npm / yarn
- **Git**: 最新版
- **Docker**: 最新安定版 + Docker Compose
- **PostgreSQL**: v15.x
- **IDE**: VSCode or Cursor + 推奨拡張機能

---

## 環境構築手順

### 1. Node.js のチェック・インストール

#### 1-1. インストール状況チェック

**Windows (PowerShell)**
```powershell
node --version
```

**Linux (Terminal)**
```bash
node --version
```

**期待する結果**: `v18.17.0` 以上

#### 1-2. インストール手順（未インストール・バージョン不足の場合）

**方法1: 公式インストーラー（推奨）**
1. [Node.js公式サイト](https://nodejs.org/)にアクセス
2. LTS版（推奨版）をダウンロード
3. インストーラーを実行し、デフォルト設定でインストール
4. ターミナル/PowerShellを再起動
5. `node --version` で確認

**方法2: パッケージマネージャー**

**Windows (Chocolatey)**
```powershell
# Chocolateyがインストールされている場合
choco install nodejs
```

**Linux (Ubuntu/Debian)**
```bash
# NodeSourceリポジトリを使用
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
sudo apt-get install -y nodejs
```

**方法3: Node Version Manager (nvm) - 複数バージョン管理**

**Windows (nvm-windows)**
1. [nvm-windows](https://github.com/coreybutler/nvm-windows)からインストーラーをダウンロード
2. インストール後、PowerShellを再起動
```powershell
nvm install lts
nvm use lts
```

**Linux (nvm)**
```bash
# nvmインストール
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc

# Node.js LTSインストール
nvm install --lts
nvm use --lts
```

---

### 2. npm のチェック

#### 2-1. インストール状況チェック
```bash
npm --version
```

**期待する結果**: バージョン番号が表示される（Node.jsと同時にインストールされる）

---

### 3. pnpm のチェック・インストール

#### 3-1. インストール状況チェック
```bash
pnpm --version
```

#### 3-2. インストール手順（未インストールの場合）

**方法1: npm使用（推奨）**
```bash
npm install -g pnpm
```

**方法2: 公式インストールスクリプト**

**Windows (PowerShell)**
```powershell
iwr https://get.pnpm.io/install.ps1 -useb | iex
```

**Linux**
```bash
curl -fsSL https://get.pnpm.io/install.sh | sh -
```

**方法3: パッケージマネージャー**

**Windows (Chocolatey)**
```powershell
choco install pnpm
```

**Linux (Ubuntu/Debian)**
```bash
curl -fsSL https://get.pnpm.io/install.sh | sh -
```

#### 3-3. インストール確認
```bash
pnpm --version
```

---

### 4. Git のチェック・インストール

#### 4-1. インストール状況チェック
```bash
git --version
```

**期待する結果**: `git version 2.x.x` 以上

#### 4-2. インストール手順（未インストールの場合）

**Windows**
1. [Git公式サイト](https://git-scm.com/)にアクセス
2. Windows版をダウンロード
3. インストーラーを実行（デフォルト設定推奨）
4. PowerShellを再起動

**Linux (Ubuntu/Debian)**
```bash
sudo apt update
sudo apt install git
```

**Linux (CentOS/RHEL)**
```bash
sudo yum install git
# または
sudo dnf install git
```

#### 4-3. Git設定（初回のみ）
```bash
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"
```

---

### 5. Docker のチェック・インストール

#### 5-1. インストール状況チェック
```bash
docker --version
docker-compose --version
```

**期待する結果**: 
- `Docker version 20.x.x` 以上
- `Docker Compose version v2.x.x` 以上

#### 5-2. インストール手順（未インストールの場合）

**Windows**
1. [Docker Desktop公式サイト](https://www.docker.com/products/docker-desktop/)にアクセス
2. Windows版をダウンロード
3. インストーラーを実行
4. システム再起動
5. Docker Desktopを起動
6. WSL2バックエンドを有効化（推奨）

**Linux (Ubuntu/Debian)**
```bash
# 古いバージョンを削除
sudo apt-get remove docker docker-engine docker.io containerd runc

# 必要なパッケージをインストール
sudo apt-get update
sudo apt-get install ca-certificates curl gnupg lsb-release

# Docker公式GPGキーを追加
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# リポジトリを追加
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Dockerをインストール
sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin

# ユーザーをdockerグループに追加
sudo usermod -aG docker $USER
```

#### 5-3. 動作確認
```bash
docker run hello-world
```

---

### 6. PostgreSQL のチェック・インストール

#### 6-1. インストール状況チェック
```bash
psql --version
```

**期待する結果**: `psql (PostgreSQL) 15.x` 以上

#### 6-2. インストール手順

**方法1: PostgreSQL公式インストーラー（推奨）**

**Windows**
1. [PostgreSQL公式サイト](https://www.postgresql.org/download/windows/)にアクセス
2. PostgreSQL 15.x をダウンロード
3. インストーラーを実行
4. インストール設定：
   - Port: 5432（デフォルト）
   - Superuser password: 開発用パスワードを設定
   - Locale: Japanese, Japan
5. 環境変数PATHに追加（通常は自動設定）
6. PowerShellを再起動

**Linux (Ubuntu/Debian)**
```bash
# PostgreSQL公式リポジトリを追加
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
sudo apt-get update

# PostgreSQL 15をインストール
sudo apt-get install postgresql-15 postgresql-client-15

# サービス開始
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

**方法2: Docker使用（開発環境のみ）**
```bash
# PostgreSQLコンテナを起動
docker run --name postgres-dev \
  -e POSTGRES_PASSWORD=password \
  -e POSTGRES_DB=skillreport \
  -p 5432:5432 \
  -d postgres:15

# 接続確認
docker exec -it postgres-dev psql -U postgres -d skillreport
```

#### 6-3. 初期設定（ローカルインストールの場合）

**Windows**
```bash
# データベース作成
createdb skillreport

# 接続確認
psql -d skillreport
```

**Linux**
```bash
# postgresユーザーに切り替え
sudo -u postgres psql

# データベースとユーザー作成
CREATE DATABASE skillreport;
CREATE USER developer WITH PASSWORD 'password';
GRANT ALL PRIVILEGES ON DATABASE skillreport TO developer;
\q
```

---

### 7. プロジェクト固有設定

#### 7-1. プロジェクトクローン
```bash
git clone <repository-url>
cd skill-report-web
```

#### 7-2. 依存関係インストール
```bash
pnpm install
```

#### 7-3. 環境変数設定
```bash
# .env.localファイルを作成
cp .env.example .env.local

# 必要な環境変数を設定
# DATABASE_URL=postgresql://username:password@localhost:5432/skillreport
# NEXTAUTH_SECRET=your-secret-key
# NEXTAUTH_URL=http://localhost:3000
```

#### 7-4. データベース初期化
```bash
# Prismaマイグレーション実行
pnpm prisma migrate dev

# 初期データ投入
pnpm prisma db seed
```

#### 7-5. 開発サーバー起動
```bash
pnpm dev
```

**確認**: http://localhost:3000 でアプリケーションが表示される

---

## トラブルシューティング

### Node.js関連

**問題**: `node: command not found`
**解決**: 
- インストール後にターミナル/PowerShellを再起動
- 環境変数PATHにNode.jsのパスが追加されているか確認

**問題**: バージョンが古い
**解決**: 
- nvmを使用して最新LTSバージョンに切り替え
- 公式インストーラーで最新版を再インストール

### pnpm関連

**問題**: `pnpm: command not found`
**解決**: 
```bash
# npmでグローバルインストール
npm install -g pnpm

# または公式スクリプト使用
curl -fsSL https://get.pnpm.io/install.sh | sh -
```

### Docker関連

**問題**: `docker: permission denied`（Linux）
**解決**: 
```bash
sudo usermod -aG docker $USER
# ログアウト・ログインまたは再起動
```

**問題**: Docker Desktopが起動しない（Windows）
**解決**: 
- WSL2が有効になっているか確認
- Hyper-Vが有効になっているか確認
- システム再起動

### PostgreSQL関連

**問題**: `psql: FATAL: role "username" does not exist`
**解決**: 
```bash
# ユーザー作成
sudo -u postgres createuser --interactive
```

**問題**: 接続できない
**解決**: 
- PostgreSQLサービスが起動しているか確認
- ポート5432が使用可能か確認
- ファイアウォール設定を確認

### Git関連

**問題**: `fatal: unable to access 'https://github.com/...': SSL certificate problem`
**解決**: 
```bash
# SSL証明書検証を無効化（一時的）
git config --global http.sslVerify false

# または、証明書を更新
git config --global http.sslCAInfo /path/to/certificate.pem
```

---

## OS別注意事項

### Windows
- PowerShell 5.1以上を使用
- 長いパス名に対応するため、Git Bashの使用を推奨
- WSL2の使用を検討（Linux環境との互換性向上）

### Linux
- パッケージマネージャーによってコマンドが異なる
- 権限設定に注意（sudo使用）
- ファイアウォール設定の確認が必要

---

## 環境構築完了チェックリスト

- [ ] Node.js v18.17.0以上がインストールされている
- [ ] npm/pnpmが利用可能
- [ ] Gitがインストール・設定されている
- [ ] Dockerが起動し、hello-worldが実行できる
- [ ] PostgreSQLがインストール・起動している
- [ ] プロジェクトがクローンされている
- [ ] 依存関係がインストールされている
- [ ] 環境変数が設定されている
- [ ] データベースが初期化されている
- [ ] 開発サーバーが起動し、ブラウザでアクセスできる

全ての項目にチェックが入れば、開発環境の構築は完了です。

---

## サポート

環境構築で問題が発生した場合は、以下の情報を含めてチームに相談してください：

1. OS・バージョン
2. 実行したコマンド
3. エラーメッセージ
4. 実行環境（ターミナル、PowerShell等）

プロジェクトSlackチャンネル: #skill-report-dev
