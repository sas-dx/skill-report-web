# E2Eテスト実装ガイド: 年間スキル報告書WEB化PJT

---

## 1. 文書情報

| 項目 | 内容 |
|------|------|
| 文書名 | E2Eテスト実装ガイド（統合版） |
| プロジェクト名 | 年間スキル報告書WEB化プロジェクト |
| システム名 | スキル報告書管理システム（SRMS） |
| プロジェクトID | SAS-DX-AI-2025-001 |
| 作成者 | AI推進チーム |
| 作成日 | 2025年5月29日 |
| 最終更新日 | 2025年6月2日 |
| 版数 | 2.0 |

---

## 2. E2Eテストの概要

### 2.1 E2Eテストの目的

E2E（End-to-End）テストは、実際のユーザーの操作フローを模倣し、Next.js アプリケーション全体が期待通りに動作することを確認するテストです。

#### 主な検証項目
- **ユーザージャーニー**: ログインから各機能利用までの一連の流れ
- **UI/UX**: Next.js + Tailwind CSS による UI の動作と表示
- **データフロー**: フロントエンドから API Routes、PostgreSQL までの完全なデータ処理
- **認証フロー**: NextAuth.js による認証・認可の動作
- **レスポンシブ対応**: デスクトップ・タブレット・モバイルでの表示確認

### 2.2 テスト対象システム構成

```mermaid
graph TD
    A[Next.js Frontend] --> B[NextAuth.js]
    A --> C[API Routes]
    B --> D[JWT Provider]
    C --> E[Prisma ORM]
    E --> F[PostgreSQL]
    A --> G[Tailwind CSS]
    C --> H[File Upload]
    H --> I[Vercel Blob]
    
    subgraph "E2E Test Coverage"
        J[User Authentication]
        K[Skill Management]
        L[Profile Management]
        M[Report Generation]
        N[File Operations]
    end
    
    J --> A
    K --> A
    L --> A
    M --> A
    N --> A
```

---

## 3. テスト環境セットアップ

### 3.1 必要パッケージのインストール

```bash
# Playwright のインストール（バージョン 1.56 以降を推奨）
npm install -D @playwright/test

# ブラウザのインストール
npx playwright install

# 追加の型定義とユーティリティ
npm install -D @types/node
npm install -D dotenv
npm install -D cross-env

# アクセシビリティテスト用
npm install -D @axe-core/playwright

# Playwright Agents のセットアップ（AI駆動テスト生成・自動修復）
npx playwright init-agents --loop=claude
```

### 3.1.1 Playwright Agents セットアップ

Playwright Agents は AI を活用したテスト自動化の革新的な機能です。Claude Code との統合により、テスト計画の生成、テストコードの自動生成、テスト失敗時の自動修復が可能になります。

#### セットアップオプション

```bash
# Claude Code 統合（推奨）
npx playwright init-agents --loop=claude

# GitHub Copilot 統合
npx playwright init-agents --loop=copilot

# OpenAI 統合
npx playwright init-agents --loop=openai
```

#### 環境変数の設定

```bash
# .env.local に追加
ANTHROPIC_API_KEY=your_api_key_here  # Claude Code 使用時
OPENAI_API_KEY=your_api_key_here     # OpenAI 使用時
```

### 3.2 Playwright設定ファイル

#### playwright.config.ts
```typescript
import { defineConfig, devices } from '@playwright/test'
import dotenv from 'dotenv'

// 環境変数の読み込み
dotenv.config({ path: '.env.test' })

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  timeout: 60000,
  expect: {
    timeout: 10000
  },
  reporter: [
    ['html', { outputFolder: 'test-results/html-report' }],
    ['json', { outputFile: 'test-results/results.json' }],
    ['junit', { outputFile: 'test-results/results.xml' }]
  ],
  use: {
    baseURL: process.env.BASE_URL || 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    video: 'retain-on-failure',
    actionTimeout: 10000,
    navigationTimeout: 30000,
    headless: process.env.CI ? true : false,
    viewport: { width: 1280, height: 720 },
    ignoreHTTPSErrors: true,
    locale: 'ja-JP',
    timezoneId: 'Asia/Tokyo'
  },
  projects: [
    // デスクトップブラウザ
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] }
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] }
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] }
    },
    // モバイルデバイス
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] }
    },
    {
      name: 'Mobile Safari',
      use: { ...devices['iPhone 12'] }
    }
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
    timeout: 120000
  }
})
```

---

## 4. Playwright Agents によるAI駆動テスト自動化

### 4.1 Playwright Agents の概要

Playwright Agents（Playwright 1.56+）は、AI を活用してテスト計画の生成、テストコードの自動生成、テスト失敗時の自動修復を行う革新的な機能です。3つの専門エージェントが連携し、テスト自動化の効率とメンテナンス性を劇的に向上させます。

#### 4.1.1 3つのエージェント

##### 1. Planner（プランナー）- テスト計画自動生成

**役割**: アプリケーションを探索し、ユーザーストーリーに基づいたテスト計画を Markdown 形式で自動生成

**主な機能**:
- アプリケーションコードと UI の分析
- 包括的なテストシナリオの設計
- テストケースの優先順位付け
- カバレッジの自動評価

**使用例**:
```bash
# スキル管理機能のテスト計画を自動生成
npx playwright agent planner --feature "skill-management" --output tests/plans/skill-management.md

# ユーザーストーリーからテスト計画を生成
npx playwright agent planner --story "ユーザーがスキルを登録・編集・削除できる" --output tests/plans/skill-crud.md
```

**生成されるテスト計画の例**:
```markdown
# スキル管理機能 テスト計画

## テストシナリオ

### 1. スキル登録
- 正常系: 必須項目を入力してスキルを登録
- 異常系: 必須項目が未入力の場合のバリデーション
- 境界値: 最大文字数でのスキル登録

### 2. スキル編集
- 正常系: 既存スキルの情報を更新
- 異常系: 存在しないスキルの編集試行

### 3. スキル削除
- 正常系: スキルを削除し、リストから消える
- 確認ダイアログ: 削除確認ダイアログが表示される
```

##### 2. Generator（ジェネレーター）- テストコード自動生成

**役割**: Planner が生成した Markdown テスト計画を、実行可能な Playwright テストコード（TypeScript/JavaScript）に変換

**主な機能**:
- Markdown からテストコードへの自動変換
- Page Object Model パターンの自動適用
- データ駆動テストの生成
- アサーションの自動挿入

**使用例**:
```bash
# テスト計画からテストコードを生成
npx playwright agent generator --plan tests/plans/skill-management.md --output tests/e2e/skills-generated.spec.ts

# 既存テストの拡張
npx playwright agent generator --plan tests/plans/additional-scenarios.md --append tests/e2e/skills.spec.ts
```

**生成されるテストコードの例**:
```typescript
import { test, expect } from '@playwright/test'

test.describe('スキル管理機能', () => {
  test('正常系: 必須項目を入力してスキルを登録', async ({ page }) => {
    // AI が自動生成したテストコード
    await page.goto('/skills')
    await page.click('[data-testid="add-skill-button"]')
    await page.fill('[data-testid="skill-name-input"]', 'Next.js')
    await page.selectOption('[data-testid="skill-category-select"]', 'フレームワーク')
    await page.selectOption('[data-testid="skill-level-select"]', '◎')
    await page.click('[data-testid="save-skill-button"]')

    await expect(page.locator('[data-testid="skill-item-Next.js"]')).toBeVisible()
    await expect(page.locator('[data-testid="success-message"]')).toContainText('スキルを追加しました')
  })
})
```

##### 3. Healer（ヒーラー）- テスト自動修復

**役割**: テスト実行時の失敗を AI が分析し、自動的に修正提案を行い、適用する

**主な機能**:
- テスト失敗の根本原因分析
- UI 変更に対するセレクタの自動更新
- タイミング問題の自動修正
- データ依存性の問題解決

**使用例**:
```bash
# テスト実行と自動修復
npx playwright agent healer --test tests/e2e/skills.spec.ts

# CI/CD での自動修復モード
npx playwright agent healer --auto-fix --test tests/e2e/

# 修復提案のみ（自動適用しない）
npx playwright agent healer --suggest-only --test tests/e2e/skills.spec.ts
```

**自動修復の例**:
```typescript
// 修復前（失敗するテスト）
await page.click('[data-testid="old-button-id"]')  // UI変更で要素が見つからない

// Healer が自動修復
await page.click('[data-testid="new-button-id"]')  // 新しいセレクタに自動更新
```

### 4.2 Playwright Agents ワークフロー

#### 4.2.1 基本ワークフロー

```mermaid
graph TD
    A[ユーザーストーリー] --> B[Planner: テスト計画生成]
    B --> C[Generator: テストコード生成]
    C --> D[テスト実行]
    D --> E{テスト成功?}
    E -->|成功| F[デプロイ]
    E -->|失敗| G[Healer: 失敗分析]
    G --> H[Healer: 自動修復]
    H --> D

    subgraph "AI駆動テスト自動化サイクル"
        B
        C
        G
        H
    end
```

#### 4.2.2 実践的なワークフロー例

##### ステップ1: テスト計画の生成

```bash
# 新機能「スキル検索」のテスト計画を生成
npx playwright agent planner \
  --feature "スキル検索機能" \
  --story "ユーザーはスキル名、カテゴリ、レベルで検索できる" \
  --output tests/plans/skill-search.md
```

##### ステップ2: テストコードの生成

```bash
# 生成されたテスト計画からテストコードを自動生成
npx playwright agent generator \
  --plan tests/plans/skill-search.md \
  --output tests/e2e/skill-search.spec.ts
```

##### ステップ3: テスト実行と自動修復

```bash
# テスト実行（失敗時は自動修復を試行）
npx playwright agent healer \
  --auto-fix \
  --test tests/e2e/skill-search.spec.ts
```

### 4.3 Playwright Agents のベストプラクティス

#### 4.3.1 テスト計画の作成

**推奨事項**:
- 明確なユーザーストーリーを記述
- テストの目的と期待結果を明示
- エッジケースと異常系を含める
- ビジネスロジックを自然言語で説明

**例**:
```bash
# 良い例: 具体的なユーザーストーリー
npx playwright agent planner \
  --story "一般ユーザーが自分のスキルを4段階評価（×/△/○/◎）で登録し、カテゴリ別に検索・編集・削除できる"

# 悪い例: 曖昧な指示
npx playwright agent planner --story "スキル機能"
```

#### 4.3.2 テストコード生成の最適化

**data-testid の活用**:
- Generator が安定したセレクタを生成できるよう、`data-testid` を使用
- セマンティックな命名規則を採用

```typescript
// 推奨: data-testid を使用
<button data-testid="add-skill-button">追加</button>

// 非推奨: CSS クラスのみ
<button className="btn-primary">追加</button>
```

#### 4.3.3 自動修復の活用

**段階的な自動修復**:
1. **開発環境**: `--suggest-only` で修復提案を確認
2. **CI/CD**: `--auto-fix` で自動修復を有効化
3. **本番前**: 人間によるレビューと承認

```bash
# 開発時: 提案のみ
npx playwright agent healer --suggest-only

# CI/CD: 自動修復
npx playwright agent healer --auto-fix --max-attempts=3
```

### 4.4 工数削減効果とROI

#### 4.4.1 期待される効果

| 作業 | 従来の方法 | Playwright Agents | 削減率 |
|------|-----------|-------------------|-------|
| テスト計画作成 | 4時間 | 30分（レビュー含む） | 87.5% |
| テストコード作成 | 8時間 | 1時間（調整含む） | 87.5% |
| テストメンテナンス | 4時間/月 | 30分/月 | 87.5% |
| 失敗分析・修正 | 2時間 | 15分（自動修復） | 87.5% |

**年間工数削減**: 約200時間（1人月相当）

#### 4.4.2 メンテナンス性の向上

- **セルフヒーリング**: UI変更時のテスト自動修復により、メンテナンスコストを80%削減
- **テストカバレッジ向上**: 短時間で多くのテストケースを生成可能
- **品質向上**: AIによる包括的なシナリオ生成

### 4.5 CI/CD統合

#### 4.5.1 GitHub Actions での Playwright Agents 統合

```yaml
# .github/workflows/playwright-agents.yml
name: Playwright Agents E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  e2e-with-agents:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    - name: Run E2E tests with auto-healing
      run: npx playwright agent healer --auto-fix --test tests/e2e/
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        BASE_URL: http://localhost:3000

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: playwright-agents-report
        path: |
          test-results/
          playwright-report/
```

#### 4.5.2 プルリクエストでのテスト計画生成

```yaml
# PR作成時に自動的にテスト計画を生成
name: Generate Test Plan

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  generate-test-plan:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Generate test plan from PR description
      run: |
        npx playwright agent planner \
          --story "${{ github.event.pull_request.body }}" \
          --output tests/plans/pr-${{ github.event.pull_request.number }}.md

    - name: Comment test plan on PR
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs')
          const plan = fs.readFileSync('tests/plans/pr-${{ github.event.pull_request.number }}.md', 'utf8')
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## 自動生成されたテスト計画\n\n${plan}`
          })
```

### 4.6 注意事項と制限事項

#### 4.6.1 適用範囲

**適している用途**:
- 標準的な CRUD 操作のテスト
- フォーム入力・バリデーションのテスト
- ナビゲーション・画面遷移のテスト
- データ検索・フィルタリングのテスト

**適していない用途**:
- 複雑なドラッグ&ドロップ操作
- キャンバスベースの描画テスト
- リアルタイム通信の詳細なテスト
- 高度なセキュリティテスト

#### 4.6.2 コスト考慮事項

- AI API 使用料が発生（Claude、OpenAI など）
- 大規模プロジェクトでは月額 $50-200 程度を想定
- 工数削減効果により、十分にROIが見込める

---

## 5. E2Eテストケース実装

### 5.1 認証機能テスト（NextAuth.js）

#### tests/e2e/auth.spec.ts
```typescript
import { test, expect } from '@playwright/test'

test.describe('NextAuth.js 認証機能', () => {
  test('正常系: 認証情報でサインイン・サインアウトフロー', async ({ page }) => {
    // サインインページにアクセス
    await page.goto('/auth/signin')
    await expect(page.locator('h1')).toContainText('サインイン')
    
    // サインイン実行
    await page.fill('input[name="email"]', 'test@example.com')
    await page.fill('input[name="password"]', 'password123')
    await page.click('button[type="submit"]')
    
    // ダッシュボードに遷移することを確認
    await expect(page).toHaveURL('/dashboard')
    await expect(page.locator('[data-testid="welcome-message"]')).toBeVisible()
    
    // サインアウト実行
    await page.click('[data-testid="user-dropdown"]')
    await page.click('[data-testid="logout-button"]')
    
    // サインインページに戻ることを確認
    await expect(page).toHaveURL('/auth/signin')
  })

  test('異常系: 無効な認証情報でサインイン失敗', async ({ page }) => {
    await page.goto('/auth/signin')
    
    // 無効な認証情報でサインイン試行
    await page.fill('input[name="email"]', 'invalid@example.com')
    await page.fill('input[name="password"]', 'wrongpassword')
    await page.click('button[type="submit"]')
    
    // エラーメッセージの表示確認
    await expect(page.locator('[data-testid="auth-error"]')).toContainText('認証に失敗しました')
    
    // サインインページに留まることを確認
    await expect(page).toHaveURL(/\/auth\/signin/)
  })

  test('正常系: 未認証時のリダイレクト', async ({ page }) => {
    // 未認証で保護されたページにアクセス
    await page.goto('/skills')
    
    // サインインページにリダイレクトされることを確認
    await expect(page).toHaveURL(/\/auth\/signin/)
  })
})
```

### 5.2 スキル管理機能テスト

#### tests/e2e/skills.spec.ts
```typescript
import { test, expect } from '@playwright/test'

test.describe('スキル管理機能', () => {
  test.beforeEach(async ({ page }) => {
    // 事前にサインイン
    await page.goto('/auth/signin')
    await page.fill('input[name="email"]', 'test@example.com')
    await page.fill('input[name="password"]', 'password123')
    await page.click('button[type="submit"]')
    await expect(page).toHaveURL('/dashboard')
    
    // スキル管理ページに移動
    await page.click('[data-testid="nav-skills"]')
    await expect(page).toHaveURL('/skills')
  })

  test('正常系: 新規スキル追加', async ({ page }) => {
    // スキル追加ボタンをクリック
    await page.click('[data-testid="add-skill-button"]')
    await expect(page.locator('[data-testid="skill-modal"]')).toBeVisible()
    
    // スキル情報を入力
    await page.fill('[data-testid="skill-name-input"]', 'Next.js')
    await page.selectOption('[data-testid="skill-category-select"]', 'フレームワーク')
    await page.selectOption('[data-testid="skill-level-select"]', '◎')
    await page.fill('[data-testid="skill-experience-input"]', '2年')
    await page.fill('[data-testid="skill-description-textarea"]', 'React ベースのフルスタックフレームワーク')
    
    // 保存実行
    await page.click('[data-testid="save-skill-button"]')
    
    // 追加されたスキルの確認
    await expect(page.locator('[data-testid="skill-item-Next.js"]')).toBeVisible()
    await expect(page.locator('[data-testid="success-message"]')).toContainText('スキルを追加しました')
  })

  test('正常系: スキル編集', async ({ page }) => {
    // 既存スキルを追加
    await page.click('[data-testid="add-skill-button"]')
    await page.fill('[data-testid="skill-name-input"]', 'TypeScript')
    await page.selectOption('[data-testid="skill-category-select"]', 'プログラミング言語')
    await page.selectOption('[data-testid="skill-level-select"]', '○')
    await page.click('[data-testid="save-skill-button"]')
    
    // スキルを編集
    await page.click('[data-testid="skill-item-TypeScript"] [data-testid="edit-skill-button"]')
    await page.selectOption('[data-testid="skill-level-select"]', '◎')
    await page.fill('[data-testid="skill-experience-input"]', '2年')
    await page.click('[data-testid="save-skill-button"]')
    
    // 編集されたスキルの確認
    await expect(page.locator('[data-testid="skill-item-TypeScript"] [data-testid="skill-level"]')).toContainText('◎')
    await expect(page.locator('[data-testid="success-message"]')).toContainText('スキルを更新しました')
  })

  test('正常系: スキル削除', async ({ page }) => {
    // 削除対象スキルを追加
    await page.click('[data-testid="add-skill-button"]')
    await page.fill('[data-testid="skill-name-input"]', 'Vue.js')
    await page.selectOption('[data-testid="skill-category-select"]', 'フレームワーク')
    await page.selectOption('[data-testid="skill-level-select"]', '△')
    await page.click('[data-testid="save-skill-button"]')
    
    // スキルを削除
    await page.click('[data-testid="skill-item-Vue.js"] [data-testid="delete-skill-button"]')
    await page.click('[data-testid="confirm-delete-button"]')
    
    // 削除されたことを確認
    await expect(page.locator('[data-testid="skill-item-Vue.js"]')).not.toBeVisible()
    await expect(page.locator('[data-testid="success-message"]')).toContainText('スキルを削除しました')
  })

  test('正常系: スキル検索・フィルタリング', async ({ page }) => {
    // テストデータ追加
    const testSkills = [
      { name: 'React', category: 'フレームワーク', level: '◎' },
      { name: 'Angular', category: 'フレームワーク', level: '○' },
      { name: 'Python', category: 'プログラミング言語', level: '◎' }
    ]
    
    for (const skill of testSkills) {
      await page.click('[data-testid="add-skill-button"]')
      await page.fill('[data-testid="skill-name-input"]', skill.name)
      await page.selectOption('[data-testid="skill-category-select"]', skill.category)
      await page.selectOption('[data-testid="skill-level-select"]', skill.level)
      await page.click('[data-testid="save-skill-button"]')
    }
    
    // 検索テスト
    await page.fill('[data-testid="skill-search-input"]', 'React')
    await page.keyboard.press('Enter')
    await expect(page.locator('[data-testid^="skill-item-"]')).toHaveCount(1)
    await expect(page.locator('[data-testid="skill-item-React"]')).toBeVisible()
    
    // フィルタリングテスト
    await page.click('[data-testid="clear-filters-button"]')
    await page.selectOption('[data-testid="category-filter"]', 'フレームワーク')
    await expect(page.locator('[data-testid^="skill-item-"]')).toHaveCount(2)
    
    await page.selectOption('[data-testid="level-filter"]', '◎')
    await expect(page.locator('[data-testid^="skill-item-"]')).toHaveCount(1)
    await expect(page.locator('[data-testid="skill-item-React"]')).toBeVisible()
  })

  test('異常系: 無効なスキルデータで登録失敗', async ({ page }) => {
    await page.click('[data-testid="add-skill-button"]')
    
    // 必須項目を空で送信
    await page.click('[data-testid="save-skill-button"]')
    
    // バリデーションエラーの確認
    await expect(page.locator('[data-testid="error-message"]')).toContainText('スキル名は必須です')
    
    // モーダルが閉じていないことを確認
    await expect(page.locator('[data-testid="skill-modal"]')).toBeVisible()
  })
})
```

### 5.3 レスポンシブデザインテスト

#### tests/e2e/responsive.spec.ts
```typescript
import { test, expect } from '@playwright/test'

test.describe('レスポンシブデザイン', () => {
  test.beforeEach(async ({ page }) => {
    // 事前にサインイン
    await page.goto('/auth/signin')
    await page.fill('input[name="email"]', 'test@example.com')
    await page.fill('input[name="password"]', 'password123')
    await page.click('button[type="submit"]')
    await expect(page).toHaveURL('/dashboard')
  })

  test('モバイル表示: ダッシュボード', async ({ page }) => {
    // モバイルサイズに変更
    await page.setViewportSize({ width: 375, height: 667 })
    
    // モバイル用ナビゲーションの確認
    const mobileMenu = page.locator('[data-testid="mobile-menu"]')
    await expect(mobileMenu).toBeVisible()
    
    // カードレイアウトの確認
    await expect(page.locator('[data-testid="skill-summary-card"]')).toBeVisible()
    await expect(page.locator('[data-testid="recent-activities-card"]')).toBeVisible()
    
    // スクロール可能性の確認
    await page.evaluate(() => window.scrollTo(0, document.body.scrollHeight))
    await expect(page.locator('footer')).toBeVisible()
  })

  test('タブレット表示: スキル管理', async ({ page }) => {
    // タブレットサイズに変更
    await page.setViewportSize({ width: 768, height: 1024 })
    
    await page.click('[data-testid="nav-skills"]')
    await expect(page).toHaveURL('/skills')
    
    // タブレット用レイアウトの確認
    await expect(page.locator('[data-testid="add-skill-button"]')).toBeVisible()
    await expect(page.locator('[data-testid="skill-search-input"]')).toBeVisible()
    
    // グリッドレイアウトの確認
    const skillsGrid = page.locator('[data-testid="skills-grid"]')
    await expect(skillsGrid).toHaveCSS('display', 'grid')
  })

  test('デスクトップ表示: 全機能', async ({ page }) => {
    // デスクトップサイズに変更
    await page.setViewportSize({ width: 1280, height: 720 })
    
    // サイドバーナビゲーションの確認
    await expect(page.locator('[data-testid="sidebar"]')).toBeVisible()
    
    // 全ナビゲーション要素の確認
    await expect(page.locator('[data-testid="nav-skills"]')).toBeVisible()
    await expect(page.locator('[data-testid="nav-profile"]')).toBeVisible()
    await expect(page.locator('[data-testid="nav-career"]')).toBeVisible()
    await expect(page.locator('[data-testid="nav-work"]')).toBeVisible()
    await expect(page.locator('[data-testid="nav-training"]')).toBeVisible()
    await expect(page.locator('[data-testid="nav-reports"]')).toBeVisible()
    
    // レイアウトの確認
    const mainLayout = page.locator('[data-testid="main-layout"]')
    await expect(mainLayout).toHaveCSS('display', 'flex')
  })
})
```

### 5.4 アクセシビリティテスト

#### tests/e2e/accessibility.spec.ts
```typescript
import { test, expect } from '@playwright/test'
import { injectAxe, checkA11y } from '@axe-core/playwright'

test.describe('アクセシビリティ（WCAG 2.1 AA準拠）', () => {
  test.beforeEach(async ({ page }) => {
    // axe-core の注入
    await injectAxe(page)
  })

  test('ログインページのアクセシビリティ', async ({ page }) => {
    await page.goto('/auth/signin')
    
    // アクセシビリティチェック
    await checkA11y(page, null, {
      detailedReport: true,
      detailedReportOptions: { html: true }
    })
    
    // キーボードナビゲーション
    await page.keyboard.press('Tab')
    await expect(page.locator('input[name="email"]')).toBeFocused()
    
    await page.keyboard.press('Tab')
    await expect(page.locator('input[name="password"]')).toBeFocused()
    
    await page.keyboard.press('Tab')
    await expect(page.locator('button[type="submit"]')).toBeFocused()
  })

  test('ダッシュボードのアクセシビリティ', async ({ page }) => {
    // サインイン
    await page.goto('/auth/signin')
    await page.fill('input[name="email"]', 'test@example.com')
    await page.fill('input[name="password"]', 'password123')
    await page.click('button[type="submit"]')
    await expect(page).toHaveURL('/dashboard')
    
    // アクセシビリティチェック
    await checkA11y(page, null, {
      rules: {
        'color-contrast': { enabled: true },
        'keyboard-navigation': { enabled: true },
        'focus-management': { enabled: true }
      }
    })
    
    // ARIAラベルの確認
    const skillSummary = page.locator('[data-testid="skill-summary-card"]')
    await expect(skillSummary).toHaveAttribute('aria-label')
    
    // ランドマークの確認
    await expect(page.locator('main')).toHaveAttribute('role', 'main')
    await expect(page.locator('nav')).toHaveAttribute('role', 'navigation')
  })

  test('キーボード操作のみでの操作', async ({ page }) => {
    await page.goto('/auth/signin')
    
    // キーボードのみでログイン
    await page.keyboard.press('Tab') // email input
    await page.keyboard.type('test@example.com')
    
    await page.keyboard.press('Tab') // password input
    await page.keyboard.type('password123')
    
    await page.keyboard.press('Tab') // sign in button
    await page.keyboard.press('Enter')
    
    // ダッシュボードに遷移
    await expect(page).toHaveURL('/dashboard')
    
    // キーボードナビゲーションでスキル管理へ
    await page.keyboard.press('Tab') // skip to main navigation
    await page.keyboard.press('ArrowDown') // skills link
    await page.keyboard.press('Enter')
    
    await expect(page).toHaveURL('/skills')
  })
})
```

### 5.5 パフォーマンステスト

#### tests/e2e/performance.spec.ts
```typescript
import { test, expect } from '@playwright/test'

test.describe('パフォーマンステスト', () => {
  test('ページロード時間測定', async ({ page }) => {
    // ログインページのロード時間
    const loginStartTime = Date.now()
    await page.goto('/auth/signin')
    const loginLoadTime = Date.now() - loginStartTime
    
    expect(loginLoadTime).toBeLessThan(3000) // 3秒以内
    
    // ダッシュボードのロード時間
    await page.fill('input[name="email"]', 'test@example.com')
    await page.fill('input[name="password"]', 'password123')
    await page.click('button[type="submit"]')
    
    const dashboardStartTime = Date.now()
    await expect(page.locator('[data-testid="welcome-message"]')).toBeVisible()
    const dashboardLoadTime = Date.now() - dashboardStartTime
    
    expect(dashboardLoadTime).toBeLessThan(2000) // 2秒以内
  })

  test('API レスポンス時間測定', async ({ page }) => {
    // サインイン
    await page.goto('/auth/signin')
    await page.fill('input[name="email"]', 'test@example.com')
    await page.fill('input[name="password"]', 'password123')
    await page.click('button[type="submit"]')
    
    // スキル管理ページに移動
    await page.click('[data-testid="nav-skills"]')
    
    // スキル一覧取得のレスポンス時間
    const apiStartTime = Date.now()
    const response = await page.waitForResponse(/\/api\/skills/)
    const apiResponseTime = Date.now() - apiStartTime
    
    expect(response.status()).toBe(200)
    expect(apiResponseTime).toBeLessThan(1000) // 1秒以内
  })

  test('大量データでのパフォーマンス', async ({ page }) => {
    // サインイン
    await page.goto('/auth/signin')
    await page.fill('input[name="email"]', 'test@example.com')
    await page.fill('input[name="password"]', 'password123')
    await page.click('button[type="submit"]')
    
    await page.click('[data-testid="nav-skills"]')
    
    // 大量スキルデータの表示性能
    const startTime = Date.now()
    
    // 100件のスキルデータを想定
    await page.evaluate(() => {
      // モックデータで大量データをシミュレート
      const mockSkills = Array.from({ length: 100 }, (_, i) => ({
        id: i + 1,
        name: `Skill ${i + 1}`,
        category: 'テストカテゴリ',
        level: '○'
      }))
      
      // データを DOM に反映（実際の実装に合わせて調整）
      window.postMessage({ type: 'LOAD_MOCK_SKILLS', skills: mockSkills }, '*')
    })
    
    await page.waitForLoadState('networkidle')
    const renderTime = Date.now() - startTime
    
    expect(renderTime).toBeLessThan(5000) // 5秒以内
    
    // スクロール性能の確認
    const scrollStartTime = Date.now()
    await page.evaluate(() => window.scrollTo(0, document.body.scrollHeight))
    const scrollTime = Date.now() - scrollStartTime
    
    expect(scrollTime).toBeLessThan(1000) // 1秒以内
  })
})
```

---

## 6. テスト実行・レポート

### 6.1 テスト実行コマンド（Playwright Agents 対応）

#### package.json スクリプト設定
```json
{
  "scripts": {
    "test:e2e": "playwright test",
    "test:e2e:headed": "playwright test --headed",
    "test:e2e:debug": "playwright test --debug",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:report": "playwright show-report",
    "test:e2e:chrome": "playwright test --project=chromium",
    "test:e2e:firefox": "playwright test --project=firefox",
    "test:e2e:safari": "playwright test --project=webkit",
    "test:e2e:mobile": "playwright test --project='Mobile Chrome'",
    "test:e2e:accessibility": "playwright test tests/e2e/accessibility.spec.ts",
    "test:e2e:performance": "playwright test tests/e2e/performance.spec.ts",
    "test:e2e:ci": "playwright test --reporter=github",

    "test:agents:plan": "playwright agent planner",
    "test:agents:generate": "playwright agent generator",
    "test:agents:heal": "playwright agent healer --auto-fix",
    "test:agents:heal:suggest": "playwright agent healer --suggest-only",
    "test:agents:workflow": "npm run test:agents:plan && npm run test:agents:generate && npm run test:agents:heal"
  }
}
```

#### 基本的なテスト実行

```bash
# 通常のE2Eテスト実行
npm run test:e2e

# ヘッドレスモードでテスト実行
npm run test:e2e:headed

# UIモードでテスト実行（推奨: インタラクティブ）
npm run test:e2e:ui

# デバッグモードでテスト実行
npm run test:e2e:debug
```

#### Playwright Agents を使用したテスト実行

```bash
# 1. テスト計画の生成
npm run test:agents:plan -- \
  --story "スキル管理機能のCRUD操作" \
  --output tests/plans/skill-crud.md

# 2. テストコードの生成
npm run test:agents:generate -- \
  --plan tests/plans/skill-crud.md \
  --output tests/e2e/skill-crud-generated.spec.ts

# 3. テスト実行と自動修復
npm run test:agents:heal -- --test tests/e2e/

# 4. 修復提案のみ取得（自動適用しない）
npm run test:agents:heal:suggest -- --test tests/e2e/skills.spec.ts

# 5. 完全なワークフロー実行
npm run test:agents:workflow
```

#### CI/CD での実行

```bash
# GitHub Actions でのテスト実行
npm run test:e2e:ci

# Playwright Agents を使用した自動修復付きテスト
npx playwright agent healer --auto-fix --test tests/e2e/ --max-attempts=3
```

### 6.2 CI/CD統合

#### .github/workflows/e2e-tests.yml
```yaml
name: E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  e2e-tests:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: srms_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5433:5432
    
    steps:
    - uses: actions/checkout@v3
    
    - uses: actions/setup-node@v3
      with:
        node-version: 18
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    
    - name: Setup test database
      run: |
        npm run db:migrate:test
        npm run db:seed:test
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5433/srms_test
    
    - name: Run E2E tests
      run: npm run test:e2e:ci
      env:
        BASE_URL: http://localhost:3000
        DATABASE_URL: postgresql://test_user:test_password@localhost:5433/srms_test
        NEXTAUTH_SECRET: test-secret-key
        TEST_USER_EMAIL: test@example.com
        TEST_USER_PASSWORD: password123
    
    - uses: actions/upload-artifact@v3
      if: always()
      with:
        name: playwright-report
        path: test-results/
        retention-days: 30
```

---

## 7. まとめ

### 7.1 E2Eテストの価値

- **ユーザー体験の保証**: 実際のユーザー操作フローでの動作確認
- **統合品質の確認**: Next.js + PostgreSQL + NextAuth.js の完全な統合動作
- **リグレッション防止**: 新機能追加時の既存機能への影響確認
- **クロスブラウザ対応**: 複数ブラウザでの一貫した動作保証

### 7.2 Playwright Agents による革新

#### 7.2.1 テスト自動化の進化

**従来のアプローチ**:
- 手動でテスト計画を作成
- 手動でテストコードを実装
- テスト失敗時に手動でデバッグ・修正
- UI変更時に手動でテストを更新

**Playwright Agents のアプローチ**:
- **Planner**: AI がユーザーストーリーから自動的にテスト計画を生成
- **Generator**: AI が Markdown 計画から実行可能なテストコードを生成
- **Healer**: AI がテスト失敗を自動分析し、修復を提案・適用
- **セルフヒーリング**: UI変更時にテストが自動的に適応

#### 7.2.2 実現される効果

| 効果カテゴリ | 具体的な効果 | 数値目標 |
|------------|------------|---------|
| **工数削減** | テスト作成時間の短縮 | 87.5%削減 |
| **品質向上** | テストカバレッジの向上 | 40%増加 |
| **メンテナンス性** | テスト保守コストの削減 | 80%削減 |
| **信頼性** | テストの安定性向上 | 失敗率50%減少 |
| **速度** | テスト実行サイクルの高速化 | 30%短縮 |

### 7.3 導入ロードマップ

#### Phase 1: 基礎導入（Week 1-2）
- Playwright Agents のセットアップ
- 既存テストケースの1つをサンプルとして AI 生成
- チームへの教育とトレーニング

#### Phase 2: 段階的展開（Week 3-4）
- 新規機能のテストを Planner + Generator で生成
- Healer による既存テストの自動修復を試行
- 効果測定とフィードバック収集

#### Phase 3: 全面展開（Week 5-6）
- 全テストケースに Playwright Agents を適用
- CI/CD パイプラインへの統合
- 継続的な改善サイクルの確立

### 7.4 継続的改善

- **テストケースの拡充**: AI支援による迅速なテストケース追加
- **パフォーマンス監視**: 継続的なパフォーマンス測定と改善
- **アクセシビリティ向上**: WCAG準拠レベルの継続的向上
- **テスト効率化**: AI による実行時間短縮とメンテナンス性向上
- **知識蓄積**: AI生成テストから学ぶベストプラクティス

### 7.5 次のステップ

1. **Playwright Agents のセットアップ**: `npx playwright init-agents --loop=claude`
2. **最初のテスト計画生成**: 既存機能のテスト計画を AI で生成してみる
3. **テストコード生成**: 生成された計画からテストコードを自動生成
4. **効果測定**: 従来の手動作成との比較分析
5. **チーム共有**: 学んだベストプラクティスをチームで共有

このE2Eテスト実装ガイドと Playwright Agents により、年間スキル報告書WEB化PJTの品質保証を革新的に実現します。
