# ユニットテスト実装ガイド（続き）

---

## 5. バリデーション・ユーティリティテスト（続き）

### 5.1 バリデーション関数テスト

#### src/utils/__tests__/validation.test.ts
```typescript
import { describe, it, expect } from 'vitest'
import {
  validateEmail,
  validatePassword,
  validateSkillLevel,
  validateRequired,
  validateLength,
  validateDate
} from '../validation'

describe('バリデーション関数', () => {
  describe('validateEmail', () => {
    it('正常系: 有効なメールアドレス', () => {
      const validEmails = [
        'user@example.com',
        'test.user@domain.co.jp',
        'user+tag@example.org',
        'user123@test-domain.com'
      ]
      
      validEmails.forEach(email => {
        expect(validateEmail(email)).toBe(true)
      })
    })

    it('異常系: 無効なメールアドレス', () => {
      const invalidEmails = [
        'invalid-email',
        '@example.com',
        'user@',
        'user..name@example.com',
        'user@.com',
        ''
      ]
      
      invalidEmails.forEach(email => {
        expect(validateEmail(email)).toBe(false)
      })
    })
  })

  describe('validatePassword', () => {
    it('正常系: 有効なパスワード', () => {
      const validPasswords = [
        'Password123!',
        'MySecure@Pass1',
        'Test#Password2024'
      ]
      
      validPasswords.forEach(password => {
        expect(validatePassword(password)).toBe(true)
      })
    })

    it('異常系: 無効なパスワード', () => {
      const invalidPasswords = [
        'short',           // 短すぎる
        'password',        // 大文字なし
        'PASSWORD',        // 小文字なし
        'Password',        // 数字なし
        'Password123',     // 特殊文字なし
        ''
      ]
      
      invalidPasswords.forEach(password => {
        expect(validatePassword(password)).toBe(false)
      })
    })
  })

  describe('validateSkillLevel', () => {
    it('正常系: 有効なスキルレベル', () => {
      const validLevels = ['×', '△', '○', '◎']
      
      validLevels.forEach(level => {
        expect(validateSkillLevel(level)).toBe(true)
      })
    })

    it('異常系: 無効なスキルレベル', () => {
      const invalidLevels = ['A', 'B', 'C', '1', '2', '', null, undefined]
      
      invalidLevels.forEach(level => {
        expect(validateSkillLevel(level)).toBe(false)
      })
    })
  })

  describe('validateRequired', () => {
    it('正常系: 値が存在する', () => {
      expect(validateRequired('test')).toBe(true)
      expect(validateRequired('0')).toBe(true)
      expect(validateRequired(0)).toBe(true)
      expect(validateRequired(false)).toBe(true)
    })

    it('異常系: 値が存在しない', () => {
      expect(validateRequired('')).toBe(false)
      expect(validateRequired('   ')).toBe(false)
      expect(validateRequired(null)).toBe(false)
      expect(validateRequired(undefined)).toBe(false)
    })
  })

  describe('validateLength', () => {
    it('正常系: 長さが範囲内', () => {
      expect(validateLength('test', 1, 10)).toBe(true)
      expect(validateLength('hello', 5, 5)).toBe(true)
      expect(validateLength('', 0, 5)).toBe(true)
    })

    it('異常系: 長さが範囲外', () => {
      expect(validateLength('test', 5, 10)).toBe(false)
      expect(validateLength('very long text', 1, 5)).toBe(false)
    })
  })

  describe('validateDate', () => {
    it('正常系: 有効な日付形式', () => {
      expect(validateDate('2025-05-29')).toBe(true)
      expect(validateDate('2024-12-31')).toBe(true)
      expect(validateDate('2020-01-01')).toBe(true)
    })

    it('異常系: 無効な日付形式', () => {
      expect(validateDate('2025/05/29')).toBe(false)
      expect(validateDate('29-05-2025')).toBe(false)
      expect(validateDate('invalid-date')).toBe(false)
      expect(validateDate('')).toBe(false)
    })
  })
})
```

### 5.2 ユーティリティ関数テスト

#### src/utils/__tests__/formatters.test.ts
```typescript
import { describe, it, expect } from 'vitest'
import {
  formatDate,
  formatSkillLevel,
  formatExperience,
  formatFileSize,
  formatCurrency
} from '../formatters'

describe('フォーマッター関数', () => {
  describe('formatDate', () => {
    it('正常系: 日付文字列のフォーマット', () => {
      expect(formatDate('2025-05-29')).toBe('2025年5月29日')
      expect(formatDate('2024-12-01')).toBe('2024年12月1日')
    })

    it('正常系: Dateオブジェクトのフォーマット', () => {
      const date = new Date('2025-05-29')
      expect(formatDate(date)).toBe('2025年5月29日')
    })

    it('異常系: 無効な日付', () => {
      expect(formatDate('invalid-date')).toBe('無効な日付')
      expect(formatDate('')).toBe('無効な日付')
    })
  })

  describe('formatSkillLevel', () => {
    it('正常系: スキルレベルの表示名変換', () => {
      expect(formatSkillLevel('×')).toBe('未経験')
      expect(formatSkillLevel('△')).toBe('基礎レベル')
      expect(formatSkillLevel('○')).toBe('実務レベル')
      expect(formatSkillLevel('◎')).toBe('エキスパート')
    })

    it('異常系: 無効なレベル', () => {
      expect(formatSkillLevel('A')).toBe('不明')
      expect(formatSkillLevel('')).toBe('不明')
    })
  })

  describe('formatExperience', () => {
    it('正常系: 経験年数のフォーマット', () => {
      expect(formatExperience(1)).toBe('1年')
      expect(formatExperience(3.5)).toBe('3年6ヶ月')
      expect(formatExperience(0.5)).toBe('6ヶ月')
    })

    it('境界値: ゼロ年', () => {
      expect(formatExperience(0)).toBe('未経験')
    })
  })

  describe('formatFileSize', () => {
    it('正常系: ファイルサイズのフォーマット', () => {
      expect(formatFileSize(1024)).toBe('1.0 KB')
      expect(formatFileSize(1048576)).toBe('1.0 MB')
      expect(formatFileSize(1073741824)).toBe('1.0 GB')
    })

    it('境界値: 小さなサイズ', () => {
      expect(formatFileSize(512)).toBe('512 B')
      expect(formatFileSize(0)).toBe('0 B')
    })
  })
})
```

---

## 6. カスタムフック・状態管理テスト

### 6.1 カスタムフックテスト

#### src/hooks/__tests__/useAuth.test.ts
```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest'
import { renderHook, act } from '@testing-library/react'
import { useAuth } from '../useAuth'
import { AuthService } from '@/services/AuthService'

// AuthService をモック
vi.mock('@/services/AuthService')
const mockAuthService = vi.mocked(AuthService)

describe('useAuth', () => {
  beforeEach(() => {
    vi.clearAllMocks()
  })

  it('正常系: 初期状態', () => {
    const { result } = renderHook(() => useAuth())
    
    expect(result.current.user).toBeNull()
    expect(result.current.isAuthenticated).toBe(false)
    expect(result.current.isLoading).toBe(false)
  })

  it('正常系: ログイン成功', async () => {
    const mockUser = {
      id: 1,
      name: 'テストユーザー',
      email: 'user@example.com'
    }
    
    mockAuthService.prototype.login.mockResolvedValue({
      success: true,
      user: mockUser,
      token: 'mock-token'
    })
    
    const { result } = renderHook(() => useAuth())
    
    await act(async () => {
      await result.current.login('user@example.com', 'password')
    })
    
    expect(result.current.user).toEqual(mockUser)
    expect(result.current.isAuthenticated).toBe(true)
    expect(result.current.error).toBeNull()
  })

  it('異常系: ログイン失敗', async () => {
    mockAuthService.prototype.login.mockResolvedValue({
      success: false,
      error: '認証に失敗しました'
    })
    
    const { result } = renderHook(() => useAuth())
    
    await act(async () => {
      await result.current.login('user@example.com', 'wrongpassword')
    })
    
    expect(result.current.user).toBeNull()
    expect(result.current.isAuthenticated).toBe(false)
    expect(result.current.error).toBe('認証に失敗しました')
  })

  it('正常系: ログアウト', async () => {
    const { result } = renderHook(() => useAuth())
    
    // 先にログイン状態にする
    await act(async () => {
      result.current.setUser({
        id: 1,
        name: 'テストユーザー',
        email: 'user@example.com'
      })
    })
    
    await act(async () => {
      await result.current.logout()
    })
    
    expect(result.current.user).toBeNull()
    expect(result.current.isAuthenticated).toBe(false)
  })
})
```

### 6.2 状態管理テスト（Redux）

#### src/store/__tests__/skillSlice.test.ts
```typescript
import { describe, it, expect } from 'vitest'
import { configureStore } from '@reduxjs/toolkit'
import skillReducer, {
  addSkill,
  updateSkill,
  deleteSkill,
  setSkills,
  setLoading,
  setError
} from '../skillSlice'
import type { Skill } from '@/types/skill'

describe('skillSlice', () => {
  const initialState = {
    skills: [],
    loading: false,
    error: null
  }

  const mockSkills: Skill[] = [
    {
      id: 1,
      name: 'JavaScript',
      category: 'プログラミング言語',
      level: '○',
      experience: '3年'
    },
    {
      id: 2,
      name: 'TypeScript',
      category: 'プログラミング言語',
      level: '◎',
      experience: '2年'
    }
  ]

  it('正常系: 初期状態', () => {
    const state = skillReducer(undefined, { type: 'unknown' })
    expect(state).toEqual(initialState)
  })

  it('正常系: setSkills', () => {
    const state = skillReducer(initialState, setSkills(mockSkills))
    expect(state.skills).toEqual(mockSkills)
  })

  it('正常系: addSkill', () => {
    const newSkill: Skill = {
      id: 3,
      name: 'React',
      category: 'フレームワーク',
      level: '○',
      experience: '2年'
    }
    
    const stateWithSkills = { ...initialState, skills: mockSkills }
    const state = skillReducer(stateWithSkills, addSkill(newSkill))
    
    expect(state.skills).toHaveLength(3)
    expect(state.skills[2]).toEqual(newSkill)
  })

  it('正常系: updateSkill', () => {
    const updatedSkill: Skill = {
      id: 1,
      name: 'JavaScript',
      category: 'プログラミング言語',
      level: '◎',
      experience: '4年'
    }
    
    const stateWithSkills = { ...initialState, skills: mockSkills }
    const state = skillReducer(stateWithSkills, updateSkill(updatedSkill))
    
    expect(state.skills[0]).toEqual(updatedSkill)
  })

  it('正常系: deleteSkill', () => {
    const stateWithSkills = { ...initialState, skills: mockSkills }
    const state = skillReducer(stateWithSkills, deleteSkill(1))
    
    expect(state.skills).toHaveLength(1)
    expect(state.skills.find(s => s.id === 1)).toBeUndefined()
  })

  it('正常系: setLoading', () => {
    const state = skillReducer(initialState, setLoading(true))
    expect(state.loading).toBe(true)
  })

  it('正常系: setError', () => {
    const errorMessage = 'エラーが発生しました'
    const state = skillReducer(initialState, setError(errorMessage))
    expect(state.error).toBe(errorMessage)
  })
})
```

---

## 7. テスト実行・レポート

### 7.1 テスト実行コマンド

```bash
# 基本的なテスト実行
npm run test                    # 全テスト実行
npm run test:watch             # ウォッチモード
npm run test:ui                # UI付きテスト実行

# カバレッジ付きテスト
npm run test:coverage          # カバレッジレポート生成
npm run test:coverage -- --reporter=html  # HTMLレポート

# 特定ファイル・パターンのテスト
npm run test -- AuthService    # AuthService関連のテスト
npm run test -- --grep="ログイン"  # 「ログイン」を含むテスト
npm run test -- src/components # components配下のテスト

# 並列実行・高速化
npm run test -- --threads       # 並列実行
npm run test -- --no-coverage   # カバレッジなしで高速実行
```

### 7.2 カバレッジレポートの確認

#### HTMLレポートの確認
```bash
# カバレッジレポート生成
npm run test:coverage

# HTMLレポートをブラウザで開く
open coverage/index.html  # macOS
start coverage/index.html # Windows
```

#### コマンドラインでの確認
```bash
# テキスト形式でカバレッジ表示
npm run test:coverage -- --reporter=text

# 詳細なカバレッジ情報
npm run test:coverage -- --reporter=text-summary
```

### 7.3 CI/CD統合

#### GitHub Actions設定例
```yaml
# .github/workflows/unit-test.yml
name: Unit Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run unit tests
      run: npm run test:coverage
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
    
    - name: Comment PR with coverage
      if: github.event_name == 'pull_request'
      uses: romeovs/lcov-reporter-action@v0.3.1
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        lcov-file: ./coverage/lcov.info
```

---

## 8. ベストプラクティス

### 8.1 テストコード品質

#### テスト命名規則
```typescript
// ✅ 良い例
describe('AuthService', () => {
  describe('ログイン機能', () => {
    it('正常系: 有効な認証情報でログイン成功', () => {})
    it('異常系: 無効なパスワードでログイン失敗', () => {})
    it('境界値: 空文字列での認証', () => {})
  })
})

// ❌ 悪い例
describe('AuthService', () => {
  it('should login', () => {})
  it('login fails', () => {})
})
```

#### アサーション品質
```typescript
// ✅ 良い例 - 具体的で明確
expect(result.user).toEqual({
  id: 1,
  name: 'テストユーザー',
  email: 'user@example.com'
})

// ❌ 悪い例 - 曖昧
expect(result.user).toBeTruthy()
```

### 8.2 モック戦略

#### 適切なモック使用
```typescript
// ✅ 良い例 - 外部依存のみモック
vi.mock('@/services/ApiClient')
vi.mock('axios')

// ❌ 悪い例 - 過度なモック
vi.mock('@/utils/validation')  // 単純な関数はモック不要
```

#### モックの適切な管理
```typescript
// ✅ 良い例
beforeEach(() => {
  vi.clearAllMocks()  // 各テスト前にモッククリア
})

afterEach(() => {
  vi.restoreAllMocks()  // 元の実装に復元
})
```

### 8.3 テストデータ管理

#### ファクトリー関数の活用
```typescript
// src/test/factories/skillFactory.ts
export const createSkill = (overrides: Partial<Skill> = {}): Skill => ({
  id: 1,
  name: 'JavaScript',
  category: 'プログラミング言語',
  level: '○',
  experience: '3年',
  ...overrides
})

// テストでの使用
const skill = createSkill({ name: 'TypeScript', level: '◎' })
```

### 8.4 パフォーマンス最適化

#### 並列実行の活用
```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    pool: 'threads',
    poolOptions: {
      threads: {
        maxThreads: 4,
        minThreads: 2
      }
    }
  }
})
```

#### 重いテストの分離
```typescript
// 統合テストは別ファイルに分離
// src/test/integration/
// src/test/unit/
```

---

## 9. トラブルシューティング

### 9.1 よくある問題と解決策

#### 問題: テストが不安定（フレーキー）
```typescript
// 解決策: waitForを使用
import { waitFor } from '@testing-library/react'

it('非同期処理のテスト', async () => {
  render(<AsyncComponent />)
  
  await waitFor(() => {
    expect(screen.getByText('読み込み完了')).toBeInTheDocument()
  }, { timeout: 5000 })
})
```

#### 問題: モックが効かない
```typescript
// 解決策: モックの順序を確認
// モックは import より前に記述
vi.mock('@/services/AuthService')
import { AuthService } from '@/services/AuthService'
```

#### 問題: カバレッジが上がらない
```typescript
// 解決策: 除外設定を確認
// vitest.config.ts
coverage: {
  exclude: [
    'node_modules/',
    'src/test/',
    '**/*.d.ts',
    '**/*.config.*'
  ]
}
```

### 9.2 デバッグ方法

#### テストデバッグ
```typescript
// console.log でデバッグ
it('デバッグテスト', () => {
  const result = someFunction()
  console.log('結果:', result)  // デバッグ出力
  expect(result).toBe(expected)
})

// screen.debug() でDOM確認
it('DOM確認', () => {
  render(<Component />)
  screen.debug()  // 現在のDOMを出力
})
```

---

## 10. 改訂履歴

| 版数 | 日付 | 改訂者 | 承認者 | 改訂内容 |
|------|------|-------|-------|----------|
| 1.0 | 2025/5/29 | AI推進チーム | 黒澤 | 初版作成 |

---

**以上**

このユニットテスト実装ガイドにより、プロジェクトの技術スタックに最適化された高品質なユニットテストの実装が可能となり、目標カバレッジ80%以上の達成と継続的な品質向上を実現できます。
