# データベース設計ガイドライン

## エグゼクティブサマリー

この文書は技術スタック非依存のデータベース設計基本原則と品質保証プロセスを定義します。YAML統一フォーマット、自動化ツール統合、段階的品質改善手法、必須セクション管理を提供し、効率的で保守性の高いデータベースシステムの構築を支援します。汎用的な設計原則と品質管理手法に焦点を当て、他プロジェクトでも再利用可能な内容として設計されています。プロジェクト固有の技術スタック詳細は01-project-specific-rules.mdを参照してください。

## 基本設計原則（汎用）

### 1. データベース設計の基本方針
- **正規化原則**: 第3正規形までの適切な正規化
- **非正規化判断**: パフォーマンス要件に基づく戦略的非正規化
- **拡張性考慮**: 将来の機能拡張・データ増加への対応
- **保守性重視**: 理解しやすく変更しやすい設計

### 2. 命名規則の基本原則
- **一貫性**: プロジェクト全体で統一された命名規則
- **可読性**: 目的・内容が分かりやすい名前
- **国際化対応**: 多言語環境での運用を考慮
- **予約語回避**: データベース固有の予約語との衝突回避

### 3. パフォーマンス設計原則
- **インデックス戦略**: 検索パターンに基づく最適なインデックス設計
- **データ分散**: 大量データの効率的な分散・分割
- **キャッシュ戦略**: 頻繁にアクセスされるデータのキャッシュ設計
- **クエリ最適化**: 効率的なクエリパターンの設計

### 4. セキュリティ設計原則
- **データ保護**: 機密情報の暗号化・アクセス制御
- **監査証跡**: 操作履歴・変更履歴の記録
- **権限管理**: 最小権限の原則に基づくアクセス制御
- **データ整合性**: 制約・トリガーによるデータ品質保証

## YAML統一フォーマット（汎用）

### 基本構造とテンプレート

**重要**: 全てのテーブル定義は統一されたYAMLテンプレートをベースとして作成してください。

#### 標準YAMLフォーマット構造

```yaml
# テーブル詳細定義
table_name: "TABLE_NAME"
logical_name: "テーブル論理名"
category: "マスタ系" | "トランザクション系" | "履歴系" | "システム系"
priority: "最高" | "高" | "中" | "低"
requirement_id: "REQ.1-FUNC.1"
comment: "テーブルの概要説明"

# 🔴 改版履歴（絶対省略禁止）
revision_history:
  - version: "1.0.0"
    date: "YYYY-MM-DD"
    author: "開発チーム"
    changes: "初版作成 - テーブルの詳細定義"

# 🔴 テーブル概要・目的（絶対省略禁止）
overview: |
  このテーブルの存在理由と主要な目的を記述。
  
  主な目的：
  - 目的1の詳細説明
  - 目的2の詳細説明
  - 目的3の詳細説明
  
  このテーブルは[システム名]の[機能領域]において重要な役割を果たし、
  [関連機能]との連携により[期待される効果]を実現する。

# カラム定義
columns:
  - name: "column_name"
    type: "DATA_TYPE(LENGTH)"
    nullable: true | false
    primary_key: true | false
    unique: true | false
    default: "DEFAULT_VALUE"
    comment: "カラムの説明"
    requirement_id: "REQ.1-FUNC.1"

# インデックス定義
indexes:
  - name: "idx_table_column"
    columns: ["column1", "column2"]
    unique: true | false
    comment: "インデックスの目的・用途"

# 外部キー定義
foreign_keys:
  - name: "fk_table_reference"
    columns: ["column_name"]
    references:
      table: "REFERENCE_TABLE"
      columns: ["reference_column"]
    on_update: "CASCADE" | "RESTRICT" | "SET NULL"
    on_delete: "CASCADE" | "RESTRICT" | "SET NULL"
    comment: "外部キー制約の説明"

# 🔴 特記事項（絶対省略禁止）
notes:
  - "運用・保守に関する重要な注意事項1"
  - "セキュリティ・暗号化に関する考慮事項2"
  - "パフォーマンス・最適化に関する考慮事項3"

# 🔴 業務ルール（絶対省略禁止）
rules:
  - "データの一意性・整合性に関するルール1"
  - "業務制約・ビジネスロジックに関するルール2"
  - "運用ルール・メンテナンス要件に関するルール3"

# サンプルデータ（推奨）
sample_data:
  - column1: "value1"
    column2: "value2"
    column3: "value3"
```

### 🚨 必須セクション - 省略禁止

以下の4つのセクションは品質管理・監査・運用保守の観点から**いかなる場合も省略禁止**です：

| セクション | 目的 | 最低要件 | 省略時のリスク |
|------------|------|----------|----------------|
| 🔴 `revision_history` | 変更履歴の追跡・監査証跡 | 最低1エントリ必須 | 監査不能、変更管理の崩壊 |
| 🔴 `overview` | テーブルの目的・設計意図の明確化 | 最低50文字以上 | 設計意図の喪失、誤用 |
| 🔴 `notes` | 運用・保守に必要な特記事項 | 最低3項目以上 | 運用障害、保守困難化 |
| 🔴 `rules` | 業務ルール・制約の明文化 | 最低3項目以上 | 要件逸脱、整合性喪失 |

### カラム定義の標準属性

| 属性 | 説明 | 必須 | 例 |
|------|------|------|------|
| name | 物理カラム名 | ✅ | "user_id" |
| type | データ型（長さ含む） | ✅ | "VARCHAR(50)", "INTEGER", "TIMESTAMP" |
| nullable | NULL許可フラグ | ✅ | true/false |
| primary_key | 主キーフラグ | ❌ | true/false |
| unique | 一意制約フラグ | ❌ | true/false |
| default | デフォルト値 | ❌ | "CURRENT_TIMESTAMP", "0", "'ACTIVE'" |
| comment | カラム説明 | ✅ | "ユーザー識別子" |
| requirement_id | 要求仕様ID | ✅ | "USR.1-BASE.1" |

## 統合ツールエコシステム

### 自動化ツールの活用

#### 1. YAML検証ツール
- **フォーマット検証**: YAML構文・構造の妥当性チェック
- **必須セクション検証**: 🔴 絶対省略禁止セクションの存在・内容チェック
- **データ型検証**: カラム定義のデータ型・制約の妥当性チェック
- **命名規則検証**: テーブル名・カラム名の命名規則準拠チェック

#### 2. 自動生成ツール
- **定義書生成**: YAMLからMarkdown形式の詳細定義書を自動生成
- **DDL生成**: データベース固有のCREATE TABLE文を自動生成
- **サンプルデータ生成**: テスト用INSERT文の自動生成
- **ドキュメント生成**: API仕様書・データ辞書の自動生成

#### 3. 整合性チェックツール
- **テーブル存在整合性**: 全ソース間でのテーブル定義一致確認
- **カラム定義整合性**: YAML ↔ DDL ↔ 定義書の整合性確認
- **外部キー整合性**: 参照関係の妥当性チェック
- **データ型整合性**: データ型・制約の完全一致・互換性チェック

### CI/CD統合

#### Git統合・pre-commitフック
- **自動検証**: コミット前のYAML検証自動実行
- **品質ゲート**: 検証失敗時のコミット拒否
- **継続的品質保証**: 変更時の自動品質チェック

#### 自動化ワークフロー
```bash
# 基本的な開発ワークフロー
# 1. YAMLテンプレートからテーブル定義作成
# 2. 必須セクション検証実行
# 3. 自動生成ツールで定義書・DDL・サンプルデータ生成
# 4. 整合性チェック実行
# 5. Git コミット（pre-commitフックで自動検証）
```

## 品質保証プロセス（汎用）

### 自動チェック項目
- **テーブル存在整合性**: 全ソース間でのテーブル定義一致
- **カラム定義整合性**: データ型・制約の一致
- **外部キー整合性**: 参照関係の妥当性
- **命名規則チェック**: 命名規則の準拠
- **必須セクション確認**: 🔴 絶対省略禁止セクションの存在と内容チェック

### 手動レビュー項目
- **業務要件との整合性**: 機能要件との一致
- **技術スタック対応**: 採用技術との整合性
- **パフォーマンス**: インデックス設計の妥当性
- **セキュリティ**: 暗号化・制約の適切性
- **必須セクション内容確認**: 品質・運用・保守の観点での内容チェック

### 品質指標・成功基準
- **整合性チェック通過率**: 100%維持（必須）
- **要求仕様ID対応率**: 100%（全テーブル・全カラム）
- **命名規則準拠率**: 100%（命名規則）
- **ドキュメント自動生成率**: 95%以上
- **技術スタック整合性**: 100%（設計書と実装の整合性）

## 実践的開発フロー

### 新規テーブル追加の標準フロー
```bash
# 1. 要求仕様ID確認・割当
# 要求仕様書で対応するIDを確認

# 2. テンプレートベースでYAML詳細定義作成
# 統一テンプレートをコピーして作成

# 3. 必須セクション編集
# - 🔴 revision_history: 改版履歴（絶対省略禁止・最低1エントリ）
# - 🔴 overview: テーブルの概要と目的（絶対省略禁止・最低50文字）
# - columns: 業務固有カラム定義
# - indexes: 必要なインデックス
# - foreign_keys: 外部キー関係
# - 🔴 notes: 特記事項・考慮点（絶対省略禁止・最低3項目）
# - 🔴 rules: 業務ルール・制約（絶対省略禁止・最低3項目）
# - sample_data: サンプルデータ（推奨）

# 4. YAML検証実行
# 必須セクション・フォーマット・データ型の検証

# 5. 自動生成実行
# 定義書・DDL・サンプルデータの一括生成

# 6. 整合性チェック
# 全ファイル間の整合性確認

# 7. Git コミット
# pre-commitフックで自動検証実行
```

### 既存テーブル修正の標準フロー
```bash
# 1. 影響範囲調査
# 修正対象テーブルの参照関係・依存関係を確認

# 2. YAML詳細定義修正
# - 🔴 revision_history: 改版履歴を更新（絶対省略禁止・変更内容記録）
# - 🔴 overview: 変更に伴う概要更新（必要に応じて）
# - columns: カラム追加・修正・削除
# - indexes: インデックス追加・修正
# - foreign_keys: 外部キー関係の変更
# - 🔴 notes: 特記事項・考慮点の更新（絶対省略禁止）
# - 🔴 rules: 業務ルール・制約の更新（絶対省略禁止）

# 3. 必須セクション検証
# 変更内容の妥当性確認

# 4. 該当テーブルのみ再生成
# 修正されたテーブルの定義書・DDL・サンプルデータ再生成

# 5. 整合性チェック
# 修正による影響範囲の確認

# 6. 関連テーブルの整合性確認
# 外部キー・参照関係の整合性確認

# 7. Git コミット
# 修正内容と影響範囲を明記してコミット
```

## トラブルシューティング・FAQ

### よくある問題と解決方法

#### 1. 必須セクション不備
```
❌ エラー: 必須セクション 'revision_history' が存在しません
```

**対処法**:
```yaml
# revision_history セクションを追加
revision_history:
  - version: "1.0.0"
    date: "2025-06-21"
    author: "開発チーム"
    changes: "初版作成"
```

#### 2. overview文字数不足
```
❌ エラー: 'overview': 最低50文字以上の説明が必要です (現在: 25文字)
```

**対処法**:
```yaml
# overview を詳細に記述
overview: |
  このテーブルは[具体的な目的]を管理するテーブルです。
  主な目的は、[目的1]、[目的2]、[目的3]の管理であり、
  [システム名]の[機能領域]において重要な役割を果たします。
```

#### 3. 整合性チェックエラー
```
❌ テーブル存在整合性エラー: DDLファイルが存在しません
```

**対処法**:
```bash
# 1. エラー詳細確認
# 整合性チェックツールで詳細確認

# 2. 個別ファイル確認
# YAML・DDL・定義書ファイルの存在確認

# 3. 再生成実行
# 自動生成ツールで不足ファイルを生成

# 4. 再チェック
# 整合性チェックツールで確認
```

#### 4. 外部キー制約エラー
```
❌ 参照先テーブルが存在しません
```

**対処法**:
```bash
# 1. 参照先テーブルの存在確認
# 参照先テーブルの定義・生成状況確認

# 2. 参照先テーブルの生成
# 必要に応じて参照先テーブルを先に生成

# 3. 参照元テーブルの再生成
# 外部キー制約を含むテーブルの再生成

# 4. 外部キー整合性チェック
# 参照関係の妥当性確認
```

### 緊急時対応フロー
```
1. 問題発見
   ↓
2. 影響範囲特定
   - 関連テーブル・機能の確認
   - システム影響度の評価
   ↓
3. 根本原因分析
   - ログ・エラーメッセージの確認
   - 設定・データの確認
   ↓
4. 応急処置
   - サービス継続のための一時対応
   - 関係者通知
   ↓
5. 恒久対策
   - YAML修正
   - 再生成実行
   - 整合性確認
   ↓
6. 再発防止策
   - チェック項目の追加
   - 手順の見直し
   ↓
7. Git コミット
   - 修正内容の記録
   - 影響範囲の明記
```

## 定期メンテナンス指針

### 月次作業
- **全体整合性チェック実行**: 全テーブルの整合性確認
- **新規追加テーブルの品質確認**: 要求仕様IDとの対応確認
- **パフォーマンス監視**: 想定データ量との乖離チェック
- **セキュリティ監査**: 機密情報・暗号化設定の確認

### 四半期作業
- **孤立ファイル・重複ファイルのクリーンアップ**: 不要ファイルの整理
- **パフォーマンス要件の見直し**: 応答時間・データ量の再評価
- **セキュリティ監査**: アクセス権限・暗号化アルゴリズムの見直し
- **アーカイブ実行計画**: データ保持期間・アーカイブ戦略の策定

### 半期作業
- **ツール機能の見直し・改善**: 自動化ツールの機能拡張検討
- **設計方針の更新**: 技術トレンド・業務要件変化への対応
- **アーカイブ実行**: 条件に従ったデータアーカイブ実行
- **災害復旧テスト**: バックアップ・リストア手順の検証

## 関連ドキュメント

### 内部ドキュメント
- **プロジェクト固有ルール**: `01-project-specific-rules.md`
- **コーディング規約**: `02-coding-standards.md`
- **バックエンド設計ガイドライン**: `04-backend-guidelines.md`
- **仕様書準拠・破壊的修正防止**: `07-specification-compliance.md`

### 外部参照
- **データベース設計原則**: 各データベースシステムの公式ドキュメント
- **正規化理論**: データベース理論の基礎文献
- **パフォーマンス最適化**: 各データベースシステムのパフォーマンスガイド

---

このガイドラインに従って、効率的で品質の高いデータベース設計・開発を実現してください。
