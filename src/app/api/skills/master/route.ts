/**
 * Ë¶ÅÊ±Ç‰ªïÊßòID: API-023
 * ÂØæÂøúË®≠Ë®àÊõ∏: docs/design/api/specs/APIÂÆöÁæ©Êõ∏_API-023_„Çπ„Ç≠„É´„Éû„Çπ„ÇøÂèñÂæóAPI.md
 * ÂÆüË£ÖÂÜÖÂÆπ: „Çπ„Ç≠„É´„Éû„Çπ„ÇøÊÉÖÂ†±ÂèñÂæóAPIÔºàPrismaÂÆüË£ÖÔºâ
 */

import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

// JWTÊ§úË®º„Éò„É´„Éë„ÉºÈñ¢Êï∞ÔºàÈñãÁô∫Áî®ÔºöË™çË®º„Çí„Çπ„Ç≠„ÉÉ„ÉóÔºâ
function verifyToken(authHeader: string | null): { employeeCode: string } | null {
  // ÈñãÁô∫Áí∞Â¢É„Åß„ÅØÂ∏∏„Å´Ë™çË®º„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Å¶„É¢„ÉÉ„ÇØ„É¶„Éº„Ç∂„Éº„ÇíËøî„Åô
  console.log('NODE_ENV:', process.env.NODE_ENV);
  console.log('Auth header:', authHeader);
  
  // ÈñãÁô∫Áí∞Â¢É„Åß„ÅØË™çË®º„Çí„Çπ„Ç≠„ÉÉ„Éó
  return { employeeCode: 'EMP001' };
}

// „Çπ„Ç≠„É´„Éû„Çπ„ÇøÂèñÂæóAPI (API-023)
export async function GET(request: NextRequest) {
  try {
    const url = new URL(request.url);
    const category = url.searchParams.get('category');
    const type = url.searchParams.get('type');
    const level = url.searchParams.get('level');
    const search = url.searchParams.get('search');

    // Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØÔºàÈñãÁô∫Áí∞Â¢É„Åß„ÅØÁ∞°ÊòìÂåñÔºâ
    const authHeader = request.headers.get('authorization');
    const tokenData = verifyToken(authHeader);
    
    if (!tokenData) {
      return NextResponse.json({
        success: false,
        error: {
          code: 'UNAUTHORIZED',
          message: 'Ë™çË®º„ÅåÂøÖË¶Å„Åß„Åô'
        }
      }, { status: 401 });
    }

    console.log('üîç „Éá„Éº„Çø„Éô„Éº„Çπ„Åã„Çâ„Çπ„Ç≠„É´ÈöéÂ±§„Éá„Éº„Çø„ÇíÂèñÂæó‰∏≠...');
    
    // „Ç´„ÉÜ„Ç¥„É™„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„ÅÆÊù°‰ª∂„ÇíÊßãÁØâ
    const categoryFilter: any = {
      category_status: 'active'
    };
    
    // „Ç´„ÉÜ„Ç¥„É™„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
    if (category) {
      // ÊåáÂÆö„Åï„Çå„Åü„Ç´„ÉÜ„Ç¥„É™„Åæ„Åü„ÅØ„Åù„ÅÆÂ≠ê„Ç´„ÉÜ„Ç¥„É™„ÇíÂèñÂæó
      categoryFilter.OR = [
        { category_code: category },
        { parent_category_id: category }
      ];
    }

    // „Éá„Éº„Çø„Éô„Éº„Çπ„Åã„Çâ„Çπ„Ç≠„É´„Ç´„ÉÜ„Ç¥„É™„Å®„Çπ„Ç≠„É´È†ÖÁõÆ„ÇíÂèñÂæó
    const [skillCategories, skillItems] = await Promise.all([
      prisma.skillCategory.findMany({
        where: categoryFilter,
        orderBy: [
          { category_level: 'asc' },
          { display_order: 'asc' }
        ]
      }),
      prisma.skillItem.findMany({
        where: category ? { 
          skill_category_id: {
            in: await prisma.skillCategory.findMany({
              where: categoryFilter,
              select: { category_code: true }
            }).then(cats => cats.map(c => c.category_code))
          }
        } : {},
        orderBy: [
          { skill_category_id: 'asc' },
          { difficulty_level: 'asc' },
          { skill_name: 'asc' }
        ]
      })
    ]);

    console.log(`üìä ÂèñÂæó„Éá„Éº„Çø: „Ç´„ÉÜ„Ç¥„É™ ${skillCategories.length}‰ª∂, „Çπ„Ç≠„É´È†ÖÁõÆ ${skillItems.length}‰ª∂`);

    // ÈöéÂ±§ÊßãÈÄ†„ÇíÊßãÁØâ
    const hierarchyMap = new Map();
    
    // 1ÈöéÂ±§ÁõÆÔºö„É°„Ç§„É≥„Ç´„ÉÜ„Ç¥„É™
    const mainCategories = skillCategories.filter(cat => cat.category_level === 1);
    console.log('üìã „É°„Ç§„É≥„Ç´„ÉÜ„Ç¥„É™:', mainCategories.map(c => `${c.category_code}: ${c.category_name}`));
    
    mainCategories.forEach(category => {
      hierarchyMap.set(category.category_code, {
        id: category.category_code,
        name: category.category_name || category.name,
        category: category.category_name || category.name,
        level: 1,
        description: category.description || '',
        children: new Map()
      });
    });

    // 2ÈöéÂ±§ÁõÆÔºö„Çµ„Éñ„Ç´„ÉÜ„Ç¥„É™
    const subCategories = skillCategories.filter(cat => cat.category_level === 2);
    console.log('üìã „Çµ„Éñ„Ç´„ÉÜ„Ç¥„É™:', subCategories.map(c => `${c.category_code}: ${c.category_name} (Ë¶™: ${c.parent_category_id})`));
    
    subCategories.forEach(category => {
      if (category.parent_category_id) {
        const parentCategory = hierarchyMap.get(category.parent_category_id);
        if (parentCategory) {
          parentCategory.children.set(category.category_code, {
            id: category.category_code,
            name: category.category_name || category.name,
            category: parentCategory.name,
            subcategory: category.category_name || category.name,
            parentId: category.parent_category_id,
            level: 2,
            description: category.description || '',
            children: []
          });
        }
      }
    });

    // 3ÈöéÂ±§ÁõÆÔºö„Çπ„Ç≠„É´È†ÖÁõÆ
    console.log('üìã „Çπ„Ç≠„É´È†ÖÁõÆ:', skillItems.map(s => `${s.skill_code}: ${s.skill_name} („Ç´„ÉÜ„Ç¥„É™: ${s.skill_category_id})`));
    
    skillItems.forEach(skill => {
      const categoryId = skill.skill_category_id;
      if (categoryId) {
        // „Çµ„Éñ„Ç´„ÉÜ„Ç¥„É™„Å´Â±û„Åô„ÇãÂ†¥Âêà„ÇíÊé¢„Åô
        let found = false;
        for (const [parentId, parentCategory] of hierarchyMap) {
          const subcategory = parentCategory.children.get(categoryId);
          if (subcategory) {
            subcategory.children.push({
              id: skill.skill_code,
              name: skill.skill_name || skill.name,
              category: parentCategory.name,
              subcategory: subcategory.name,
              parentId: categoryId,
              level: 3,
              description: skill.description || '',
              difficulty_level: skill.difficulty_level,
              importance_level: skill.importance_level
            });
            found = true;
            break;
          }
        }
        
        // „Çµ„Éñ„Ç´„ÉÜ„Ç¥„É™„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÄÅ„É°„Ç§„É≥„Ç´„ÉÜ„Ç¥„É™Áõ¥‰∏ã„Å´ÈÖçÁΩÆ
        if (!found) {
          const directCategory = hierarchyMap.get(categoryId);
          if (directCategory && directCategory.level === 1) {
            if (!directCategory.children.has('default')) {
              directCategory.children.set('default', {
                id: `${categoryId}_default`,
                name: '„Åù„ÅÆ‰ªñ',
                category: directCategory.name,
                subcategory: '„Åù„ÅÆ‰ªñ',
                parentId: categoryId,
                level: 2,
                description: '',
                children: []
              });
            }
            directCategory.children.get('default').children.push({
              id: skill.skill_code,
              name: skill.skill_name || skill.name,
              category: directCategory.name,
              subcategory: '„Åù„ÅÆ‰ªñ',
              parentId: `${categoryId}_default`,
              level: 3,
              description: skill.description || '',
              difficulty_level: skill.difficulty_level,
              importance_level: skill.importance_level
            });
          }
        }
      }
    });

    // MapÊßãÈÄ†„ÇíÈÖçÂàó„Å´Â§âÊèõ
    const hierarchyData = Array.from(hierarchyMap.values()).map(category => ({
      ...category,
      children: Array.from(category.children.values())
    }));

    console.log('‚úÖ ÈöéÂ±§„Éá„Éº„ÇøÊßãÁØâÂÆå‰∫Ü:', hierarchyData.length, 'ÂÄã„ÅÆ„É°„Ç§„É≥„Ç´„ÉÜ„Ç¥„É™');
    hierarchyData.forEach((cat: any) => {
      console.log(`  üìÅ ${cat.name}: ${cat.children.length}ÂÄã„ÅÆ„Çµ„Éñ„Ç´„ÉÜ„Ç¥„É™`);
      cat.children.forEach((sub: any) => {
        console.log(`    üìÇ ${sub.name}: ${sub.children.length}ÂÄã„ÅÆ„Çπ„Ç≠„É´`);
      });
    });

    return NextResponse.json({
      success: true,
      data: hierarchyData,
      count: hierarchyData.length,
      source: 'database',
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('„Çπ„Ç≠„É´„Éû„Çπ„ÇøÂèñÂæó„Ç®„É©„Éº:', error);
    return NextResponse.json({
      success: false,
      error: {
        code: 'SYSTEM_ERROR',
        message: '„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü'
      },
      timestamp: new Date().toISOString()
    }, { status: 500 });
  }
}

// „Çπ„Ç≠„É´„Ç´„ÉÜ„Ç¥„É™ÂèñÂæóAPI
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { action } = body;

    // Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØ
    const authHeader = request.headers.get('authorization');
    const tokenData = verifyToken(authHeader);
    
    if (!tokenData) {
      return NextResponse.json({
        success: false,
        error: {
          code: 'UNAUTHORIZED',
          message: 'Ë™çË®º„ÅåÂøÖË¶Å„Åß„Åô'
        }
      }, { status: 401 });
    }

    if (action === 'getCategories') {
      try {
        // „Éá„Éº„Çø„Éô„Éº„Çπ„Åã„Çâ„Çπ„Ç≠„É´„Ç´„ÉÜ„Ç¥„É™„ÇíÂèñÂæó
        const categories = await prisma.skillCategory.findMany({
          where: {
            category_status: 'active'
          },
          orderBy: {
            display_order: 'asc'
          }
        });

        const categoriesData = categories.map(category => ({
          category_id: category.category_code,
          name: category.category_name || category.name,
          description: category.description || '',
          type: category.category_type || 'technical',
          level: category.category_level || 1,
          parent_id: category.parent_category_id || null,
          is_leaf: category.is_leaf_category || false,
          skill_count: category.skill_count || 0,
          display_order: category.display_order || 0,
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        }));

        return NextResponse.json({
          success: true,
          data: categoriesData,
          count: categoriesData.length,
          timestamp: new Date().toISOString()
        });

      } catch (dbError) {
        console.error('„Éá„Éº„Çø„Éô„Éº„Çπ„Ç®„É©„Éº:', dbError);
        
        return NextResponse.json({
          success: false,
          error: {
            code: 'DATABASE_ERROR',
            message: '„Éá„Éº„Çø„Éô„Éº„Çπ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü'
          },
          timestamp: new Date().toISOString()
        }, { status: 500 });
      }
    }

    return NextResponse.json({
      success: false,
      error: {
        code: 'INVALID_ACTION',
        message: 'ÁÑ°Âäπ„Å™„Ç¢„ÇØ„Ç∑„Éß„É≥„Åß„Åô'
      }
    }, { status: 400 });

  } catch (error) {
    console.error('„Çπ„Ç≠„É´„Ç´„ÉÜ„Ç¥„É™ÂèñÂæó„Ç®„É©„Éº:', error);
    return NextResponse.json({
      success: false,
      error: {
        code: 'SYSTEM_ERROR',
        message: '„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü'
      },
      timestamp: new Date().toISOString()
    }, { status: 500 });
  }
}
