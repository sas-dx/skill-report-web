// RPT.1-EXCEL.1: „É¨„Éù„Éº„Éà„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
'use client';

import React, { useState, useEffect } from 'react';
import { Button } from '@/components/ui/Button';
import { Spinner } from '@/components/ui/Spinner';

interface ReportTemplate {
  id: string;
  name: string;
  description: string;
  category: string;
  format: 'excel' | 'pdf' | 'csv';
  icon: string;
}

interface GeneratedReport {
  id: string;
  name: string;
  generatedAt: string;
  format: string;
  size: string;
  status: 'completed' | 'generating' | 'failed';
  downloadUrl?: string;
}

export function ReportContent() {
  const [isLoading, setIsLoading] = useState(true);
  const [reportTemplates, setReportTemplates] = useState<ReportTemplate[]>([]);
  const [generatedReports, setGeneratedReports] = useState<GeneratedReport[]>([]);
  const [activeTab, setActiveTab] = useState<'templates' | 'history'>('templates');
  const [error, setError] = useState<string | null>(null);
  const [notification, setNotification] = useState<{message: string, type: 'success' | 'error'} | null>(null);

  // „Éá„Éº„Çø„ÅÆÂàùÊúüÂåñ
  useEffect(() => {
    loadData();
  }, []);

  // ÈÄöÁü•„ÅÆËá™ÂãïÈùûË°®Á§∫
  useEffect(() => {
    if (notification) {
      const timer = setTimeout(() => {
        setNotification(null);
      }, 5000); // 5ÁßíÂæå„Å´Ëá™Âãï„ÅßÈùûË°®Á§∫
      return () => clearTimeout(timer);
    }
    return undefined;
  }, [notification]);

  const loadData = async () => {
    setIsLoading(true);
    setError(null);
    try {
      await Promise.all([
        loadReportTemplates(),
        loadGeneratedReports()
      ]);
    } catch (error) {
      console.error('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
      setError('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    } finally {
      setIsLoading(false);
    }
  };

  const loadReportTemplates = async () => {
    try {
      const tenant = localStorage.getItem('tenant');
      const tenantData = tenant ? JSON.parse(tenant) : null;
      
      const response = await fetch('/api/reports/templates', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'x-tenant-id': tenantData?.id || ''
        },
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();
      if (result.success && result.data?.templates) {
        const formattedTemplates = result.data.templates.map((template: any) => ({
          id: template.id,
          name: template.templateName,
          description: template.description,
          category: template.category,
          format: template.format,
          icon: getCategoryIcon(template.category)
        }));
        setReportTemplates(formattedTemplates);
      }
    } catch (error) {
      console.error('„É¨„Éù„Éº„Éà„ÉÜ„É≥„Éó„É¨„Éº„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
    }
  };

  const loadGeneratedReports = async () => {
    try {
      const tenant = localStorage.getItem('tenant');
      const tenantData = tenant ? JSON.parse(tenant) : null;
      
      const response = await fetch('/api/reports/history', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'x-tenant-id': tenantData?.id || ''
        },
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();
      if (result.success && result.data?.reports) {
        const formattedReports = result.data.reports.map((report: any) => ({
          id: report.id,
          name: report.title,
          generatedAt: report.completedAt ? new Date(report.completedAt).toLocaleString('ja-JP') : 'Âá¶ÁêÜ‰∏≠',
          format: report.format.toUpperCase(),
          size: formatFileSize(report.fileSize),
          status: mapStatus(report.status),
          downloadUrl: report.status === 'COMPLETED' ? `/api/reports/${report.id}/download` : undefined
        }));
        setGeneratedReports(formattedReports);
      }
    } catch (error) {
      console.error('ÁîüÊàê„É¨„Éù„Éº„ÉàÂ±•Ê≠¥Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
    }
  };

  const getCategoryIcon = (category: string): string => {
    const iconMap: { [key: string]: string } = {
      '„Çπ„Ç≠„É´ÁÆ°ÁêÜ': 'üìä',
      'Á†î‰øÆÁÆ°ÁêÜ': 'üéì',
      '„Ç≠„É£„É™„Ç¢ÁÆ°ÁêÜ': 'üéØ',
      '‰ΩúÊ•≠ÁÆ°ÁêÜ': 'üìà',
      'ÂàÜÊûê': 'üó∫Ô∏è'
    };
    return iconMap[category] || 'üìÑ';
  };

  const formatFileSize = (bytes: number | null): string => {
    if (!bytes) return '';
    const sizes = ['B', 'KB', 'MB', 'GB'];
    if (bytes === 0) return '0 B';
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
  };

  const mapStatus = (status: string): 'completed' | 'generating' | 'failed' => {
    switch (status) {
      case 'COMPLETED': return 'completed';
      case 'PENDING':
      case 'PROCESSING': return 'generating';
      case 'FAILED':
      case 'ERROR': return 'failed';
      default: return 'generating';
    }
  };

  const handleGenerateReport = async (templateId: string) => {
    try {
      const template = reportTemplates.find(t => t.id === templateId);
      if (!template) {
        throw new Error('„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
      }

      const tenant = localStorage.getItem('tenant');
      const tenantData = tenant ? JSON.parse(tenant) : null;
      
      const response = await fetch('/api/reports/generate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'x-tenant-id': tenantData?.id || ''
        },
        body: JSON.stringify({
          templateId,
          reportTitle: `${template.name}_${new Date().toLocaleDateString('ja-JP')}`,
          parameters: {
            // „Éá„Éï„Ç©„É´„Éà„Éë„É©„É°„Éº„ÇøÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ë™øÊï¥Ôºâ
            startDate: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
            endDate: new Date().toISOString().split('T')[0]
          }
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();
      if (result.success) {
        // ÁîüÊàê„É™„ÇØ„Ç®„Çπ„ÉàÊàêÂäü„ÅÆÈÄöÁü•
        setNotification({
          message: '„É¨„Éù„Éº„ÉàÁîüÊàê„É™„ÇØ„Ç®„Çπ„Éà„ÇíÂèó„Åë‰ªò„Åë„Åæ„Åó„Åü„ÄÇÁîüÊàê„ÅåÂÆå‰∫ÜÊ¨°Á¨¨„ÄÅÂ±•Ê≠¥„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ',
          type: 'success'
        });
        
        // Â±•Ê≠¥„ÇíÂÜçË™≠„ÅøËæº„Åø
        await loadGeneratedReports();
      } else {
        throw new Error(result.error?.message || '„É¨„Éù„Éº„ÉàÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      }
    } catch (error) {
      console.error('„É¨„Éù„Éº„ÉàÁîüÊàê„Ç®„É©„Éº:', error);
      setNotification({
        message: '„É¨„Éù„Éº„ÉàÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ',
        type: 'error'
      });
    }
  };

  const handleDownload = (report: GeneratedReport) => {
    if (report.downloadUrl && report.status === 'completed') {
      // „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„É™„É≥„ÇØ„ÇíÈñã„Åè
      const link = document.createElement('a');
      link.href = report.downloadUrl;
      link.download = report.name;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  };

  const handleDeleteReport = async (reportId: string) => {
    if (!confirm('„Åì„ÅÆ„É¨„Éù„Éº„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
      return;
    }

    try {
      const tenant = localStorage.getItem('tenant');
      const tenantData = tenant ? JSON.parse(tenant) : null;
      
      const response = await fetch(`/api/reports/${reportId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'x-tenant-id': tenantData?.id || ''
        },
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();
      if (result.success) {
        setNotification({
          message: '„É¨„Éù„Éº„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ',
          type: 'success'
        });
        // Â±•Ê≠¥„ÇíÂÜçË™≠„ÅøËæº„Åø
        await loadGeneratedReports();
      } else {
        throw new Error(result.error?.message || '„É¨„Éù„Éº„ÉàÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      }
    } catch (error) {
      console.error('„É¨„Éù„Éº„ÉàÂâäÈô§„Ç®„É©„Éº:', error);
      setNotification({
        message: '„É¨„Éù„Éº„ÉàÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ',
        type: 'error'
      });
    }
  };

  const getFormatBadge = (format: string) => {
    const formatConfig = {
      excel: { label: 'Excel', className: 'bg-green-100 text-green-800' },
      pdf: { label: 'PDF', className: 'bg-red-100 text-red-800' },
      csv: { label: 'CSV', className: 'bg-blue-100 text-blue-800' }
    };

    const config = formatConfig[format.toLowerCase() as keyof typeof formatConfig] || 
                   { label: format, className: 'bg-gray-100 text-gray-800' };
    
    return (
      <span className={`px-2 py-1 rounded-full text-xs font-medium ${config.className}`}>
        {config.label}
      </span>
    );
  };

  const getStatusBadge = (status: string) => {
    const statusConfig = {
      completed: { label: 'ÂÆå‰∫Ü', className: 'bg-green-100 text-green-800' },
      generating: { label: 'ÁîüÊàê‰∏≠', className: 'bg-blue-100 text-blue-800' },
      failed: { label: 'Â§±Êïó', className: 'bg-red-100 text-red-800' }
    };

    const config = statusConfig[status as keyof typeof statusConfig];
    return (
      <span className={`px-2 py-1 rounded-full text-xs font-medium ${config.className}`}>
        {config.label}
      </span>
    );
  };

  return (
    <div className="p-6">
      {/* „Éö„Éº„Ç∏„Çø„Ç§„Éà„É´ */}
      <div className="mb-6">
        <h1 className="text-2xl font-bold text-gray-900">„É¨„Éù„Éº„ÉàÁÆ°ÁêÜ</h1>
        <p className="text-gray-600 mt-1">ÂêÑÁ®Æ„É¨„Éù„Éº„Éà„ÅÆÁîüÊàê„Å®„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÇíË°å„ÅÑ„Åæ„Åô</p>
      </div>

      {/* ÈÄöÁü•Ë°®Á§∫ */}
      {notification && (
        <div className={`mb-6 p-4 rounded-md ${
          notification.type === 'success' 
            ? 'bg-green-100 border border-green-400 text-green-700' 
            : 'bg-red-100 border border-red-400 text-red-700'
        }`}>
          <div className="flex justify-between items-center">
            <span>{notification.message}</span>
            <button
              onClick={() => setNotification(null)}
              className="ml-3 text-lg font-semibold leading-none"
            >
              √ó
            </button>
          </div>
        </div>
      )}

      {/* „Ç®„É©„ÉºË°®Á§∫ */}
      {error && (
        <div className="mb-6 p-4 rounded-md bg-red-100 border border-red-400 text-red-700">
          <div className="flex justify-between items-center">
            <span>{error}</span>
            <button
              onClick={() => setError(null)}
              className="ml-3 text-lg font-semibold leading-none"
            >
              √ó
            </button>
          </div>
        </div>
      )}

      {/* „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */}
      <div className="mb-6">
        <div className="border-b border-gray-200">
          <nav className="-mb-px flex space-x-8">
            <button
              onClick={() => setActiveTab('templates')}
              className={`py-2 px-1 border-b-2 font-medium text-sm ${
                activeTab === 'templates'
                  ? 'border-blue-500 text-blue-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
              }`}
            >
              „É¨„Éù„Éº„Éà„ÉÜ„É≥„Éó„É¨„Éº„Éà
            </button>
            <button
              onClick={() => setActiveTab('history')}
              className={`py-2 px-1 border-b-2 font-medium text-sm ${
                activeTab === 'history'
                  ? 'border-blue-500 text-blue-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
              }`}
            >
              ÁîüÊàêÂ±•Ê≠¥
            </button>
          </nav>
        </div>
      </div>

      {/* „É¨„Éù„Éº„Éà„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çø„Éñ */}
      {activeTab === 'templates' && (
        <div>
          {isLoading ? (
            <div className="text-center py-12">
              <Spinner size="lg" />
              <p className="text-gray-600 mt-4">„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
            </div>
          ) : reportTemplates.length === 0 ? (
            <div className="text-center py-12">
              <div className="text-6xl mb-4">üìä</div>
              <h3 className="text-lg font-medium text-gray-900 mb-2">„É¨„Éù„Éº„Éà„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</h3>
              <p className="text-gray-500">Âà©Áî®ÂèØËÉΩ„Å™„É¨„Éù„Éº„Éà„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
            </div>
          ) : (
            /* „Ç´„ÉÜ„Ç¥„É™Âà•„Ç∞„É™„ÉÉ„ÉâË°®Á§∫ */
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {reportTemplates.map((template) => (
                <div key={template.id} className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
                  <div className="flex items-start justify-between mb-4">
                    <div className="flex items-center">
                      <span className="text-2xl mr-3">{template.icon}</span>
                      <div>
                        <h3 className="text-lg font-semibold text-gray-900">{template.name}</h3>
                        <p className="text-sm text-gray-500">{template.category}</p>
                      </div>
                    </div>
                    {getFormatBadge(template.format)}
                  </div>
                  
                  <p className="text-gray-600 text-sm mb-4">{template.description}</p>
                  
                  <Button
                    onClick={() => handleGenerateReport(template.id)}
                    variant="primary"
                    disabled={isLoading}
                    className="w-full"
                  >
                    „É¨„Éù„Éº„ÉàÁîüÊàê
                  </Button>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* ÁîüÊàêÂ±•Ê≠¥„Çø„Éñ */}
      {activeTab === 'history' && (
        <div>
          {isLoading ? (
            <div className="text-center py-12">
              <Spinner size="lg" />
              <p className="text-gray-600 mt-4">Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
            </div>
          ) : generatedReports.length === 0 ? (
            <div className="text-center py-12">
              <div className="text-6xl mb-4">üìÇ</div>
              <h3 className="text-lg font-medium text-gray-900 mb-2">ÁîüÊàêÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</h3>
              <p className="text-gray-500">„Åæ„Å†„É¨„Éù„Éº„Éà„ÅåÁîüÊàê„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åã„Çâ„É¨„Éù„Éº„Éà„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
            </div>
          ) : (
            <div className="bg-white rounded-lg shadow">
              <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        „É¨„Éù„Éº„ÉàÂêç
                      </th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        ÁîüÊàêÊó•ÊôÇ
                      </th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        ÂΩ¢Âºè
                      </th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        „Çµ„Ç§„Ç∫
                      </th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        „Çπ„ÉÜ„Éº„Çø„Çπ
                      </th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Êìç‰Ωú
                      </th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {generatedReports.map((report) => (
                      <tr key={report.id} className="hover:bg-gray-50">
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="text-sm font-medium text-gray-900">{report.name}</div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                          {report.generatedAt}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          {getFormatBadge(report.format)}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                          {report.size}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          {getStatusBadge(report.status)}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                          {report.status === 'completed' && (
                            <button
                              onClick={() => handleDownload(report)}
                              className="text-blue-600 hover:text-blue-900 mr-3"
                            >
                              „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                            </button>
                          )}
                          <button 
                            onClick={() => handleDeleteReport(report.id)}
                            className="text-red-600 hover:text-red-900"
                          >
                            ÂâäÈô§
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}
        </div>
      )}

    </div>
  );
}
